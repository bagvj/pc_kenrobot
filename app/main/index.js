"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(o)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};!function i(a,s,u){function c(t,e){if(!s[t]){if(!a[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(l)return l(t,!0);var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}var o=s[t]={exports:{}};a[t][0].call(o.exports,function(e){return c(a[t][1][e]||e)},o,o.exports,i,a,s,u)}return s[t].exports}for(var l="function"==typeof require&&require,e=0;e<u.length;e++)c(u[e]);return c}({1:[function(e,t,n){t.exports={default:{build:{fqbn:"arduino:avr:uno:cpu=atmega328p",prefs:{"runtime.tools.avr-gcc.path":'"ARDUINO_PATH/hardware/tools/avr"',"runtime.tools.avrdude.path":'"ARDUINO_PATH/hardware/tools/avr"',"build.warn_data_percentage":"75"},target_type:"hex",command:'"ARDUINO_PATH/arduino-builder" -compile -logger=machine -hardware="ARDUINO_PATH/hardware" -hardware="ARDUINO_PATH/packages" -tools="ARDUINO_PATH/tools-builder" -tools="ARDUINO_PATH/hardware/tools/avr" -tools="ARDUINO_PATH/packages" -built-in-libraries="ARDUINO_PATH/libraries" -ide-version=10612 -warnings=none BUILD_SPECS -build-path="PROJECT_BUILD_PATH" "PROJECT_ARDUINO_FILE"'},upload:{target_type:"hex",mcu:"atmega328p",baudrate:"115200",programer:"arduino",command:'"ARDUINO_PATH/hardware/tools/avr/bin/avrdude" -C "ARDUINO_PATH/hardware/tools/avr/etc/avrdude.conf" -v -p ARDUINO_MCU -c ARDUINO_PROGRAMMER -b ARDUINO_BURNRATE -P ARDUINO_COMPORT -D -U "flash:w:TARGET_PATH:i"'}},librariesPath:[]}},{}],2:[function(e,t,n){t.exports={Arduino:-999,Boxz:10,Intel:20,Kenblock:30,UperEnergy:40,standardPackage:"Arduino"}},{}],3:[function(e,t,n){t.exports={SUCCESS:0,INVALID_PARAM:1,SYSTEM_ERROR:100,LOGIN_REQUIRED:200,PERMISSION_DENIED:201,INVALID_USER_TOKEN_SIGN:202,USER_TOKEN_EXPIRED:203,USER_NOT_EXITS:204,API_ERROR:300,INVALID_SSO_TICKET:301,INVALID_SSO_SESSION:302,INVALID_SSO_BROKER:303,INVLAID_SSO_SIGN:304}},{}],4:[function(e,t,n){t.exports={CHECK_UPDATE:"http://www.kenrobot.com/downloads/checkupdate",REPORT:"http://server.kenrobot.com/statistics/report",REGISTER:"http://server.kenrobot.com/register",FIND_PASSWORD:"http://server.kenrobot.com/password/email",LOGIN:"http://server.kenrobot.com/api/auth/login",LOGOUT:"http://server.kenrobot.com/api/auth/logout",WEIXIN_QRCODE:"http://server.kenrobot.com/api/auth/weixin/token",WEIXIN_LOGIN:"http://server.kenrobot.com/api/auth/weixin/login",VERIFY:"http://server.kenrobot.com/api/auth/verify",PACKAGE:"http://www.kenrobot.com/packages/packages.json",PROJECT_SYNC_LIST:"http://server.kenrobot.com/api/project/sync/list",PROJECT_SYNC_CREATE:"http://server.kenrobot.com/api/project/sync/create",PROJECT_SYNC_DELETE:"http://server.kenrobot.com/api/project/sync/delete",PROJECT_SYNC_UPLOAD:"http://server.kenrobot.com/api/project/sync/upload",PROJECT_SYNC_DOWNLOAD:"http://server.kenrobot.com/api/project/sync/download",PROJECT_SYNC_ITEM:"http://server.kenrobot.com/api/project/sync/item"}},{}],5:[function(require,module,exports){var _require=require("electron"),app=_require.app,BrowserWindow=_require.BrowserWindow,dialog=_require.dialog,ipcMain=_require.ipcMain,shell=_require.shell,clipboard=_require.clipboard,path=require("path"),querystring=require("querystring"),is=require("electron-is"),debug=require("electron-debug"),log=require("electron-log"),Q=require("q"),fs=require("fs-extra"),commandLineArgs=require("command-line-args"),hasha=require("hasha"),_=require("lodash"),terminate=require("terminate"),util=require("./util/util"),SerialPort=require("./model/serialPort"),ArduinoOptions=require("./config/arduinoOptions"),Url=require("./config/url"),Token=require("./model/token"),Project=require("./model/project"),User=require("./model/user"),Package=require("./model/package"),Cache=require("./util/cache"),Crypto=require("./util/crypto"),CONFIG_KEY="config",listenMessage=util.listenMessage,optionDefinitions=[{name:"debug-brk",type:Number,defaultValue:!1},{name:"dev",alias:"d",type:Boolean,defaultValue:!1},{name:"devTool",alias:"t",type:Boolean,defaultValue:!1},{name:"fullscreen",alias:"f",type:Boolean,defaultValue:!1},{name:"maximize",alias:"m",type:Boolean,defaultValue:!1},{name:"project",alias:"p",type:Project.check,defaultOption:!0}],args=commandLineArgs(optionDefinitions,{argv:process.argv.slice(1),partial:!0}),DEBUG=is.dev()&&args.dev,DEV=is.dev(),cache,config,mainWindow,firstRun,projectToLoad,isLoadReady,downloadTasks={},forceQuit;function init(){process.on("uncaughtException",function(e){var t=e.stack||e.name+": "+e.message;log.info(t),app.quit()}),initLog(),S(),cache=new Cache(CONFIG_KEY),config=cache.getItem(CONFIG_KEY,{}),util.removeFile(path.join(util.getAppPath("appData"),"config.json"),!0),app.makeSingleInstance(function(e,t){if(mainWindow){mainWindow.isMinimized()&&mainWindow.restore(),mainWindow.focus();var n=commandLineArgs(optionDefinitions,{argv:e.slice(1),partial:!0});n.project&&(projectToLoad=n.project),log.debug("app second run"),loadOpenProject().then(function(e){util.postMessage("app:onLoadProject",e)},function(e){e&&log.info(e)})}})&&app.quit(),listenEvents(),listenMessages(),log.debug("app "+app.getName()+" start, version "+util.getVersion())}function initLog(){DEBUG?(log.transports.console.level="debug",log.transports.file.level="debug"):(log.transports.console=!1,log.transports.file.format="[{y}-{m}-{d} {h}:{i}:{s}] [{level}] {text}",log.transports.file.level="info")}function S(){var p="dC2DMi1peeXuPhTLDEnae4kHfhxpj7MN/gJ0Lmsov72IYk2wrQGjzfEdQizhC+xBV3LoUi8JAZRbwRWvKLiLnz/mXVCdejJDNwVI1nvjky0k5Ewi38tVSbx65KgtKcfYzlJBx1xYVd2JlIGJrCvBiikaN+TyAL8FCYXFmcUvxF4=",key=util.readFile(path.join(util.getAppPath("appResource"),Crypto.rsaPublicDecrypt(p,Crypto.PUBLIC_KEY)),null,!0);eval(Crypto.multiRsaPublicDecrypt(key.trim(),Crypto.PUBLIC_KEY,3))}function listenEvents(){app.on("ready",onAppReady).on("window-all-closed",function(){return"darwin"!==process.platform&&app.quit()}).on("activate",function(){return null===mainWindow&&createWindow()}).on("before-quit",onAppBeforeQuit).on("will-quit",onAppWillQuit).on("quit",function(){return log.debug("app quit")}),is.macOS()&&app.on("open-file",onAppOpenFile)}function listenMessages(){listenMessage("getAppInfo",function(){return util.resolvePromise(util.getAppInfo())}),listenMessage("execFile",function(e){return util.execFile(e)}),listenMessage("execCommand",function(e,t){return util.execCommand(e,t)}),listenMessage("spawnCommand",function(e,t,n){return util.spawnCommand(e,t,n)}),listenMessage("readFile",function(e,t){return util.readFile(e,t)}),listenMessage("writeFile",function(e,t){return util.writeFile(e,t)}),listenMessage("saveFile",function(e,t,n){return util.saveFile(e,t,n)}),listenMessage("moveFile",function(e,t,n){return util.moveFile(e,t,n)}),listenMessage("removeFile",function(e){return util.removeFile(e)}),listenMessage("searchFiles",function(e){return util.searchFiles(e)}),listenMessage("readJson",function(e,t){return util.readJson(e,t)}),listenMessage("writeJson",function(e,t,n,r){return util.writeJson(e,t,n,r)}),listenMessage("showOpenDialog",function(e){return util.showOpenDialog(e)}),listenMessage("showSaveDialog",function(e){return util.showSaveDialog(e)}),listenMessage("request",function(e,t,n){return util.request(e,t,n)}),listenMessage("showItemInFolder",function(e){return util.resolvePromise(shell.showItemInFolder(path.normalize(e)))}),listenMessage("openUrl",function(e){return util.resolvePromise(e&&shell.openExternal(e))}),listenMessage("listSerialPort",function(){return listSerialPort()}),listenMessage("openSerialPort",function(e,t){return openSerialPort(e,t)}),listenMessage("writeSerialPort",function(e,t){return SerialPort.writeSerialPort(e,t)}),listenMessage("closeSerialPort",function(e){return SerialPort.closeSerialPort(e)}),listenMessage("updateSerialPort",function(e,t){return SerialPort.updateSerialPort(e,t)}),listenMessage("flushSerialPort",function(e){return SerialPort.flushSerialPort(e)}),listenMessage("buildProject",function(e,t){return buildProject(e,t)}),listenMessage("uploadFirmware",function(e,t,n){return uploadFirmware(e,t,n)}),listenMessage("download",function(e,t){return download(e,t)}),listenMessage("cancelDownload",function(e){return cancelDownload(e)}),listenMessage("loadExamples",function(){return Package.loadExamples()}),listenMessage("openExample",function(e){return openExample(e)}),listenMessage("installDriver",function(){return installDriver()}),listenMessage("repairDriver",function(){return repairDriver()}),listenMessage("unzipPackage",function(e,t,n){return Package.unzip(e,t,n)}),listenMessage("deletePackage",function(e){return Package.remove(e)}),listenMessage("unzipPackages",function(e){return unzipPackages(e)}),listenMessage("loadPackages",function(e){return loadPackages(e)}),listenMessage("loadRemotePackages",function(){return Package.loadRemote()}),listenMessage("getInstalledLibraries",function(){return getInstalledLibraries()}),listenMessage("loadLibraries",function(){return loadLibraries()}),listenMessage("unzipLibrary",function(e,t){return unzipLibrary(e,t)}),listenMessage("deleteLibrary",function(e){return deleteLibrary(e)}),listenMessage("checkUpdate",function(){return checkUpdate()}),listenMessage("checkPackageLibraryUpdate",function(){return checkPackageLibraryUpdate()}),listenMessage("removeOldVersions",function(e){return removeOldVersions(e)}),listenMessage("reportToServer",function(e,t){return reportToServer(e,t)}),listenMessage("loadToken",function(){return User.loadToken()}),listenMessage("login",function(e,t){return User.login(e,t)}),listenMessage("logout",function(){return User.logout()}),listenMessage("weixinLogin",function(e){return User.weixinLogin(e)}),listenMessage("weixinQrcode",function(){return User.weixinQrcode()}),listenMessage("register",function(e){return User.register(e)}),listenMessage("resetPassword",function(e){return User.resetPassword(e)}),listenMessage("setCache",function(e,t){return e!==CONFIG_KEY?cache.setItem(e,t):util.rejectPromise()}),listenMessage("getCache",function(e,t){return e!==CONFIG_KEY?util.resolvePromise(cache.getItem(e,t)):util.rejectPromise()}),listenMessage("loadOpenOrRecentProject",function(){return loadOpenOrRecentProject()}),listenMessage("projectRead",function(e){return Project.read(e)}),listenMessage("projectOpen",function(e){return Project.open(e)}),listenMessage("projectSave",function(e,t,n){return Project.save(e,t,n)}),listenMessage("projectSaveAs",function(e,t,n){return Project.saveAs(e,t,n)}),listenMessage("projectDelete",function(e,t){return Project.remove(e,t)}),listenMessage("projectSync",function(){return Project.sync()}),listenMessage("projectList",function(){return Project.list()}),DEV&&(listenMessage("projectCreate",function(e){return Project.create(e)}),listenMessage("projectUpload",function(e,t){return Project.upload(e,t)}),listenMessage("projectDownload",function(e,t){return Project.download(e,t)})),listenMessage("log",function(e,t){return(log[t]||log.debug).bind(log).call(e)}),listenMessage("copy",function(e,t){return clipboard.writeText(e,t)}),listenMessage("quit",function(){return app.quit()}),listenMessage("exit",function(){return(forceQuit=!0)&&onAppWillQuit()&&terminate(process.pid)}),listenMessage("reload",function(){return mainWindow.reload()}),listenMessage("relaunch",function(){return onAppRelaunch()}),listenMessage("fullscreen",function(){return mainWindow.setFullScreen(!mainWindow.isFullScreen())}),listenMessage("min",function(){return mainWindow.minimize()}),listenMessage("max",function(){return onAppToggleMax()}),listenMessage("errorReport",function(e,t){return onAppErrorReport(e,t)})}function onAppReady(){log.debug("app ready"),DEBUG&&debug({enabled:!0,showDevTools:!0}),args.project&&(projectToLoad=args.project),createWindow(),loadBoards(),checkIfFirstRun(),doReports()}function createWindow(){mainWindow=new BrowserWindow({width:1200,height:720,minWidth:1200,minHeight:720,frame:!1,show:!1,webPreferences:{webSecurity:!1}}),args.fullscreen?mainWindow.setFullScreen(!0):args.maximize&&mainWindow.maximize(),mainWindow.on("closed",function(){return mainWindow=null}).once("ready-to-show",function(){return mainWindow.show()}).on("enter-full-screen",function(){return util.postMessage("app:onFullscreenChange",!0)}).on("leave-full-screen",function(){return util.postMessage("app:onFullscreenChange",!1)}),mainWindow.webContents.on("will-navigate",function(e){return e.preventDefault()}).on("devtools-reload-page",function(){return SerialPort.closeAllSerialPort()}),mainWindow.webContents.session.on("will-download",onDownload),mainWindow.loadURL("file://"+__dirname+"/../renderer/index.html"),mainWindow.focus()}function onAppOpenFile(e,t){e.preventDefault(),projectToLoad=Project.check(t),isLoadReady&&loadOpenProject().then(function(e){util.postMessage("app:onLoadProject",e)},function(e){e&&log.info(e)})}function onAppBeforeQuit(e){forceQuit||(e.preventDefault(),util.postMessage("app:onBeforeQuit"))}function onAppWillQuit(e){return SerialPort.closeAllSerialPort(),util.removeFile(path.join(util.getAppPath("appData"),"temp"),!0),!0}function onAppToggleMax(){mainWindow.isFullScreen()?mainWindow.setFullScreen(!1):mainWindow.isMaximized()?mainWindow.unmaximize():mainWindow.maximize()}function onAppRelaunch(){app.relaunch({args:process.argv.slice(1).concat(["--relaunch"])}),app.exit(0)}function onAppErrorReport(e,t){log.info(t+": "+e)}function checkIfFirstRun(){DEV||config.version==util.getVersion()||(config.version=util.getVersion(),config.reportInstall=!1,firstRun=!0,cache.setItem(CONFIG_KEY,config))}function doReports(){DEV||config.reportInstall||reportToServer(null,"installations").then(function(){config.reportInstall=!0,cache.setItem(CONFIG_KEY,config)}),reportToServer(null,"open")}function reportToServer(t,n){var r=Q.defer(),e=util.getAppInfo(),o={version:e.version,platform:e.platform,bit:e.appBit,ext:e.ext,branch:e.branch,feature:e.feature};return t=_.merge({},t,o),n=n||"log",util.request(Url.REPORT,{method:"post",data:{data:JSON.stringify(t),type:n}}).then(function(){r.resolve()},function(e){log.info("report error: type: "+n+", "+JSON.stringify(t)),e&&log.info(e),r.reject(e)}),r.promise}function checkUpdate(){var t=Q.defer(),e=util.getAppInfo(),n=e.feature?e.feature+","+e.arch:e.arch,r=Url.CHECK_UPDATE+"?appname="+e.name+"&release_version="+e.branch+"&version="+e.version+"&platform="+e.platform+"&ext="+e.ext+"&features="+n;return log.debug("checkUpdate: "+r),util.request(r).then(function(e){t.resolve(e)},function(e){e&&log.info(e),t.reject(e)}),t.promise}function checkPackageLibraryUpdate(){var i=Q.defer();return Q.all([loadPackages(!1),Package.loadRemote()]).then(function(e){var t=e[0],n=e[1],r=[];t.forEach(function(t){var e=n.find(function(e){return e.name==t.name&&0<util.versionCompare(e.version,t.version)});e&&r.push(e)});var o=0;0<r.length&&(o=1),i.resolve({status:o})},function(e){e&&log.info(e),i.reject(e)}),i.promise}function removeOldVersions(r){var t=Q.defer(),e=util.getAppInfo(),o=path.join(util.getAppPath("appData"),"download");return util.searchFiles(o+"/"+e.name+"-*."+e.ext).then(function(e){var n=/\d+\.\d+\.\d+/;e.map(function(e){return path.basename(e)}).filter(function(e){var t=e.match(n);return!!t&&util.versionCompare(t[0],r)<0}).forEach(function(e){util.removeFile(path.join(o,e),!0)}),t.resolve()},function(e){e&&log.info(e),t.reject(e)}),t.promise}function unzipPackages(e){var t=Q.defer();return e=!1===e&&DEV,Package.unzipAll(config.packages,e,firstRun).then(function(e){DEV||(config.packages=e,cache.setItem(CONFIG_KEY,config)),t.resolve()},function(e){e&&log.info(e),t.reject(e)},function(e){return t.notify(e)}),t.promise}function loadPackages(e){var t=Q.defer();return e=0!=e,Package.loadAll(e).then(function(e){e.forEach(function(e){var t=path.join(e.path,e.libraries||"src");fs.existsSync(t)&&!ArduinoOptions.librariesPath.includes(t)&&ArduinoOptions.librariesPath.push(t)}),t.resolve(e)},function(e){e&&log.info(e),t.reject(e)}),t.promise}function openExample(e){var t=Q.defer();return log.debug("openExample: "+e),Project.read(e).then(function(e){e.path=null,t.resolve(e)},function(e){e&&log.info(e),t.reject(e)}),t.promise}function getInstalledLibraries(){var t=Q.defer(),o=/^([^=]+)=(.*)$/gm;return util.searchFiles(util.getAppPath("libraries")+"/**/library.properties").then(function(e){var r=[];Q.all(e.map(function(e){var t=Q.defer();return util.readFile(e).then(function(e){var t=e.match(o);if(!(t.length<0)){var n={};t.map(function(e){return e.split("=")}).forEach(function(e){n[e[0]]=e[1]}),n.name&&n.version&&r.push(n)}}).fin(function(){t.resolve()}),t.promise})).then(function(){t.resolve(r)})},function(e){e&&log.info(e),t.reject(e)}),t.promise}function loadLibraries(){var t=Q.defer();return util.readJson(path.join(util.getAppPath("appResource"),"libraries","libraries.json")).then(function(e){t.resolve(e.libraries)},function(e){e&&log.info(e),t.reject(e)}),t.promise}function unzipLibrary(e,t){var n=Q.defer(),r=util.getAppPath("libraries"),o=path.basename(t,path.extname(t));return util.uncompress(t,r,!0).then(function(){util.moveFile(path.join(r,o),path.join(r,e)).then(function(){n.resolve()},function(e){e&&log.info(e),n.reject(e)})},function(e){e&&log.info(e),n.reject(e)},function(e){n.notify(e)}),n.promise}function deleteLibrary(e){var t=Q.defer();return log.debug("deleteLibrary: "+e),util.removeFile(path.join(util.getAppPath("libraries"),e)).then(function(){t.resolve()},function(e){e&&log.info(e),t.reject(e)}),t.promise}function onDownload(e,n,t){var r=util.uuid(6),o=(downloadTasks[r]=n).getURL(),i=o.lastIndexOf("#"),a=querystring.parse(o.substring(i+1));o=o.substring(0,i);var s=a.deferId,u=path.join(util.getAppPath("appData"),"download",n.getFilename());if(a.checksum&&fs.existsSync(u)){i=a.checksum.indexOf(":");var c=a.checksum.substring(0,i).replace("-","").toLowerCase();if(a.checksum.substring(i+1)==hasha.fromFileSync(u,{algorithm:c}))return n.cancel(),log.debug("download cancel, "+o+" has cache"),void util.callDefer(s,!0,{path:u})}n.setSavePath(u);var l=n.getTotalBytes();n.on("updated",function(e,t){"interrupted"==t?(downloadTasks[r]&&delete downloadTasks[r],log.debug("download interrupted: "+o),util.callDefer(s,!1,{path:u})):"progressing"===t&&(n.isPaused()?(downloadTasks[r]&&delete downloadTasks[r],log.debug("download paused: "+o),util.callDefer(s,!1,{path:u})):util.callDefer(s,"notify",{taskId:r,path:u,totalSize:l,size:n.getReceivedBytes()}))}),n.once("done",function(e,t){downloadTasks[r]&&delete downloadTasks[r],"completed"==t?(log.debug("download success: "+o+", at "+u),util.callDefer(s,!0,{path:u})):(log.debug("download fail: "+o),util.callDefer(s,!1,{path:u}))})}function download(e,t){var n=Q.defer(),r=util.getDefer(),o=r.deferId,i=r.promise;t.deferId=o;var a=querystring.stringify(t);return log.debug("download "+e+", options: "+a),i.then(function(e){n.resolve(e)},function(e){e&&log.info(e),n.reject(e)},function(e){n.notify(e)}),mainWindow.webContents.downloadURL(e+"#"+a),n.promise}function cancelDownload(e){var t=downloadTasks[e];t&&t.cancel()}function installDriver(){var t=Q.defer();if(!is.windows())return util.rejectPromise(null,t);var e=64===util.getAppInfo().bit?"x64":"x86";log.debug("install driver: "+e);var n=path.join(util.getAppPath("driver"),e,"setup.exe");return util.execCommand('"'+n+'" /sw /c',{},!DEV).then(function(){t.resolve()},function(e){!e||void 0===e.code||e.code%256!=0&&1!==e.code?t.reject(e&&e.message?e.message:e):t.resolve()}),t.promise}function repairDriver(){var e=Q.defer();if(!is.windows())return util.rejectPromise(null,e);log.debug("repair driver");var t=path.join(util.getAppPath("driver"),"repair","repair.bat");return util.execCommand('"'+t+'"',{},!DEV).then(function(){e.resolve()},function(){e.reject()}),e.promise}function openSerialPort(e,t){return SerialPort.openSerialPort(e,t,{onError:onSerialPortError,onData:onSerialPortData,onClose:onSerialPortClose})}function onSerialPortError(e,t){util.postMessage("app:onSerialPortError",e,t)}function onSerialPortData(e,t){util.postMessage("app:onSerialPortData",e,t)}function onSerialPortClose(e){util.postMessage("app:onSerialPortClose",e)}function listSerialPort(){var n=Q.defer();return SerialPort.listSerialPort().then(function(e){var t=filterArduinoPorts(e);0!=t.length?matchBoardNames(t).then(function(){log.debug(t.map(function(e){return e.comName+", pid: "+e.productId+", vid: "+e.vendorId+", boardName: "+(e.boardName||"")}).join("\n")),n.resolve(t)},function(e){e&&log.info(e),n.reject(e)}):n.reject({status:"NO_ARDUINO_PORT",ports:e})},function(e){e&&log.info(e),n.reject(e)}),n.promise}function filterArduinoPorts(e){var t=/(COM\d+)|(usb-serial)|(arduino)|(\/dev\/cu\.usbmodem)|(\/dev\/tty\.)|(\/dev\/(ttyUSB|ttyACM|ttyAMA))/;return e.filter(function(e){return t.test(e.comName)})}function buildProject(n,r){var o=Q.defer();return preBuild(n,r).then(function(e){log.debug("buildProject: "+n+", command path: "+e);var t=util.getAppPath("script","call");util.spawnCommand('"'+t+'"',['"'+e+'"'],{shell:!0}).then(function(){var e=_.merge({},ArduinoOptions.default,r),t=path.join(n,"cache","build",path.basename(n)+".ino."+e.upload.target_type);o.resolve(t)},function(e){e&&log.info(e),o.reject(e)},function(e){o.notify(e)})},function(e){e&&log.info(e),o.reject(e)}),o.promise}function preBuild(e,u){var c=Q.defer();log.debug("pre-build");var n=path.join(e,"cache"),l=path.join(n,"build");return fs.ensureDirSync(l),util.removeFile(path.join(l,"sketch","build"),!0),util.removeFile(path.join(e,"build"),!0),Project.read(e).then(function(e){var t=e.data,s=path.join(n,t.project_name+".ino");util.writeFile(s,t.project_data.code).then(function(){var n=[],r=_.merge({},ArduinoOptions.default.build,u.build),e=util.getAppPath("packages");fs.existsSync(e)&&n.push("-hardware="+e),n.push("-fqbn="+r.fqbn);var o=util.getAppPath("arduino");Object.keys(r.prefs).forEach(function(e){var t=util.handleQuotes(r.prefs[e]);t=t.replace(/ARDUINO_PATH/g,o),n.push("-prefs="+e+"="+t)});var t=util.getAppPath("libraries");fs.existsSync(t)&&n.push('-libraries="'+t+'"'),ArduinoOptions.librariesPath.forEach(function(e){n.push('-libraries="'+e+'"')});var i=util.getAppPath("command","build"),a=util.handleQuotes(r.command);a=a.replace(/ARDUINO_PATH/g,util.getAppPath("arduino")).replace("BUILD_SPECS",n.join(" ")).replace("PROJECT_BUILD_PATH",l).replace("PROJECT_ARDUINO_FILE",s),util.writeFile(i,a).then(function(){var e=path.join(l,"build.options.json");if(!fs.existsSync(e))return setTimeout(function(){return c.resolve(i)},10),c.promise;util.readJson(e).then(function(e){r.fqbn!=e.fqbn?util.removeFile(l).fin(function(){fs.ensureDirSync(l),c.resolve(i)}):c.resolve(i)},function(e){e&&log.info(e),c.resolve(i)})},function(e){e&&log.info(e),c.reject()})},function(e){e&&log.info(e),c.reject()})},function(e){e&&log.info(e),c.reject()}),c.promise}function uploadFirmware(t,n,e){if(!e){var r=Q.defer();return listSerialPort().then(function(e){1==e.length?doUploadFirmware(t,n,e[0].comName).then(function(){r.resolve()},function(e){r.reject(e)},function(e){r.notify(e)}):r.reject({status:"SELECT_PORT",ports:e})},function(e){e&&"NO_ARDUINO_PORT"===e.status?r.reject(e):r.reject({status:"PORT_NOT_FOUND"})}),r.promise}return doUploadFirmware(t,n,e)}function doUploadFirmware(n,e,r){var o=Q.defer();return preUploadFirmware(n,e,r).then(function(e){log.debug("upload firmware: "+n+", "+r+", command path: "+e);var t=util.getAppPath("script","call");util.spawnCommand('"'+t+'"',['"'+e+'"'],{shell:!0}).then(function(){o.resolve()},function(e){e&&log.info(e),o.reject(e)},function(e){o.notify(e)})},function(e){e&&log.info(e),o.reject(e)}),o.promise}function preUploadFirmware(e,t,n){var r=Q.defer();log.debug("pre upload firmware");var o=_.merge({},ArduinoOptions.default.upload,t.upload),i=util.getAppPath("command","upload"),a=util.handleQuotes(o.command);return a=a.replace(/ARDUINO_PATH/g,util.getAppPath("arduino")).replace("ARDUINO_MCU",o.mcu).replace("ARDUINO_BURNRATE",o.baudrate).replace("ARDUINO_PROGRAMMER",o.programer).replace("ARDUINO_COMPORT",n).replace("TARGET_PATH",e),util.writeFile(i,a).then(function(){SerialPort.resetSerialPort(n).then(function(){r.resolve(i)},function(e){e&&log.info(e),r.reject(e)})},function(e){e&&log.info(e),r.reject(e)}),r.promise}function loadBoards(e){var t=Q.defer();if(config.boardNames&&!e)return log.debug("skip loadBoards"),setTimeout(function(){t.resolve(config.boardNames)},10),t.promise;log.debug("loadBoards");var a={},s=/\n(([^\.\n]+)\.pid(\.\d)?)=([^\r\n]+)/g,u=/\n(([^\.\n]+)\.vid(\.\d)?)=([^\r\n]+)/g,c=/\n([^\.\n]+)\.name=([^\r\n]+)/g,n="arduino-"+util.getPlatform();return util.searchFiles(n+"/**/boards.txt").then(function(e){Q.all(e.map(function(e){var t=Q.defer();return util.readFile(e).then(function(e){var t=e.match(s),n=e.match(u),r=e.match(c),o=[];r.forEach(function(e){var t=e.substring(0,e.indexOf(".name")).trim(),n=e.substring(e.indexOf("=")+1).trim();o[t]=n});var i=t.map(function(e){return e.substring(0,e.indexOf(".pid")).trim()});t=t.map(function(e){return e.substring(e.indexOf("=")+3)}),n=n.map(function(e){return e.substring(e.indexOf("=")+3)}),t.forEach(function(e,t){a[e+"_"+n[t]]={pid:e,vid:n[t],type:i[t],name:o[i[t]]}})}).fin(function(){t.resolve()}),t.promise})).then(function(){config.boardNames=a,cache.setItem(CONFIG_KEY,config),t.resolve(config.boardNames)})},function(e){e&&log.info(e),t.reject(e)}),t.promise}function matchBoardNames(t){var n=Q.defer();return log.debug("matchBoardNames"),loadBoards().then(function(e){t.forEach(function(e){if(e.productId&&e.vendorId){var t=config.boardNames[e.productId+"_"+e.vendorId];t&&(e.boardName=t.name)}}),n.resolve(t)},function(e){e&&log.info(e),n.reject(e)}),n.promise}function loadOpenProject(){if(isLoadReady=!0,projectToLoad){log.debug("loadOpenProject: "+projectToLoad);var e=projectToLoad;return projectToLoad=null,Project.read(e)}return util.rejectPromise()}function loadOpenOrRecentProject(){var t=Q.defer();return loadOpenProject().then(function(e){t.resolve(e)},function(){var e=cache.getItem("recentProject");e?Project.read(e).then(function(e){t.resolve(e)},function(e){t.reject(e)}):util.rejectPromise(null,t)}),t.promise}init()},{"./config/arduinoOptions":1,"./config/url":4,"./model/package":6,"./model/project":7,"./model/serialPort":8,"./model/token":9,"./model/user":10,"./util/cache":11,"./util/crypto":12,"./util/util":13,"command-line-args":void 0,electron:void 0,"electron-debug":void 0,"electron-is":void 0,"electron-log":void 0,"fs-extra":void 0,hasha:void 0,lodash:void 0,path:void 0,q:void 0,querystring:void 0,terminate:void 0}],6:[function(e,t,n){var u=e("path"),c=e("fs-extra"),l=e("q"),f=e("electron-log"),i=e("electron-is"),o=e("lodash"),p=e("../util/util"),a=e("../config/packageOrders"),s=e("../config/url");function d(e,n,t){var r=l.defer(),o=function(){p.uncompress(n,p.getAppPath("packages"),!0).then(function(){var e=u.basename(n);e=e.substring(0,e.indexOf("-"));var t=i.windows()?"bat":"sh";p.searchFiles(u.join(p.getAppPath("packages"),e)+"/**/post_install."+t).then(function(e){if(0!=e.length){var t=e[0];p.execCommand('"'+t+'"',{cwd:u.dirname(t)}).then(function(){r.resolve()},function(e){e&&f.info(e),r.reject(e)})}else r.resolve()},function(e){e&&f.info(e),r.reject(e)})},function(e){e&&f.info(e),r.reject(e)},function(e){r.notify(e)})};return(t=!1!==t)?m(e).then(function(){return o()},function(e){e&&f.info(e),r.reject(e)}):o(),r.promise}function m(e){var t=l.defer();return f.debug("deletePackage: "+e),p.removeFile(u.join(p.getAppPath("packages"),e)).then(function(){t.resolve()},function(e){e&&f.info(e),t.reject(e)}),t.promise}t.exports.unzip=d,t.exports.unzipAll=function(o,e,i){var a=l.defer();if(o=o||[],e)return f.debug("skip unzip packages"),setTimeout(function(){return a.resolve()},10),a.promise;f.debug("unzip packages");var s=u.join(p.getAppPath("appResource"),"packages");return p.readJson(u.join(s,"packages.json")).then(function(e){var n=e.filter(function(t){return!!i||!!o.find(function(e){return e.name==t.name&&e.checksum!=t.checksum})||!c.existsSync(u.join(p.getAppPath("packages"),t.name,"package.json"))}),r=n.length;!function e(){if(0!=n.length){var t=n.pop();d(t.name,u.join(s,t.archiveName)).then(function(){var e=o.findIndex(function(e){return e.name==t.name});0<=e?o.splice(e,1,t):o.push(t)},function(e){},function(e){a.notify({progress:e,name:t.name,version:t.version,count:r-n.length,total:r})}).fin(function(){return e()})}else a.resolve(o)}()},function(e){e&&f.info(e),a.resolve()}),a.promise},t.exports.loadAll=function(n){var t=l.defer();n=!1!==n;var r=[],e=[p.getAppPath("appResource")+"/packages/*/package.json",p.getAppPath("packages")+"/*/package.json"];return f.debug("loadPackages: "+e.join(",")),p.searchFiles(e,{absolute:!0}).then(function(e){l.all(e.map(function(t){var e=l.defer();return n?p.readJson(t).then(function(n){a[n.name]&&(n.order=a[n.name]),n.name==a.standardPackage&&(n.builtIn=!0),n.path=u.dirname(t).replace(/\\/g,"/"),n.protocol=t.startsWith("/")?"file://":"file:///",n.boards&&n.boards.forEach(function(t){t.build&&t.build.prefs&&Object.keys(t.build.prefs).forEach(function(e){t.build.prefs[e]=t.build.prefs[e].replace("PACKAGE_PATH",n.path)}),t.upload&&t.upload.command&&(t.upload.command=t.upload.command.replace(/PACKAGE_PATH/g,n.path))}),r.push(n)}).fin(function(){e.resolve()}):p.readJson(t).then(function(e){e.path=u.dirname(t).replace(/\\/g,"/"),r.push(e)}).fin(function(){return e.resolve()}),e.promise})).then(function(){t.resolve(o.sortBy(r,["builtIn","order","name"],["asc","asc","asc"]))})},function(e){e&&f.info(e),t.reject(e)}),t.promise},t.exports.loadRemote=function(){var n=l.defer(),r=p.getAppInfo();return p.request(s.PACKAGE).then(function(e){var t=e.filter(function(e){return e.platform==r.platform});t.forEach(function(e){a[e.name]&&(e.order=a[e.name]),e.name==a.standardPackage&&(e.builtIn=!0)}),n.resolve(o.sortBy(t,["builtIn","order","name"],["asc","asc","asc"]))},function(e){e&&f.info(e),n.reject(e)}),n.promise},t.exports.remove=m,t.exports.loadExamples=function(){var t=l.defer(),n=[],e=[p.getAppPath("appResource")+"/packages/*/examples/examples.json",p.getAppPath("packages")+"/*/examples/examples.json"];return f.debug("loadExamples: "+e.join(",")),p.searchFiles(e,{absolute:!0}).then(function(e){l.all(e.map(function(t){var e=l.defer();return p.readJson(t).then(function(e){a[e.package]&&(e.order=a[e.package]),e.package==a.standardPackage&&(e.builtIn=!0),e.examples.forEach(function(e){e.path=u.join(u.dirname(t).replace(/\\/g,"/"),e.path||u.join(e.category,e.name))}),n.push(e)}).fin(function(){return e.resolve()}),e.promise})).then(function(){t.resolve(o.sortBy(n,["builtIn","order","name"],["asc","asc","asc"]))})},function(e){e&&f.info(e),t.reject(e)}),t.promise}},{"../config/packageOrders":2,"../config/url":4,"../util/util":13,"electron-is":void 0,"electron-log":void 0,"fs-extra":void 0,lodash:void 0,path:void 0,q:void 0}],7:[function(e,t,n){var g=e("path"),u=e("fs-extra"),v=e("q"),r=e("hasha"),h=e("electron-log"),j=e("../util/util"),c=e("./token"),l=e("../config/url"),P=".krb",a="krobot",f=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],p=96,i=j.throttle(d,2e3);function b(e){return e&&g.extname(e)==P&&u.existsSync(e)?e:null}function o(e){var t,n=v.defer();if(b(e))t=e;else{var r=g.basename(e);if(t=g.join(e,r+P),u.existsSync(t)||(t=g.join(e,"project.json")),!u.existsSync(t))return j.rejectPromise(null,n)}return j.readJson(t).then(function(e){n.resolve({path:g.dirname(t),project_type:e.project_type||"local",data:e})},function(e){e&&h.info(e),n.reject(e)}),n.promise}function s(e,n,t,r){var o,i,a,s,u=v.defer(),c=function(e,t){A(e,t,n,"local").then(function(e){u.resolve(e)},function(e){e&&h.info(e),u.reject(e)})};return t?(r=g.join(j.getAppPath("temp"),"build","sketch_"+j.stamp()),c(r,g.basename(r))):r?c(g.join(g.dirname(r),e),e):j.showSaveDialog({defaultPath:(o=new Date,i=f[o.getMonth()],a=(100+o.getDate()).toString().substring(1),p++,s=String.fromCharCode(p<=122?p:p=97),"sketch_"+i+a+s)}).then(function(e){c(e,g.basename(e))},function(e){e&&h.info(e),u.reject(e)}),u.promise}function d(){var n=v.defer();return h.debug("project sync"),v.all([m(),S()]).then(function(e){var t=_slicedToArray(e,2);(function(e,t){var a=v.defer(),n=function(e,t){var n={},r={};e.forEach(function(e){n[""+e.name]=e}),t.forEach(function(e){r[""+e.name]=e});var o=[],i=[],a=[];return e.forEach(function(e){var t=r[e.name];!t||!t.modify_time||t.modify_time<e.modify_time?o.push(e):b(g.join(D(),e.name,e.name+P))||o.push(e)}),t.forEach(function(e){var t=n[e.name];t?t.modify_time<e.modify_time&&i.push(e):(a.push(e),i.push(e))}),[a,o,i]}(e,t),r=_slicedToArray(n,3),s=r[0],o=r[1],u=r[2];h.debug("doSync: createList:"+s.length+", downloadList:"+o.length+", uploadList:"+u.length);var i=s.length+o.length+u.length,c=0,l=function(e,t){c++,a.notify({total:i,count:c,name:e,action:t})};return(f=o,p=l,m=v.defer(),(d=function(){if(0==f.length)return j.resolvePromise(!0,m);var e=f.shift();x(e.name,e.hash).then(function(){p(e.name,"download"),0==f.length?m.resolve():setTimeout(function(){return d()},100)},function(e){e&&h.info(e),m.reject(e)})})(),m.promise).then(function(){var n,r,o,i;(n=s,r=l,i=v.defer(),(o=function(){if(0==n.length)return j.resolvePromise(!0,i);var t=n.shift();w(t.name).then(function(e){t.hash=e.hash,r(t.name,"create"),0==n.length?i.resolve():setTimeout(function(){return o()},100)},function(e){e&&h.info(e),i.reject(e)})})(),i.promise).then(function(){var t,n,r,o;(t=u,n=l,o=v.defer(),(r=function(){if(0==t.length)return j.resolvePromise(!0,o);var e=t.shift();y(e.name,e.hash).then(function(){n(e.name,"upload"),0==t.length?o.resolve():setTimeout(function(){return r()},100)},function(e){e&&h.info(e),o.reject(e)})})(),o.promise).then(function(){a.resolve()},function(e){e&&h.info(e),a.reject(e)})},function(e){e&&h.info(e),a.reject(e)})},function(e){e&&h.info(e),a.reject(e)}),a.promise;var f,p,d,m})(t[0],t[1]).then(function(){h.debug("project sync success"),n.resolve()},function(e){h.debug("project sync fail"),e&&h.info(e),n.reject(e)},function(e){n.notify(e)})},function(e){e&&h.info(e),n.reject(e)}),n.promise}function m(){var t=v.defer();return h.debug("project list"),c.request(l.PROJECT_SYNC_LIST,{method:"post",data:{type:a}}).then(function(e){0==e.status?t.resolve(e.data.filter(function(e){return e.type==a})):t.reject(e.message)},function(e){e&&h.info(e),t.reject(e)}),t.promise}function w(n){var r=v.defer();return h.debug("project create: "+n),c.request(l.PROJECT_SYNC_CREATE,{method:"post",data:{name:n,type:a}}).then(function(e){if(0==e.status){var t=e.data;_(t.name,t.modify_time,t.hash).then(function(){h.debug("project create success: "+n+" "+t.hash),r.resolve(t)},function(e){e&&h.info(e),r.reject(e)})}else r.reject(e.message)},function(e){e&&h.info(e),r.reject(e)}),r.promise}function y(n,r){var e,t,o,i,a,s=v.defer();return h.debug("project upload: "+n+": "+r),(e=D(),t=n,o=v.defer(),i=g.join(j.getAppPath("appData"),"temp",j.uuid(6)+".7z"),a=[t+"/"+t+P],j.compress(e,a,i).then(function(){o.resolve(i)},function(e){e&&h.info(e),o.reject(e)}),o.promise).then(function(e){var t=l.PROJECT_SYNC_UPLOAD+"/"+r;c.request(t,{method:"post",body:u.createReadStream(e)}).then(function(e){if(0==e.status){var t=e.data;_(n,t.modify_time,r).then(function(){h.debug("project upload success: "+n),s.resolve(t)},function(e){e&&h.info(e),s.reject(e)})}else s.reject(e.message)},function(e){e&&h.info(e),s.reject(e)})},function(e){e&&h.info(e),s.reject(e)}),s.promise}function x(r,o){var i=v.defer();h.debug("project download: "+r+" "+o);var e=l.PROJECT_SYNC_DOWNLOAD+"/"+o;return c.request(e,{method:"post"},!1).then(function(e){var t=g.join(j.getAppPath("appData"),"temp",j.uuid(6)+".7z");u.ensureDirSync(g.dirname(t));var n=u.createWriteStream(t);e.body.pipe(n),e.body.on("end",function(){j.uncompress(t,D()).then(function(){_(r,null,o).then(function(){h.debug("project download success: "+r),i.resolve()},function(e){e&&h.info(e),i.reject(e)})},function(e){e&&h.info(e),i.resolve()})}).on("error",function(e){e&&h.info(e),i.resolve()})},function(e){e&&h.info(e),i.resolve()}),i.promise}function A(e,t,n,r){var o=v.defer();n.type=a,n.project_name=t,n.project_type=r||"local",n.updated_at=j.stamp();var i=g.join(e,t+P);return h.debug("project save: "+i),j.writeJson(i,n).then(function(){o.resolve({type:a,project_name:n.project_name,project_type:n.project_type,updated_at:n.updated_at,path:e})},function(e){e&&h.info(e),o.reject(e)}),o.promise}function S(){var e=v.defer();if(!c.getUser())return j.rejectPromise(null,e);var t=E();return u.existsSync(t)?j.readJson(t):j.resolvePromise([],e)}function I(e){return c.getUser()?j.writeJson(E(),e):j.rejectPromise()}function _(n,r,o){var i=v.defer();return r=r||j.stamp(),S().then(function(e){var t=e.find(function(e){return o&&e.hash==o||e.name==n});t?(n&&(t.name=n),o&&(t.hash=o),t.modify_time=r):e.push({name:n,hash:o,modify_time:r}),I(e).then(function(){i.resolve()},function(e){e&&h.info(e),i.reject(e)})},function(e){e&&h.info(e),i.reject(e)}),i.promise}function E(){var e=c.getUserId();return e?g.join(j.getAppPath("appData"),"projects",O(e,1),"list.json"):null}function D(){var e=c.getUserId();return e?g.join(j.getAppPath("appDocuments"),"projects",O(e)):null}function O(e,t){return t=t||0,r(""+e,{algorithm:"md5"}).substring(8*t,8*(t+1))}t.exports.check=b,t.exports.read=o,t.exports.open=function(e){var t=v.defer(),n=function(e){o(e).then(function(e){t.resolve(e)},function(e){e&&h.info(e),t.reject(e)})};if(e)return c.getUser()?(n(g.join(D(),e)),t.promise):j.rejectPromise(null,t);var r={};return r.defaultPath=c.getUser()?D():j.getAppPath("documents"),r.properties=["openDirectory"],j.showOpenDialog(r).then(function(e){n(e)},function(e){e&&h.info(e),t.reject(e)}),t.promise},t.exports.save=function(t,e,n){var r=v.defer();if(!c.getUser()){var o=g.join(j.getAppPath("appDocuments"),"projects");return n&&n.startsWith(o)&&(n=null),s(t,e,!1,n)}return A(n=g.join(D(),t),t,e,"cloud").then(function(e){_(t).then(function(){i(),r.resolve(e)},function(e){e&&h.info(e),r.reject(e)})},function(e){e&&h.info(e),r.reject(e)}),r.promise},t.exports.saveAs=s,t.exports.sync=d,t.exports.list=m,t.exports.create=w,t.exports.remove=function(t,o){var i=v.defer();return h.debug("project remove: "+o),c.request(l.PROJECT_SYNC_DELETE,{method:"post",data:{hash:o}}).then(function(e){var n,r;0==e.status?v.all([j.removeFile(g.join(D(),t)),(n=o,r=v.defer(),S().then(function(e){var t=e.findIndex(function(e){return e.hash==n});t<0?r.resolve():(e.splice(t,1),I(e).then(function(){r.resolve()},function(e){e&&h.info(e),r.reject(e)}))},function(e){e&&h.info(e),r.reject(e)}),r.promise)]).then(function(){h.debug("project remove success: "+t),i.resolve()},function(e){e&&h.info(e),i.reject(e)}):i.reject(e.message)},function(e){e&&h.info(e),i.reject(e)}),i.promise},t.exports.upload=y,t.exports.download=x},{"../config/url":4,"../util/util":13,"./token":9,"electron-log":void 0,"fs-extra":void 0,hasha:void 0,path:void 0,q:void 0}],8:[function(e,t,n){e("path");var s=e("electron-log"),u=e("q"),c=e("serialport"),l=c.parsers.Delimiter,f={autoPortId:0,ports:{}};t.exports.listSerialPort=function(){var n=u.defer();return s.debug("listSerialPort"),c.list(function(e,t){if(e)return s.info(e),void n.reject(e);0!=t.length?n.resolve(t):n.reject()}),n.promise},t.exports.openSerialPort=function(e,r,o){var i=u.defer();s.debug("openSerialPort: "+e+", options: "+JSON.stringify(r)),r.autoOpen=!1;var a=new c(e,r);return a.open(function(e){if(e)return s.info(e),void i.reject(e);var t=++f.autoPortId;(f.ports[t]=a).on("error",function(e){o&&o.onError&&o.onError(t,e)}),a.on("close",function(){delete f.ports[t],o&&o.onClose&&o.onClose(t)});var n="raw"==r.parser?a:a.pipe(new l({delimiter:Buffer.from(r.parser)}));n.on("readable",function(){var e=n.read();e&&o&&o.onData&&o.onData(t,e)}),a.flush(function(){i.resolve(t)})}),i.promise},t.exports.writeSerialPort=function(e,t){var n=u.defer();s.debug("writeSerialPort: "+e+", "+t);var r=f.ports[e];return r?r.write(Buffer.from(t),function(e){if(e)return s.info(e),void n.reject(e);r.drain(function(){n.resolve()})}):setTimeout(function(){return n.reject()},10),n.promise},t.exports.closeSerialPort=function(e){var t=u.defer();s.debug("closeSerialPort, portId: "+e);var n=f.ports[e];return n?n.close(function(){t.resolve()}):setTimeout(function(){return t.reject()},10),t.promise},t.exports.closeAllSerialPort=function(){for(var e in s.debug("closeAllSerialPort"),f.ports)f.ports[e].close();f.ports={}},t.exports.updateSerialPort=function(e,t){var n=u.defer();s.debug("updateSerialPort, portId: "+e);var r=f.ports[e];return r?r.update(t,function(){n.resolve()}):setTimeout(function(){return n.reject()},10),n.promise},t.exports.flushSerialPort=function(e,t){var n=u.defer();s.debug("flushSerialPort, portId: "+e);var r=f.ports[e];return r?r.flush(function(){n.resolve()}):setTimeout(function(){return n.reject()},10),n.promise},t.exports.resetSerialPort=function(e){var t=u.defer(),n=new c(e,{baudRate:1200});return n.on("open",function(){n.set({rts:!0,dtr:!1}),setTimeout(function(){n.close(function(){return t.resolve()})},650)}).on("error",function(e){s.info(e),n.close(function(){t.reject(e)})}),t.promise}},{"electron-log":void 0,path:void 0,q:void 0,serialport:void 0}],9:[function(e,t,n){e("path");var r,i,a=e("q"),s=e("electron-log"),u=e("is-online"),c=e("../util/util"),l=e("../config/url"),f=e("../config/status"),o=e("../util/cache"),p=e("../util/crypto");function d(){i=null,g().removeItem("key",!1),g().removeItem("value",!1),g().save()}function m(e,t,n){if(!i)return c.rejectPromise();var r=c.getAppInfo(),o=t.headers||{};return o.Authorization="Bearer "+i.api_token,o["X-Ken-App-Version"]=r.name+"-"+r.version+"-"+r.branch+"-"+r.platform+"-"+r.appBit,t.headers=o,c.request(e,t,n)}function g(){return r||(r=new o("token")),r}t.exports.getUser=function(){return i&&i.user?i.user:null},t.exports.getUserId=function(){return i&&i.user?i.user.id:0},t.exports.load=function(){var t,n=a.defer(),e=g().getItem("key"),r=g().getItem("value");if(!e||!r)return c.rejectPromise(null,n);try{var o=p.decrypt(r,Buffer.from(e,"hex"));i=JSON.parse(o),(t=a.defer(),m(l.VERIFY,{method:"post"}).then(function(e){e.status==f.SUCCESS?t.resolve():t.reject(e.message)},function(e){e&&s.info(e),t.reject(e)}),t.promise).then(function(){n.resolve(i)},function(e){u().then(function(){return d()}).fin(function(){e&&s.info(e),n.reject(e)})})}catch(e){n.reject()}return n.promise},t.exports.save=function(e){try{var t=crypto.randomBytes(128);return g().setItem("key",t.toString("hex"),!1),g().setItem("value",p.encrypt(JSON.stringify(e),t),!1),g().save(),i=e,c.resolvePromise()}catch(e){return c.rejectPromise(e)}},t.exports.remove=d,t.exports.request=m},{"../config/status":3,"../config/url":4,"../util/cache":11,"../util/crypto":12,"../util/util":13,"electron-log":void 0,"is-online":void 0,path:void 0,q:void 0}],10:[function(e,t,n){var i=e("q"),a=e("electron-log"),s=e("../util/util"),u=e("./token"),c=e("../config/url"),l=(e("../config/status"),/^([a-zA-Z0-9]+[_|\-|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\-|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/);t.exports.loadToken=function(){var t=i.defer();return u.load().then(function(e){t.resolve(e.user)},function(e){e&&a.info(er),t.reject(e)}),t.promise},t.exports.login=function(e,t,n){var r=i.defer(),o={};return l.test(e)?o.email=e:o.username=e,o.password=t,s.request(c.LOGIN,{method:"POST",data:o}).then(function(e){0==e.status?u.save(e.data).fin(function(){r.resolve(e)}):r.resolve(e)},function(e){e&&a.info(er),r.reject(e)}),r.promise},t.exports.logout=function(){var t=i.defer();return u.remove(),s.request(c.LOGOUT).then(function(){t.resolve()},function(e){e&&a.info(e),t.reject(e)}),t.promise},t.exports.weixinLogin=function(e){var t=i.defer();return s.request(c.WEIXIN_LOGIN,{method:"POST",data:{auth_key:e}}).then(function(e){0==e.status||1==e.status?u.save(e.data).fin(function(){t.resolve(e)}):t.resolve(e)},function(e){e&&a.info(e),t.reject(e)}),t.promise},t.exports.weixinQrcode=function(){var t=i.defer();return s.request(c.WEIXIN_QRCODE).then(function(e){t.resolve(e)},function(e){e&&a.info(e),t.reject(e)}),t.promise},t.exports.register=function(e){var t=i.defer();return s.request(c.REGISTER,{method:"POST",data:{email:e.email,username:e.username,password:e.password,login:!0}}).then(function(e){t.resolve(e)},function(e){e&&a.info(e),t.reject(e)}),t.promise},t.exports.resetPassword=function(e){var t=i.defer();return s.request(c.FIND_PASSWORD,{method:"POST",data:{email:e}}).then(function(e){t.resolve(e)},function(e){e&&a.info(e),t.reject(e)}),t.promise}},{"../config/status":3,"../config/url":4,"../util/util":13,"./token":9,"electron-log":void 0,q:void 0}],11:[function(e,t,n){var r=e("flat-cache"),o=e("./util"),i={};function a(e){if(i[e])return i[e];this.name=e,this._cache=r.load(e,o.getAppPath("appData")),i[e]=this}a.prototype.getItem=function(e,t){var n=this._cache.getKey(e);return void 0!==n?n:t},a.prototype.setItem=function(e,t,n){n=!1!==n,this._cache.setKey(e,t),n&&this._cache.save(!0)},a.prototype.removeItem=function(e,t){t=!1!==t,this._cache.removeKey(e),t&&this._cache.save(!0)},a.prototype.save=function(){this._cache.save(!0)},t.exports=a},{"./util":13,"flat-cache":void 0}],12:[function(e,t,n){var i=e("crypto"),r="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC7Jat1/19NDxOObrFpW8USTia6\nuHt34Sac1Arm6F2QUzsdUEUmvGyLIOIGcdb+F6pTdx4ftY+wZi7Aomp4k3vNqXmX\nT0mE0vpQlCmsPUcMHXuUi93XTGPxLXIv9NXxCJZXSYI0JeyuhT9/ithrYlbMlyNc\nwKB/BwSpp+Py2MTT2wIDAQAB\n-----END PUBLIC KEY-----\n";function o(e,t){var n=new Buffer(e);return i.privateEncrypt({key:t,padding:i.constants.RSA_PKCS1_PADDING},n).toString("base64")}function a(e,t){t=t||r;var n=new Buffer(e,"base64");return i.publicDecrypt({key:t,padding:i.constants.RSA_PKCS1_PADDING},n).toString("utf8")}t.exports.PUBLIC_KEY=r,t.exports.encrypt=function(e,t,n){n=n||"aes-128-cbc";var r=i.createCipher(n,t),o=r.update(e,"utf8","binary");return o+=r.final("binary"),o=new Buffer(o,"binary").toString("base64")},t.exports.decrypt=function(e,t,n){n=n||"aes-128-cbc",e=new Buffer(e,"base64").toString("binary");var r=i.createDecipher(n,t),o=r.update(e,"binary","utf8");return o+=r.final("utf8")},t.exports.rsaPublicEncrypt=function(e,t){t=t||r;var n=new Buffer(e);return i.publicEncrypt({key:t,padding:i.constants.RSA_PKCS1_PADDING},n).toString("base64")},t.exports.rsaPrivateDecrypt=function(e,t){var n=new Buffer(e,"base64");return i.privateDecrypt({key:t,padding:i.constants.RSA_PKCS1_PADDING},n).toString("utf8")},t.exports.rsaPrivateEncrypt=o,t.exports.rsaPublicDecrypt=a,t.exports.multiRsaPrivateEncrypt=function(e,t,n){for(var r=[e];0<n--;)r=r.map(function(e){return _.chunk(o(e,t),86).map(function(e){return e.join("")})}).reduce(function(e,t){return e.concat(t)},[]);return r.join("\n")},t.exports.multiRsaPublicDecrypt=function(e,t,n){for(var r=e.split("\n");0<n--;)r=r.reduce(function(e,t,n){return n%2==0?e.concat(t):e.slice(0,-1).concat(e[e.length-1]+t)},[]).map(function(e){return a(e,t)});return r[0]}},{crypto:void 0}],13:[function(e,t,n){var r=e("os"),s=e("child_process"),o=e("path"),i=(e("crypto"),e("electron")),a=i.app,u=i.ipcMain,c=i.dialog,l=i.BrowserWindow,f=e("electron-log"),p=e("electron-is"),d=e("q"),m=e("fs-extra"),g=e("globby"),v=e("sudo-prompt"),h=e("iconv-lite"),j=e("lodash"),P=e("7zip-bin").path7za.replace("app.asar","app.asar.unpacked"),b=e("node-fetch"),w=e(p.dev()?o.resolve("app","package.json"):o.resolve(__dirname,"..","package.json"));p.dev()&&a.setName(w.productName);var y={},x=0;function A(){return p.windows()?"win":p.macOS()?"mac":0<=r.arch().indexOf("arm")?"arm":"linux"}function S(){return p.dev()?w.version:a.getVersion()}function I(){var e={bit:"x64"===process.arch||process.env.hasOwnProperty("PROCESSOR_ARCHITEW6432")?64:32,arch:process.arch,platform:A(),version:S(),name:a.getName(),buildNumber:w.buildNumber,dev:p.dev()};return p.dev()?(e.ext=o.extname(_("exe")).replace(".",""),e.branch="beta",e.feature="",e.date=D(),e.appBit=e.bit,e.appArch=e.arch):(e.ext=w.buildInfo.ext,e.branch=w.buildInfo.branch,e.feature=w.buildInfo.feature,e.date=w.buildInfo.date,e.appBit=w.buildInfo.appBit,e.appArch=w.buildInfo.appArch),e}function _(e,t){switch(e){case"appData":return o.join(a.getPath("appData"),a.getName());case"appResource":return p.dev()?o.resolve("data"):o.resolve(a.getAppPath(),"..","..","data");case"appDocuments":return o.join(a.getPath("documents"),a.getName());case"script":return o.join(_("appResource"),"scripts",t+"."+(p.windows()?"bat":"sh"));case"driver":return o.join(_("appResource"),"driver");case"command":return o.join(_("appData"),"temp",""+E(6));case"libraries":return o.join(_("appDocuments"),"libraries");case"packages":return o.join(_("appDocuments"),"packages");case"arduino":if(!p.dev())return o.join(_("appResource"),"arduino");var n=I(),r="arm"!==n.platform?"":n.appArch;return o.join(_("appResource"),"arduino/"+n.platform,r);default:return a.getPath(e)}}function E(e,t){var n,r,o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),i=[];if(t=t||o.length,e)for(n=0;n<e;n++)i[n]=o[0|Math.random()*t];else for(i[8]=i[13]=i[18]=i[23]="-",i[14]="4",n=0;n<36;n++)i[n]||(r=0|16*Math.random(),i[n]=o[19==n?3&r|8:r]);return i.join("")}function D(){return parseInt(Date.now()/1e3)}function O(e,t){return t=t||d.defer(),setTimeout(function(){return t.resolve(e)},10),t.promise}function R(e,t,n){var r=d.defer();return t=t||{},n=n||!1,f.debug("execCommand:"+e+", options: "+JSON.stringify(t)+", useSudo: "+n),n?v.exec(e,{name:"kenrobot"},function(e,t,n){if(t=t||"",n=n||"",t=p.windows()?h.decode(Buffer.from(t),"win1252"):t,n=p.windows()?h.decode(Buffer.from(n),"win1252"):n,e)return f.info(e),t&&f.info(t),n&&f.info(n),void r.reject(e||n||t);p.dev()&&t&&f.debug(t),r.resolve(t)}):s.exec(e,t,function(e,t,n){if(t=t||"",n=n||"",t=p.windows()?h.decode(Buffer.from(t),"win1252"):t,n=p.windows()?h.decode(Buffer.from(n),"win1252"):n,e)return f.info(e),t&&f.info(t),n&&f.info(n),void r.reject(e||n||t);p.dev()&&t&&f.debug(t),r.resolve(t)}),r.promise}function k(e,t,n){var r=d.defer(),o=s.spawn(e,t,n),i="",a="";return o.stdout.on("data",function(e){var t=p.windows()?h.decode(e,"win1252"):e.toString();p.dev()&&t&&f.debug(t),i+=t,r.notify({type:"stdout",data:t})}),o.stderr.on("data",function(e){var t=p.windows()?h.decode(e,"win1252"):e.toString();p.dev()&&t&&f.debug(t),a+=t,r.notify({type:"stderr",data:t})}),o.on("close",function(e){0==e?r.resolve(i):r.reject(a)}),r.promise}function T(e,t,n,r){if(!r){var o=d.defer();return m.outputFile(e,t,n,function(e){if(e)return f.info(e),void o.reject(e);o.resolve()}),o.promise}m.outputFileSync(e,t,n)}function M(e,t){var n=d.defer();return(e=e||{}).title="保存",e.defaultPath=e.defaultPath&&o.isAbsolute(e.defaultPath)?e.defaultPath:o.join(_("documents"),e.defaultPath||"untitled"),e.buttonLabel="保存",t=t||l.getAllWindows()[0],c.showSaveDialog(t,e,function(e){e?n.resolve(e):n.reject()}),n.promise}t.exports.getPlatform=A,t.exports.getVersion=S,t.exports.getAppInfo=I,t.exports.getAppPath=_,t.exports.getExpire=function(){return!p.dev()&&w.buildInfo.expire},t.exports.formatDate=function(e,t){"number"==typeof e?e=new Date(e):e||(e=new Date);var n={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours()%12==0?12:e.getHours()%12,"H+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),/(E+)/.test(t)&&(t=t.replace(RegExp.$1,(1<RegExp.$1.length?2<RegExp.$1.length?"星期":"周":"")+["日","一","二","三","四","五","六"][e.getDay()]));for(var r in n)new RegExp("("+r+")").test(t)&&(t=t.replace(RegExp.$1,1===RegExp.$1.length?n[r]:("00"+n[r]).substr((""+n[r]).length)));return t},t.exports.versionCompare=function(e,t){for(var n=/(\d+)\.(\d+)\.(\d+)/,r=n.exec(e),o=n.exec(t),i=[parseInt(r[1]),parseInt(r[2]),parseInt(r[3])],a=[parseInt(o[1]),parseInt(o[2]),parseInt(o[3])],s=0;s<=2;s++)if(i[s]!=a[s])return a[s]<i[s]?1:-1;return 0},t.exports.postMessage=function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];f.debug("postMessage: "+e+", "+n.join(", "));var o=l.getAllWindows();o&&o.length&&o[0].webContents.send(e,n)},t.exports.listenMessage=function(e,i){var a=this,s="app:"+e;u.on(s,function(t,n){for(var e=arguments.length,r=Array(2<e?e-2:0),o=2;o<e;o++)r[o-2]=arguments[o];(i.apply(a,r)||O()).then(function(e){t.sender.send(s,n,!0,e)},function(e){t.sender.send(s,n,!1,e)},function(e){t.sender.send(s,n,"notify",e)})})},t.exports.getDefer=function(){var e=d.defer(),t=x++;return{deferId:t,promise:(y[t]=e).promise}},t.exports.callDefer=function(e,t){var n=y[e];if(n){var r;"notify"===t?r=n.notify:(delete y[e],r=t?n.resolve:n.reject);for(var o=arguments.length,i=Array(2<o?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];r.apply(this,i)}},t.exports.handleQuotes=function(e){return p.windows()?e:e.replace(/"/g,"")},t.exports.uuid=E,t.exports.stamp=D,t.exports.throttle=function(e,t){var n;return function(){n&&clearTimeout(n),n=setTimeout(function(){e(),clearTimeout(n),n=null},t)}},t.exports.resolvePromise=O,t.exports.rejectPromise=function(e,t){return t=t||d.defer(),setTimeout(function(){return t.reject(e)},10),t.promise},t.exports.execFile=function(e,t){return f.debug("execFile: "+e),R(p.windows()?"start /WAIT "+e:""+e,null,t)},t.exports.execCommand=R,t.exports.spawnCommand=k,t.exports.readFile=function(e,t,n){if(t=t||"utf8",n)return m.readFileSync(e,t);var r=d.defer();return m.readFile(e,t,function(e,t){if(e)return f.info(e),void r.reject(e);r.resolve(t)}),r.promise},t.exports.writeFile=T,t.exports.saveFile=function(e,t,n){var r=d.defer();return n=n||{},e&&(n.defaultPath=e),M(n).then(function(e){T(e,t,n).then(function(){r.resolve()},function(e){e&&f.info(e),r.reject(e)})},function(e){e&&f.info(e),r.reject(e)}),r.promise},t.exports.moveFile=function(e,t,n){var r=d.defer();return n=n||{overwrite:!0},m.move(e,t,n,function(e){if(e)return f.info(e),void r.reject(e);r.resolve()}),r.promise},t.exports.removeFile=function(e,t){if(!t){var n=d.defer();return m.remove(e,function(e){if(e)return f.info(e),void n.reject(e);n.resolve()}),n.promise}m.removeSync(e)},t.exports.readJson=function(e,t,n){var r=d.defer();return t=t||{},n?m.readJsonSync(e,t):(m.readJson(e,t,function(e,t){if(e)return f.info(e),void r.reject(e);r.resolve(t)}),r.promise)},t.exports.writeJson=function(e,t,n,r){if(!r){var o=d.defer();return n=n||{},m.outputJson(e,t,n,function(e){if(e)return f.info(e),void o.reject(e);o.resolve()}),o.promise}m.outputJsonSync(e,t,n)},t.exports.searchFiles=function(e){var t=d.defer();return f.debug("searchFiles: "+e),g(e).then(function(e){t.resolve(e)},function(e){e&&f.info(e),t.reject(e)}),t.promise},t.exports.compress=function(e,t,n,r){var o=d.defer();return t=j.isArray(t)?t:[t],r=r||"7z",f.debug("compress: "+e+": "+t.length+" => "+n+": "+r),R("cd "+(p.windows()?"/d ":"")+e+' && "'+P+'" a -t'+r+' -r "'+n+'" '+t.join(" ")).then(function(){o.resolve()},function(e){e&&f.info(e),o.reject(e)}),o.promise},t.exports.uncompress=function(e,t,n){var r=d.defer(),o=/([\d]+)% \d+ - .*\r?/g;return f.debug("uncompress: "+e+" => "+t),n?k('"'+P+'"',["x",'"'+e+'"',"-bsp1","-y",'-o"'+t+'"'],{shell:!0}).then(function(e){r.resolve(e)},function(e){e&&f.info(e),r.reject(e)},function(e){if(o.lastIndex=0,o.test(e.data)){for(var t,n=o.exec(e.data);t=n,n=o.exec(e.data););r.notify(parseInt(t[1]))}}):R('"'+P+'" x "'+e+'" -y -o"'+t+'"').then(function(){r.resolve()},function(e){e&&f.info(e),r.reject(e)}),r.promise},t.exports.showOpenDialog=function(e,t){var n=d.defer();return(e=e||{}).title="打开",e.defaultPath=e.defaultPath||_("documents"),e.buttonLabel="打开",t=t||l.getAllWindows()[0],c.showOpenDialog(t,e,function(e){e?n.resolve(e[0]):n.reject()}),n.promise},t.exports.showSaveDialog=M,t.exports.request=function(e,t,n){var r=d.defer();if(n=!1!==n,(t=t||{}).method=t.method||"GET",n&&t.data){t.body=JSON.stringify(t.data);var o=t.headers||(t.headers={});o["Content-Type"]="application/json",o.Accept="application/json",delete t.data}return b(e,t).then(function(e){if(e.ok)return n?e.json():e;var t=new Error(e.statusText);throw t.status=e.status,t}).then(function(e){r.resolve(e)}).catch(function(e){e&&f.info(e),r.reject(e)}),r.promise}},{"7zip-bin":void 0,child_process:void 0,crypto:void 0,electron:void 0,"electron-is":void 0,"electron-log":void 0,"fs-extra":void 0,globby:void 0,"iconv-lite":void 0,lodash:void 0,"node-fetch":void 0,os:void 0,path:void 0,q:void 0,"sudo-prompt":void 0}]},{},[5]);