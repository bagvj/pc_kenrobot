function init(){app.makeSingleInstance((e,n)=>{mainWindow&&(mainWindow.isMinimized()&&mainWindow.restore(),mainWindow.focus())})&&app.quit(),i.transports.file.level="debug",i.transports.file.format="[{y}-{m}-{d} {h}:{i}:{s}] [{level}] {text}",r.dev()||(i.transports.console=!1),i.debug(`app start, version ${app.getVersion()}`),listenEvent(),listenMessage()}function createWindow(){mainWindow=new BrowserWindow({width:1280,height:800,frame:!1,show:!1}),args.fullscreen&&mainWindow.setFullScreen(!0),mainWindow.loadURL(`file://${__dirname}/../index.html`),mainWindow.focus(),mainWindow.on("closed",e=>{mainWindow=null}).once("ready-to-show",()=>{mainWindow.show()})}function listenEvent(){app.on("ready",e=>{i.debug("app ready"),r.dev()&&args.dev&&t({showDevTools:!0}),createWindow(),loadBoards()}).on("window-all-closed",e=>{"darwin"!==process.platform&&app.quit()}).on("activate",e=>{null===mainWindow&&createWindow()}).on("quit",e=>{i.debug("app quit")})}function listenMessage(){ipcMain.on("app:getVersion",(e,n)=>{e.sender.send("app:getVersion",n,!0,app.getVersion())}).on("app:reload",(e,n)=>{mainWindow.reload(),e.sender.send("app:reload",n,!0,!0)}).on("app:min",(e,n)=>{mainWindow.minimize(),e.sender.send("app:min",n,!0,!0)}).on("app:max",(e,n)=>{mainWindow.isFullScreen()?mainWindow.setFullScreen(!1):mainWindow.isMaximized()?mainWindow.unmaximize():mainWindow.maximize(),e.sender.send("app:max",n,!0,!0)}).on("app:fullscreen",(e,n)=>{var o=!mainWindow.isFullScreen();mainWindow.setFullScreen(o),e.sender.send("app:fullscreen",n,!0,o)}).on("app:quit",(e,n)=>{app.quit()}).on("app:openUrl",(e,n,o)=>{var r=o&&shell.openExternal(o);e.sender.send("app:openUrl",n,r,r)}).on("app:netRequest",(e,n,o)=>{var r=net.request(o);if(o.header)for(var t in o.header)r.setHeader(t,o.header[t]);r.on("response",r=>{var t=[],i=0;r.on("data",e=>{t.push(e),i+=e.length}).on("end",r=>{var a;switch(t.length){case 0:a=new Buffer(0);break;case 1:a=t[0];break;default:a=new Buffer(i);var d=0;t.forEach(e=>{e.copy(a,d),d+=e.len})}if(a=a.toString(),o.json){var u;try{u=JSON.parse(a)}catch(o){return void e.sender.send("app:netRequest",n,!1,a)}a=u}e.sender.send("app:netRequest",n,!0,a)})}).on("abort",o=>{i.error(err),e.sender.send("app:netRequest",n,!1,"abort")}).on("error",o=>{i.error(o),e.sender.send("app:netRequest",n,!1,o)}).end()}).on("app:execCommand",(e,n,o,r)=>{execCommand(o,r).then(o=>{e.sender.send("app:execCommand",n,!0,o)},o=>{e.sender.send("app:execCommand",n,!1,o)})}).on("app:readFile",(e,n,o,r)=>{readFile(o,r).then(o=>{e.sender.send("app:readFile",n,!0,o)},o=>{e.sender.send("app:readFile",n,!1,o)})}).on("app:writeFile",(e,n,o,r)=>{writeFile(o,r).then(o=>{e.sender.send("app:writeFile",n,!0,!0)},o=>{e.sender.send("app:writeFile",n,!1,o)})}).on("app:removeFile",(e,n,o)=>{removeFile(o).then(o=>{e.sender.send("app:removeFile",n,!0,!0)},o=>{e.sender.send("app:removeFile",n,!1,o)})}).on("app:saveProject",(e,n,o,r,t)=>{saveProject(o,r,t).then(o=>{e.sender.send("app:saveProject",n,!0,o)},o=>{e.sender.send("app:saveProject",n,!1,o)})}).on("app:openProject",(e,n,o)=>{openProject(o).then(o=>{e.sender.send("app:openProject",n,!0,o)},o=>{e.sender.send("app:openProject",n,!1,o)})}).on("app:buildProject",(e,n,o,r)=>{buildProject(o,r).then(o=>{e.sender.send("app:buildProject",n,!0,o)},o=>{e.sender.send("app:buildProject",n,!1,o)})}).on("app:upload",(e,n,o,r)=>{getSerialPorts().then(t=>{1==t.length?upload(o,t[0].comName,r).then(o=>{e.sender.send("app:upload",n,!0,!0)},o=>{e.sender.send("app:upload",n,!1,o)}):e.sender.send("app:upload",n,!1,{status:"SELECT_PORT",ports:t})},o=>{e.sender.send("app:upload",n,!1,{status:"NOT_FOUND_PORT"})})}).on("app:upload2",(e,n,o,r,t)=>{upload(o,r,t).then(o=>{e.sender.send("app:upload2",n,!0,!0)},o=>{e.sender.send("app:upload2",n,!1,o)})}).on("app:errorReport",(e,n,o)=>{i.error(`------ error message ------`),i.error(`${o.message}(${o.src} at line ${o.line}:${o.col})`),i.error(`${o.stack}`)}).on("app:log",(e,n,o,r)=>{i.log(r||"debug",o)})}function getSerialPorts(){var e=a.defer();return i.debug("getSerialPorts"),s.list((n,o)=>{return n?(console.error(n),void e.reject(n)):0==o.length?void e.reject():void matchBoardNames(o).then(n=>{o.forEach(e=>i.debug(`${e.comName}, pid: ${e.productId}, vid: ${e.vendorId}, boardName: ${e.boardName||""}`)),e.resolve(o)},n=>{n&&(console.error(n),e.reject(n))})}),e.promise}function getScript(e,o){var t="genuino101"==o?"_101":"";return r.windows()?n.join("scripts",`${e}${t}.bat`):r.macOS()?r.dev()?n.join(`scripts`,`${e}${t}.sh`):n.join(app.getAppPath(),"..","..","scripts",`${e}${t}.sh`):n.join("scripts",`${e}${t}.sh`)}function showOpenDialog(e){var n=a.defer();return e=e||{},e.title="打开",e.defaultPath=app.getPath("documents"),e.buttonLabel="打开",i.debug(`showOpenDialog: options: ${JSON.stringify(e)}`),dialog.showOpenDialog(mainWindow,e,e=>{return e?void n.resolve(e[0]):void n.reject()}),n.promise}function showSaveDialog(e){var n=a.defer();return e=e||{},e.title="保存",e.defaultPath=app.getPath("documents"),e.buttonLabel="保存",i.debug(`showSaveDialog: options: ${JSON.stringify(e)}`),dialog.showSaveDialog(mainWindow,e,e=>{return e?void n.resolve(e):void n.reject()}),n.promise}function readJson(e,n){var o=a.defer();return n=n||{},i.debug(`readJson:${e}, options: ${JSON.stringify(n)}`),d.readJson(e,n,(e,n)=>{return e?(i.error(e),void o.reject(e)):void o.resolve(n)}),o.promise}function writeJson(e,n,o){var r=a.defer();return o=o||{},i.debug(`writeJson:${e}, options: ${JSON.stringify(o)}`),d.outputJson(e,n,o,e=>{return e?(i.error(e),void r.reject(e)):void r.resolve()}),r.promise}function readFile(e,n){var o=a.defer();return n=n||"utf8",i.debug(`readFile:${e}, options: ${JSON.stringify(n)}`),d.readFile(e,n,(e,n)=>{return e?(i.error(e),void o.reject(e)):void o.resolve(n)}),o.promise}function writeFile(e,n){var o=a.defer();return i.debug(`writeFile:${e}`),d.outputFile(e,n,e=>{return e?(i.error(e),void o.reject(e)):void o.resolve()}),o.promise}function removeFile(e){var n=a.defer();return i.debug(`removeFile:${e}`),d.remove(e,data,e=>{return e?(i.error(e),void n.reject(e)):void n.resolve()}),n.promise}function saveProject(e,o,r){var t=a.defer();r=r===!0,i.debug(`saveProject: isTemp:${r}`);var d=e=>{var r=new Date;o.updated_at=r,o.project_name=n.basename(e),a.all([writeFile(n.join(e,n.basename(e)+".ino"),o.project_data.code),writeJson(n.join(e,"project.json"),o)]).then(n=>{t.resolve({path:e,updated_at:o.updated_at,project_name:o.project_name})},e=>{t.reject()})};if(e)d(e);else if(r){var u=n.join(app.getPath("temp"),"build","sketch"+(new Date).getTime());d(u)}else showSaveDialog().then(e=>{d(e)},e=>{t.reject()});return t.promise}function openProject(e){var o=a.defer(),r=e=>{readJson(n.join(e,"project.json")).then(n=>{o.resolve({path:e,projectInfo:n})},e=>{o.reject(e)})};return e?r(e):showOpenDialog({properties:["openDirectory"]}).then(e=>{r(e)},e=>{o.reject(e)}),o.promise}function buildProject(e,o){var r=a.defer();o=o||{},o.board_type=o.board_type||"uno";var t=getScript("build",o.board_type);i.debug(n.resolve(t));var d;return d="genuino101"==o.board_type?`${t} ${e}`:`${t} ${e} ${o.board_type}`,i.debug(`buildProject:${e}, options: ${JSON.stringify(o)}`),execCommand(d).then(t=>{r.resolve(n.join(e,"build",n.basename(e)+`.ino.${"genuino101"==o.board_type?"bin":"hex"}`))},e=>{r.reject(e)}),r.promise}function upload(e,o,r){var t=a.defer();return i.debug(`upload:${e}, ${o}, options: ${JSON.stringify(r)}`),preUpload(o,r.board_type).then(a=>{var d=getScript("upload",r.board_type);i.debug(n.resolve(d));var u=`${d} ${e} ${o}`;execCommand(u).then(e=>{t.resolve()},e=>{t.reject(e)})},e=>{t.reject(e)}),t.promise}function preUpload(e,n){var o=a.defer();if("genuino101"!=n)return setTimeout(e=>{o.resolve()},10),o.promise;var r=new s(e,{baudRate:1200});return r.on("open",e=>{r.set({rts:!0,dtr:!1}),setTimeout(e=>{r.close(e=>{o.resolve()})},650)}).on("error",e=>{i.error(e),r.close(n=>{o.reject(e)})}),o.promise}function getSystemSuffix(){if(r.windows())return"win";if(r.macOS())return"mac";var e=o.arch();return e.indexOf("arm")>=0?"arm":"linux"}function loadBoards(e){var n=a.defer();if(boardNames&&!e)return setTimeout(e=>{n.resolve(boardNames)},10),n.promise;var o={},r=/\n(([^\.\n]+)\.pid(\.\d)?)=([^\r\n]+)/g,t=/\n(([^\.\n]+)\.vid(\.\d)?)=([^\r\n]+)/g,i=/\n([^\.\n]+)\.name=([^\r\n]+)/g,d="arduino-"+getSystemSuffix();return c(`${d}/**/boards.txt`,{},(e,a)=>{return e?(console.error(e),void n.reject(e)):void a.forEach(e=>{var d=a.length;readFile(e).then(e=>{var a=e.match(r),u=e.match(t),s=e.match(i),c=[];s.forEach(e=>{var n=e.substring(0,e.indexOf(".name")).trim(),o=e.substring(e.indexOf("=")+1).trim();c[n]=o});var p=a.map(e=>e.substring(0,e.indexOf(".pid")).trim());a=a.map(e=>e.substring(e.indexOf("=")+3)),u=u.map(e=>e.substring(e.indexOf("=")+3));for(var f=0;f<a.length;f++)o[a[f]+"_"+u[f]]={pid:a[f],vid:u[f],type:p[f],name:c[p[f]]};d--,0==d&&(boardNames=o,n.resolve(boardNames))},e=>{console.error(e),n.reject(e)})})}),n.promise}function matchBoardNames(e){var n=a.defer();return loadBoards().then(o=>{e.forEach(e=>{if(e.productId&&e.vendorId){var n=boardNames[e.productId+"_"+e.vendorId];n&&(e.boardName=n.name)}}),n.resolve(e)},e=>{console.error(e),n.reject(e)}),n.promise}function execCommand(n,o){var r=a.defer();return o=o||{},i.debug(`execCommand:${n}, options: ${JSON.stringify(o)}`),e.exec(n,o,(e,n,o)=>{return e?(i.error(e),void r.reject(e)):void r.resolve(n)}),r.promise}function updateInit(e){i.debug("AppUpdater init");const n=o.platform();"linux"!=n&&"darwin"!=n&&(autoUpdater.on("error",(e,n)=>{i.debug(`auto update error: ${n}, ${JSON.stringify(e)}`)}).on("checking-for-update",e=>{i.debug("checking-for-update")}).on("update-available",e=>{i.debug("update-available")}).on("download-progress",e=>{i.debug("download-progress")}).on("update-downloaded",e=>{i.debug("update-downloaded"),autoUpdater.quitAndInstall()}),e.webContents.once("did-finish-load",e=>{i.debug("app updater checkForUpdates"),autoUpdater.checkForUpdates()}))}function updateNotify(e,n){var o=BrowserWindow.getAllWindows();0!=o.length&&o[0].webContents.send("notify",e,n)}const{app:app,BrowserWindow:BrowserWindow,ipcMain:ipcMain,net:net,dialog:dialog,shell:shell}=require("electron"),e=require("child_process"),n=require("path"),o=require("os"),r=require("electron-is"),t=require("electron-debug"),i=require("electron-log"),{autoUpdater:autoUpdater}=require("electron-updater"),a=require("q"),d=require("fs-extra"),u=require("minimist"),s=require("serialport"),c=require("glob");var boardNames,mainWindow,args=u(process.argv.slice(1));init();