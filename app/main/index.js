"use strict";var _slicedToArray=function(){return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,r){var n=[],t=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(t=(a=u.next()).done)&&(n.push(a.value),!r||n.length!==r);t=!0);}catch(e){o=!0,i=e}finally{try{!t&&u.return&&u.return()}finally{if(o)throw i}}return n}(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();!function e(r,n,t){function o(a,u){if(!n[a]){if(!r[a]){var c="function"==typeof require&&require;if(!u&&c)return c(a,!0);if(i)return i(a,!0);var s=new Error("Cannot find module '"+a+"'");throw s.code="MODULE_NOT_FOUND",s}var f=n[a]={exports:{}};r[a][0].call(f.exports,function(e){var n=r[a][1][e];return o(n||e)},f,f.exports,e,r,n,t)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<t.length;a++)o(t[a]);return o}({1:[function(e,r,n){r.exports={default:{build:{fqbn:"arduino:avr:uno:cpu=atmega328p",prefs:{"runtime.tools.avr-gcc.path":'"ARDUINO_PATH/hardware/tools/avr"',"runtime.tools.avrdude.path":'"ARDUINO_PATH/hardware/tools/avr"',"build.warn_data_percentage":"75"},command:'"ARDUINO_PATH/arduino-builder" -compile -logger=machine -hardware="ARDUINO_PATH/hardware" -hardware="ARDUINO_PATH/packages" -tools="ARDUINO_PATH/tools-builder" -tools="ARDUINO_PATH/hardware/tools/avr" -tools="ARDUINO_PATH/packages" -built-in-libraries="ARDUINO_PATH/libraries" -ide-version=10612 -warnings=none BUILD_SPECS -build-path="PROJECT_BUILD_PATH" "PROJECT_ARDUINO_FILE"'},upload:{target_type:"hex",mcu:"atmega328p",baudrate:"115200",programer:"arduino",command:'"ARDUINO_PATH/hardware/tools/avr/bin/avrdude" -C "ARDUINO_PATH/hardware/tools/avr/etc/avrdude.conf" -v -p ARDUINO_MCU -c ARDUINO_PROGRAMMER -b ARDUINO_BURNRATE -P ARDUINO_COMPORT -D -U "flash:w:TARGET_PATH:i"'}},librariesPath:[]}},{}],2:[function(e,r,n){r.exports={UperEnergy:100,Intel:101,KenBlock:102}},{}],3:[function(e,r,n){r.exports={SUCCESS:0,INVALID_PARAM:1,SYSTEM_ERROR:100,LOGIN_REQUIRED:200,PERMISSION_DENIED:201,INVALID_USER_TOKEN_SIGN:202,USER_TOKEN_EXPIRED:203,USER_NOT_EXITS:204,API_ERROR:300,INVALID_SSO_TICKET:301,INVALID_SSO_SESSION:302,INVALID_SSO_BROKER:303,INVLAID_SSO_SIGN:304}},{}],4:[function(e,r,n){r.exports={CHECK_UPDATE:"http://www.kenrobot.com/?app=api&mod=Download&act=checkupdate",REPORT:"http://userver.kenrobot.com/statistics/report",VERIFY:"http://server.kenrobot.com/api/auth/verify",PROJECT_SYNC_LIST:"http://server.kenrobot.com/api/project/sync/list",PROJECT_SYNC_CREATE:"http://server.kenrobot.com/api/project/sync/create",PROJECT_SYNC_DELETE:"http://server.kenrobot.com/api/project/sync/delete",PROJECT_SYNC_UPLOAD:"http://server.kenrobot.com/api/project/sync/upload",PROJECT_SYNC_DOWNLOAD:"http://server.kenrobot.com/api/project/sync/Download",PROJECT_SYNC_ITEM:"http://server.kenrobot.com/api/project/sync/item"}},{}],5:[function(e,r,n){function t(){G.debug("app ready"),H.dev()&&$.devTool&&z({showDevTools:!0}),$.project&&(I=$.project),function(){var e=V.defer();G.debug("loadConfig");var r=C.join(F.getAppDataPath(),"config.json");if(!Y.existsSync(r))return setTimeout(function(){e.resolve({})},10),e.promise;return F.readJson(r).then(function(r){e.resolve(r)},function(r){e.resolve({})}),e.promise}().then(function(e){S=e,o(),g(),function(){if(H.dev()||S.version==F.getVersion())return;S.version=F.getVersion(),S.reportInstall=!1,_=!0,s(!0)}(),function(){H.dev()||S.reportInstall||c(null,"installations").then(function(){S.reportInstall=!0,s()});c(null,"open")}()})}function o(){A=new E({width:1200,height:720,minWidth:1200,minHeight:720,frame:!1,show:!1,webPreferences:{webSecurity:!1}}),$.fullscreen?A.setFullScreen(!0):$.maximize&&A.maximize(),A.on("closed",function(){return A=null}).once("ready-to-show",function(){return A.show()}).on("enter-full-screen",function(){return F.postMessage("app:onFullscreenChange",!0)}).on("leave-full-screen",function(){return F.postMessage("app:onFullscreenChange",!1)}),A.webContents.on("will-navigate",function(e){return e.preventDefault()}).on("devtools-reload-page",function(){return B.closeAllSerialPort()}),A.webContents.session.on("will-download",l),A.loadURL("file://"+__dirname+"/../renderer/index.html"),A.focus()}function i(e,r){e.preventDefault(),I=J.check(r),D&&j().then(function(e){F.postMessage("app:onLoadProject",e)},function(e){e&&G.error(e)})}function a(e){e.preventDefault(),F.postMessage("app:onBeforeQuit")}function u(e){return B.closeAllSerialPort(),F.removeFile(C.join(F.getAppDataPath(),"temp"),!0),!0}function c(e,r){var n=V.defer(),t=F.getAppInfo(),o={version:t.version,platform:t.platform,bit:t.appBit,ext:t.ext,branch:t.branch,feature:t.feature};return e=W.merge({},e,o),r=r||"log",F.request(M.REPORT,{method:"post",data:{data:JSON.stringify(e),type:r}}).then(function(){n.resolve()},function(t){G.error("report error: type: "+r+", "+JSON.stringify(e)),t&&G.error(t),n.reject(t)}),n.promise}function s(e){var r=C.join(F.getAppDataPath(),"config.json");return F.writeJson(r,S,null,e)}function f(e){var r=V.defer();e=0!=e;var n=[],t=y();return G.debug("loadPackages: "+t),F.searchFiles(t+"/*/package.json").then(function(o){V.all(o.map(function(r){var o=V.defer();return e?F.readJson(r).then(function(e){e.order=L[e.name]||0,e.path=C.dirname(r),e.protocol=t.startsWith("/")?"file://":"file:///",e.boards&&e.boards.forEach(function(r){r.build&&r.build.prefs&&Object.keys(r.build.prefs).forEach(function(n){r.build.prefs[n]=r.build.prefs[n].replace("PACKAGE_PATH",e.path)}),r.upload&&r.upload.command&&(r.upload.command=r.upload.command.replace(/PACKAGE_PATH/g,e.path))});var o=C.join(e.path,"src");Y.existsSync(o)&&!q.librariesPath.includes(o)&&q.librariesPath.push(o),n.push(e)}).fin(function(){o.resolve()}):F.readJson(r).then(function(e){return n.push(e)}).fin(function(){return o.resolve()}),o.promise})).then(function(){r.resolve(n)})},function(e){e&&G.error(e),r.reject(e)}),r.promise}function l(e,r,n){var t=r.getURL(),o=t.lastIndexOf("#"),i=k.parse(t.substring(o+1));t=t.substring(0,o);var a=i.deferId,u=C.join(F.getAppDataPath(),"download",r.getFilename());if(i.checksum&&Y.existsSync(u)){o=i.checksum.indexOf(":");var c=i.checksum.substring(0,o).replace("-","").toLowerCase();if(i.checksum.substring(o+1)==Q.fromFileSync(u,{algorithm:c}))return r.cancel(),G.debug("download cancel, "+t+" has cache"),void F.callDefer(a,!0,{path:u})}r.setSavePath(u);var s=r.getTotalBytes();r.on("updated",function(e,n){"interrupted"==n?(G.debug("download interrupted: "+t),F.callDefer(a,!1,{path:u})):"progressing"===n&&(r.isPaused()?(G.debug("download paused: "+t),F.callDefer(a,!1,{path:u})):F.callDefer(a,"notify",{path:u,totalSize:s,size:r.getReceivedBytes()}))}),r.once("done",function(e,r){"completed"==r?(G.debug("download success: "+t+", at "+u),F.callDefer(a,!0,{path:u})):(G.debug("download fail: "+t),F.callDefer(a,!1,{path:u}))})}function p(e,r){F.postMessage("app:onSerialPortError",e,r)}function d(e,r){F.postMessage("app:onSerialPortData",e,r)}function v(e){F.postMessage("app:onSerialPortClose",e)}function m(){var e=V.defer();return B.listSerialPort().then(function(r){0!=(r=function(e){var r=/(COM\d+)|(usb-serial)|(arduino)|(\/dev\/cu\.usbmodem)|(\/dev\/tty\.)|(\/dev\/(ttyUSB|ttyACM|ttyAMA))/;return e.filter(function(e){return r.test(e.comName)})}(r)).length?function(e){var r=V.defer();return G.debug("matchBoardNames"),g().then(function(n){e.forEach(function(e){if(e.productId&&e.vendorId){var r=S.boardNames[e.productId+"_"+e.vendorId];r&&(e.boardName=r.name)}}),r.resolve(e)},function(e){e&&G.error(e),r.reject(e)}),r.promise}(r).then(function(){G.debug(r.map(function(e){return e.comName+", pid: "+e.productId+", vid: "+e.vendorId+", boardName: "+(e.boardName||"")}).join("\n")),e.resolve(r)},function(r){r&&G.error(r),e.reject(r)}):e.reject()},function(r){r&&G.error(r),e.reject(r)}),e.promise}function h(e,r,n){var t=V.defer();return function(e,r,n){var t=V.defer();G.debug("pre upload firmware"),n=W.merge({},q.default.upload,n);var o=P("upload"),i=F.handleQuotes(n.command);return i=i.replace(/ARDUINO_PATH/g,x()).replace("ARDUINO_MCU",n.mcu).replace("ARDUINO_BURNRATE",n.baudrate).replace("ARDUINO_PROGRAMMER",n.programer).replace("ARDUINO_COMPORT",r).replace("TARGET_PATH",e),F.writeFile(o,i).then(function(){B.resetSerialPort(r).then(function(){t.resolve(o)},function(e){e&&G.error(e),t.reject(e)})},function(e){e&&G.error(e),t.reject(e)}),t.promise}(e,r,n).then(function(n){G.debug("upload firmware: "+e+", "+r+", command path: "+n);var o=b("call");F.spawnCommand('"'+o+'"',['"'+n+'"'],{shell:!0}).then(function(){t.resolve()},function(e){e&&G.error(e),t.reject(e)},function(e){t.notify(e)})},function(e){e&&G.error(e),t.reject(e)}),t.promise}function g(e){var r=V.defer();if(S.boardNames&&!e)return G.debug("skip loadBoards"),setTimeout(function(){r.resolve(S.boardNames)},10),r.promise;G.debug("loadBoards");var n={},t=/\n(([^\.\n]+)\.pid(\.\d)?)=([^\r\n]+)/g,o=/\n(([^\.\n]+)\.vid(\.\d)?)=([^\r\n]+)/g,i=/\n([^\.\n]+)\.name=([^\r\n]+)/g,a="arduino-"+F.getPlatform();return F.searchFiles(a+"/**/boards.txt").then(function(e){V.all(e.map(function(e){var r=V.defer();return F.readFile(e).then(function(e){var r=e.match(t),a=e.match(o),u=[];e.match(i).forEach(function(e){var r=e.substring(0,e.indexOf(".name")).trim(),n=e.substring(e.indexOf("=")+1).trim();u[r]=n});var c=r.map(function(e){return e.substring(0,e.indexOf(".pid")).trim()});r=r.map(function(e){return e.substring(e.indexOf("=")+3)}),a=a.map(function(e){return e.substring(e.indexOf("=")+3)}),r.forEach(function(e,r){n[e+"_"+a[r]]={pid:e,vid:a[r],type:c[r],name:u[c[r]]}})}).fin(function(){r.resolve()}),r.promise})).then(function(){S.boardNames=n,s().then(function(){r.resolve(S.boardNames)},function(e){e&&G.error(e),r.reject(e)})})},function(e){e&&G.error(e),r.reject(e)}),r.promise}function j(){if(D=!0,I){G.debug("loadProject: "+I);var e=I;return I=null,J.read(e)}return F.rejectPromise()}function b(e){var r=H.windows()?"bat":"sh";return C.join(F.getAppResourcePath(),"scripts",e+"."+r)}function P(e){return C.join(F.getAppDataPath(),"temp",e+".txt")}function x(){return C.join(F.getAppResourcePath(),"arduino-"+F.getPlatform())}function y(){return C.join(T.getPath("documents"),T.getName(),"packages")}function w(){return C.join(T.getPath("documents"),T.getName(),"libraries")}var S,A,_,I,D,O=e("electron"),T=O.app,E=O.BrowserWindow,N=(O.ipcMain,O.shell),R=O.clipboard,C=e("path"),k=e("querystring"),F=e("./util"),U=e("./token"),B=e("./serialPort"),J=e("./project"),L=e("./config/packageOrders"),q=e("./config/arduinoOptions"),M=e("./config/url"),H=e("electron-is"),z=e("electron-debug"),G=e("electron-log"),V=e("q"),Y=e("fs-extra"),K=e("command-line-args"),Q=e("hasha"),W=e("lodash"),X=F.listenMessage,Z=[{name:"debug-brk",type:Number,defaultValue:!1},{name:"dev",alias:"d",type:Boolean,defaultValue:!1},{name:"devTool",alias:"t",type:Boolean,defaultValue:!1},{name:"fullscreen",alias:"f",type:Boolean,defaultValue:!1},{name:"maximize",alias:"m",type:Boolean,defaultValue:!1},{name:"project",alias:"p",type:J.check,defaultOption:!0}],$=K(Z,{argv:process.argv.slice(1),partial:!0});process.on("uncaughtException",function(e){var r=e.stack||e.name+": "+e.message;G.error(r),T.quit()}),G.transports.file.format="[{y}-{m}-{d} {h}:{i}:{s}] [{level}] {text}",H.dev()&&$.dev?G.transports.file.level="debug":(G.transports.console=!1,G.transports.file.level="error"),T.makeSingleInstance(function(e,r){if(A){A.isMinimized()&&A.restore(),A.focus();var n=K(Z,{argv:e.slice(1),partial:!0});n.project&&(I=n.project),G.debug("app second run"),j().then(function(e){F.postMessage("app:onLoadProject",e)},function(e){e&&G.error(e)})}})&&T.quit(),T.on("ready",t).on("window-all-closed",function(){return"darwin"!==process.platform&&T.quit()}).on("activate",function(){return null===A&&o()}).on("before-quit",a).on("will-quit",u).on("quit",function(){return G.debug("app quit")}),H.macOS()&&T.on("open-file",i),X("getAppInfo",function(){return F.resolvePromise(F.getAppInfo())}),X("loadSetting",function(){return F.resolvePromise(S.setting||{})}),X("saveSetting",function(e){return function(e){return S.setting=e,s()}(e)}),X("execFile",function(e){return F.execFile(e)}),X("execCommand",function(e,r){return F.execCommand(e,r)}),X("spawnCommand",function(e,r,n){return F.spawnCommand(e,r,n)}),X("readFile",function(e,r){return F.readFile(e,r)}),X("writeFile",function(e,r){return F.writeFile(e,r)}),X("saveFile",function(e,r,n){return F.saveFile(e,r,n)}),X("moveFile",function(e,r,n){return F.moveFile(e,r,n)}),X("removeFile",function(e){return F.removeFile(e)}),X("readJson",function(e,r){return F.readJson(e,r)}),X("writeJson",function(e,r,n,t){return F.writeJson(e,r,n,t)}),X("showOpenDialog",function(e){return F.showOpenDialog(e)}),X("showSaveDialog",function(e){return F.showSaveDialog(e)}),X("request",function(e,r,n){return F.request(e,r,n)}),X("showItemInFolder",function(e){return N.showItemInFolder(C.normalize(e))}),X("openUrl",function(e){return F.resolvePromise(e&&N.openExternal(e))}),X("listSerialPort",function(){return m()}),X("openSerialPort",function(e,r){return function(e,r){return B.openSerialPort(e,r,{onError:p,onData:d,onClose:v})}(e,r)}),X("writeSerialPort",function(e,r){return B.writeSerialPort(e,r)}),X("closeSerialPort",function(e){return B.closeSerialPort(e)}),X("updateSerialPort",function(e,r){return B.updateSerialPort(e,r)}),X("flushSerialPort",function(e){return B.flushSerialPort(e)}),X("buildProject",function(e,r){return function(e,r){var n=V.defer();return function(e,r){var n=V.defer();G.debug("pre-build");var t=C.join(e,"cache"),o=C.join(t,"build");return Y.ensureDirSync(o),F.removeFile(C.join(o,"sketch","build"),!0),F.removeFile(C.join(e,"build"),!0),J.read(e).then(function(e){var i=e.data,a=C.join(t,i.project_name+".ino");F.writeFile(a,i.project_data.code).then(function(){var e=[];r=W.merge({},q.default.build,r);var t=y();Y.existsSync(t)&&e.push("-hardware="+t),e.push("-fqbn="+r.fqbn);var i=x();Object.keys(r.prefs).forEach(function(n){var t=F.handleQuotes(r.prefs[n]);t=t.replace(/ARDUINO_PATH/g,i),e.push("-prefs="+n+"="+t)});var u=w();Y.existsSync(u)&&e.push('-libraries="'+u+'"'),q.librariesPath.forEach(function(r){e.push('-libraries="'+r+'"')});var c=P("build"),s=F.handleQuotes(r.command);s=s.replace(/ARDUINO_PATH/g,x()).replace("BUILD_SPECS",e.join(" ")).replace("PROJECT_BUILD_PATH",o).replace("PROJECT_ARDUINO_FILE",a),F.writeFile(c,s).then(function(){var e=C.join(o,"build.options.json");if(!Y.existsSync(e))return setTimeout(function(){n.resolve(c)},10),n.promise;F.readJson(e).then(function(e){r.fqbn!=e.fqbn?F.removeFile(o).fin(function(){Y.ensureDirSync(o),n.resolve(c)}):n.resolve(c)},function(e){e&&G.error(e),n.resolve(c)})},function(e){e&&G.error(e),n.reject()})},function(e){e&&G.error(e),n.reject()})},function(e){e&&G.error(e),n.reject()}),n.promise}(e,r).then(function(r){G.debug("buildProject: "+e+", command path: "+r);var t=b("call");F.spawnCommand('"'+t+'"',['"'+r+'"'],{shell:!0}).then(function(){n.resolve()},function(e){e&&G.error(e),n.reject(e)},function(e){n.notify(e)})},function(e){e&&G.error(e),n.reject(e)}),n.promise}(e,r)}),X("upload",function(e,r){return function(e,r){return r=W.merge({},q.default.upload,r),function(e,r){var n=V.defer();return m().then(function(t){1==t.length?h(e,t[0].comName,r).then(function(e){n.resolve(e)},function(e){n.reject(e)},function(e){n.notify(e)}):n.reject({status:"SELECT_PORT",ports:t})},function(){n.reject({status:"NOT_FOUND_PORT"})}),n.promise}(C.join(e,"cache","build",C.basename(e)+".ino."+r.target_type),r)}(e,r)}),X("upload2",function(e,r,n){return function(e,r,n){return n=W.merge({},q.default.upload,n),h(C.join(e,"cache","build",C.basename(e)+".ino."+n.target_type),r,n)}(e,r,n)}),X("download",function(e,r){return function(e,r){var n=V.defer(),t=F.getDefer(),o=t.deferId,i=t.promise;r.deferId=o;var a=k.stringify(r);return G.debug("download "+e+", options: "+a),i.then(function(e){n.resolve(e)},function(e){e&&G.error(e),n.reject(e)},function(e){n.notify(e)}),A.webContents.downloadURL(e+"#"+a),n.promise}(e,r)}),X("installDriver",function(e){return function(e){var r=V.defer();G.debug("installDriver: "+e);var n=C.join(F.getAppDataPath(),"temp");return F.uncompress(e,n).then(function(){var t=C.join(n,C.basename(e,C.extname(e)),"setup.exe");F.execFile(t).then(function(){r.resolve()})},function(e){e&&G.error(e),r.reject(e)}),r.promise}(e)}),X("loadExamples",function(){return function(){var e=V.defer(),r=[];return G.debug("loadExamples"),F.readJson(C.join(F.getAppResourcePath(),"examples","examples.json")).then(function(n){r.push({name:"built-in",groups:n});var t=y();F.searchFiles(t+"/*/examples/examples.json").then(function(n){V.all(n.map(function(e){var n=V.defer();return F.readJson(e).then(function(n){r.push({name:C.basename(C.dirname(C.dirname(e))),groups:n})}).fin(function(){n.resolve()}),n.promise})).then(function(){e.resolve(r)})},function(r){r&&G.error(r),e.reject(r)})},function(r){r&&G.error(r),e.reject(r)}),e.promise}()}),X("openExample",function(e,r,n){return function(e,r,n){var t,o=V.defer();return t="built-in"==(n=n||"built-in")?C.join(F.getAppResourcePath(),"examples",e,r):C.join(y(),n,"examples",e,r),G.debug("openExample: "+t),J.read(t).then(function(e){o.resolve(e)},function(e){e&&G.error(e),o.reject(e)}),o.promise}(e,r,n)}),X("unzipPackages",function(e){return function(e){var r=V.defer();if(e=e||H.dev())return G.debug("skip unzip packages"),setTimeout(function(){r.resolve()},10),r.promise;G.debug("unzip packages");var n=C.join(F.getAppResourcePath(),"packages");return F.readJson(C.join(n,"packages.json")).then(function(e){var t=S.packages||[],o=e.filter(function(e){return!!_||!!t.find(function(r){return r.name==e.name&&r.checksum!=e.checksum})||!Y.existsSync(C.join(y(),e.name,"package.json"))}),i=o.length;!function e(){if(0==o.length)return S.packages=t,void(H.dev()?r.resolve():s().fin(function(){r.resolve()}));var a=o.pop();F.uncompress(C.join(n,a.archiveName),y(),!0).then(function(){var e=t.findIndex(function(e){return e.name==a.name});e>=0?t.splice(e,1,a):t.push(a)},function(e){},function(e){r.notify({progress:e,name:a.name,version:a.version,count:i-o.length,total:i})}).fin(function(){return e()})}()},function(e){e&&G.error(e),r.resolve()}),r.promise}(e)}),X("unzipPackage",function(e){return function(e){var r=V.defer();return F.uncompress(e,y(),!0).then(function(){var n=C.basename(e);n=n.substring(0,n.indexOf("-"));var t=H.windows()?"bat":"sh";F.searchFiles(C.join(y(),n)+"/**/post_install."+t).then(function(e){if(0!=e.length){var n=e[0];F.execCommand('"'+n+'"',{cwd:C.dirname(n)}).then(function(){r.resolve()},function(e){e&&G.error(e),r.reject(e)})}else r.resolve()},function(e){e&&G.error(e),r.reject(e)})},function(e){e&&G.error(e),r.reject(e)},function(e){r.notify(e)}),r.promise}(e)}),X("loadPackages",function(e){return f(e)}),X("deletePackage",function(e){return function(e){var r=V.defer();return G.debug("deletePackage: "+e),F.removeFile(C.join(y(),e)).then(function(){r.resolve()},function(e){e&&G.error(e),r.reject(e)}),r.promise}(e)}),X("getInstalledLibraries",function(){return function(){var e=V.defer(),r=/^([^=]+)=(.*)$/gm;return F.searchFiles(w()+"/**/library.properties").then(function(n){var t=[];V.all(n.map(function(e){var n=V.defer();return F.readFile(e).then(function(e){var n=e.match(r);if(!(n.length<0)){var o={};n.map(function(e){return e.split("=")}).forEach(function(e){o[e[0]]=e[1]}),o.name&&o.version&&t.push(o)}}).fin(function(){n.resolve()}),n.promise})).then(function(){e.resolve(t)})},function(r){r&&G.error(r),e.reject(r)}),e.promise}()}),X("loadLibraries",function(){return function(){var e=V.defer();return F.readJson(C.join(F.getAppResourcePath(),"libraries","libraries.json")).then(function(r){e.resolve(r.libraries)},function(r){r&&G.error(r),e.reject(r)}),e.promise}()}),X("unzipLibrary",function(e,r){return function(e,r){var n=V.defer(),t=w(),o=C.basename(r,C.extname(r));return F.uncompress(r,t,!0).then(function(){F.moveFile(C.join(t,o),C.join(t,e)).then(function(){n.resolve()},function(e){e&&G.error(e),n.reject(e)})},function(e){e&&G.error(e),n.reject(e)},function(e){n.notify(e)}),n.promise}(e,r)}),X("deleteLibrary",function(e){return function(e){var r=V.defer();return G.debug("deleteLibrary: "+e),F.removeFile(C.join(w(),e)).then(function(){r.resolve()},function(e){e&&G.error(e),r.reject(e)}),r.promise}(e)}),X("checkUpdate",function(e){return function(){var e=V.defer(),r=F.getAppInfo(),n=M.CHECK_UPDATE+"&appname="+r.name+"&release_version="+r.branch+"&version="+r.version+"&platform="+r.platform+"&arch="+r.arch+"&ext="+r.ext+"&features="+r.feature;return G.debug("checkUpdate: "+n),F.request(n).then(function(r){e.resolve(r)},function(r){r&&G.error(r),e.reject(r)}),e.promise}()}),X("checkPackageLibraryUpdate",function(e){return function(e){var r=V.defer();return V.all([f(!1),F.request(e)]).then(function(e){var n=e[0],t=e[1],o=[];n.forEach(function(e){var r=t.find(function(r){return r.name==e.name&&F.versionCompare(r.version,e.version)>0});r&&o.push(r)});var i=0;o.length>0&&(i=1),r.resolve({status:i})},function(e){e&&G.error(e),r.reject(e)}),r.promise}(e)}),X("removeOldVersions",function(e){return function(e){var r=V.defer();if(H.dev())return setTimeout(function(){r.resolve()},10),r.promise;var n=F.getAppInfo(),t=C.join(F.getAppDataPath(),"download");return F.searchFiles(t+"/"+n.name+"-*."+n.ext).then(function(n){var o=/\d+\.\d+\.\d+/;n.map(function(e){return C.basename(e)}).filter(function(r){var n=r.match(o);return!!n&&F.versionCompare(n[0],e)<0}).forEach(function(e){F.removeFile(C.join(t,e),!0)}),r.resolve()},function(e){e&&G.error(e),r.reject(e)}),r.promise}(e)}),X("reportToServer",function(e,r){return c(e,r)}),X("saveToken",function(e){return U.save(e)}),X("loadToken",function(e){return U.load(e)}),X("removeToken",function(){return U.remove()}),X("verifyToken",function(){return U.verify()}),X("projectLoad",function(){return j()}),X("projectRead",function(e){return J.read(e)}),X("projectOpen",function(e){return J.open(e)}),X("projectSave",function(e,r,n){return J.save(e,r,n)}),X("projectSaveAs",function(e,r,n){return J.saveAs(e,r,n)}),X("projectSync",function(){return J.sync()}),X("projectList",function(){return J.list()}),H.dev()&&(X("projectCreate",function(e){return J.create(e)}),X("projectUpload",function(e,r){return J.upload(e,r)}),X("projectDelete",function(e,r){return J.remove(e,r)}),X("projectDownload",function(e,r){return J.download(e,r)})),X("log",function(e,r){return(G[r]||G.debug).bind(G).call(e)}),X("copy",function(e,r){return R.writeText(e,r)}),X("quit",function(){return T.quit()}),X("exit",function(){return u()&&T.exit(0)}),X("reload",function(){return A.reload()}),X("relaunch",function(){return T.relaunch({args:process.argv.slice(1).concat(["--relaunch"])}),void T.exit(0)}),X("fullscreen",function(){return A.setFullScreen(!A.isFullScreen())}),X("min",function(){return A.minimize()}),X("max",function(){A.isFullScreen()?A.setFullScreen(!1):A.isMaximized()?A.unmaximize():A.maximize()}),X("errorReport",function(e){return function(e){G.error("------ error message ------"),G.error(e.message+"("+e.src+" at line "+e.line+":"+e.col+")"),G.error(""+e.stack)}(e)}),G.debug("app "+T.getName()+" start, version "+F.getVersion())},{"./config/arduinoOptions":1,"./config/packageOrders":2,"./config/url":4,"./project":6,"./serialPort":7,"./token":8,"./util":9,"command-line-args":void 0,electron:void 0,"electron-debug":void 0,"electron-is":void 0,"electron-log":void 0,"fs-extra":void 0,hasha:void 0,lodash:void 0,path:void 0,q:void 0,querystring:void 0}],6:[function(e,r,n){function t(e){return g.extname(e)==A&&j.existsSync(e)?e:null}function o(e,r){var n,o=b.defer();if(t(e))n=e;else{var i=g.basename(e);n=g.join(e,i+A),j.existsSync(n)||(n=g.join(e,"project.json"))}return y.readJson(n).then(function(e){o.resolve({path:g.dirname(n),project_type:r||e.project_type,data:e})},function(e){e&&x.error(e),o.reject(e)}),o.promise}function i(){var e=b.defer();return x.debug("project sync"),b.all([a(),l()]).then(function(r){var n=_slicedToArray(r,2);(function(e,r){var n=b.defer(),o=function(e,r){var n={},o={};e.forEach(function(e){n[""+e.name]=e}),r.forEach(function(e){o[""+e.name]=e});var i=[],a=[],u=[];return e.forEach(function(e){var r=o[e.name];!r||!r.modify_time||r.modify_time<e.modify_time?i.push(e):t(g.join(m(),e.name,e.name+A))||i.push(e)}),r.forEach(function(e){var r=n[e.name];r?r.modify_time<e.modify_time&&a.push(e):(u.push(e),a.push(e))}),[u,i,a]}(e,r),i=_slicedToArray(o,3),a=i[0],f=i[1],l=i[2];x.debug("doSync: createList:"+a.length+", downloadList:"+f.length+", uploadList:"+l.length);var p=a.length+f.length+l.length,d=0,v=function(e,r){d++,n.notify({total:p,count:d,name:e,action:r})};return function(e,r){var n,t=b.defer();return(n=function(){if(0==e.length)return y.resolvePromise(!0,t);var o=e.shift();s(o.name,o.hash).then(function(){r(o.name,"download"),0==e.length?t.resolve():setTimeout(function(){return n()},100)},function(e){e&&x.error(e),t.reject(e)})})(),t.promise}(f,v).then(function(){(function(e,r){var n,t=b.defer();return(n=function(){if(0==e.length)return y.resolvePromise(!0,t);var o=e.shift();u(o.name).then(function(i){o.hash=i.hash,r(o.name,"create"),0==e.length?t.resolve():setTimeout(function(){return n()},100)},function(e){e&&x.error(e),t.reject(e)})})(),t.promise})(a,v).then(function(){(function(e,r){var n,t=b.defer();return(n=function(){if(0==e.length)return y.resolvePromise(!0,t);var o=e.shift();c(o.name,o.hash).then(function(){r(o.name,"upload"),0==e.length?t.resolve():setTimeout(function(){return n()},100)},function(e){e&&x.error(e),t.reject(e)})})(),t.promise})(l,v).then(function(){n.resolve()},function(e){e&&x.error(e),n.reject(e)})},function(e){e&&x.error(e),n.reject(e)})},function(e){e&&x.error(e),n.reject(e)}),n.promise})(n[0],n[1]).then(function(){x.debug("project sync success"),e.resolve()},function(r){x.debug("project sync fail"),r&&x.error(r),e.reject(r)},function(r){e.notify(r)})},function(r){r&&x.error(r),e.reject(r)}),e.promise}function a(){var e=b.defer();return x.debug("project list"),w.request(S.PROJECT_SYNC_LIST,{method:"post"}).then(function(r){0==r.status?e.resolve(r.data):e.reject(r.message)},function(r){r&&x.error(r),e.reject(r)}),e.promise}function u(e){var r=b.defer();return x.debug("project create: "+e),w.request(config.url.projectSynCreate,{method:"post",data:{name:e,type:_}}).then(function(n){if(0==n.status){var t=n.data;d(t.name,t.modify_time,t.hash).then(function(){x.debug("project create success: "+e+" "+t.hash),r.resolve(t)},function(e){e&&x.error(e),r.reject(e)})}else r.reject(n.message)},function(e){e&&x.error(e),r.reject(e)}),r.promise}function c(e,r){var n=b.defer();return x.debug("project upload: "+e+": "+r),function(e,r){var n=b.defer(),t=g.join(y.getAppDataPath(),"temp",y.uuid(6)+".7z"),o=[r+"/"+r+A];return y.compress(e,o,t).then(function(){n.resolve(t)},function(e){e&&x.error(e),n.reject(e)}),n.promise}(m(),e).then(function(t){var o=S.PROJECT_SYNC_UPLOAD+"/"+r;w.request(o,{method:"post",body:j.createReadStream(t)}).then(function(t){if(0==t.status){var o=t.data;d(e,o.modify_time,r).then(function(){x.debug("project upload success: "+e),n.resolve(o)},function(e){e&&x.error(e),n.reject(e)})}else n.reject(t.message)},function(e){e&&x.error(e),n.reject(e)})},function(e){e&&x.error(e),n.reject(e)}),n.promise}function s(e,r){var n=b.defer();x.debug("project download: "+r);var t=S.PROJECT_SYNC_DOWNLOAD+"/"+r;return w.request(t,{method:"post"},!1).then(function(t){var o=g.join(y.getAppDataPath(),"temp",y.uuid(6)+".7z");j.ensureDirSync(g.dirname(o));var i=j.createWriteStream(o);t.body.pipe(i),t.body.on("end",function(){y.uncompress(o,m()).then(function(){d(e,null,r).then(function(){x.debug("project download success: "+e),n.resolve()},function(e){e&&x.error(e),n.reject(e)})},function(e){e&&x.error(e),n.reject(e)})}).on("error",function(e){e&&x.error(e),n.reject(e)})},function(e){e&&x.error(e),n.reject(e)}),n.promise}function f(e,r,n,t){n.project_name=r,n.project_type=t||"local",n.updated_at=new Date;var o=g.join(e,r+A);return x.debug("project save: "+o),b.all([y.writeJson(o,n),y.removeFile(g.join(e,r+".ino")),y.removeFile(g.join(e,"project.json"))])}function l(){var e=b.defer();if(!w.get())return y.rejectPromise(null,e);var r=v();return j.existsSync(r)?y.readJson(r):y.resolvePromise([],e)}function p(e){return w.get()?y.writeJson(v(),e):y.rejectPromise()}function d(e,r,n){var t=b.defer();return r=r||y.stamp(),l().then(function(o){var i=o.find(function(r){return n&&r.hash==n||r.name==e});i?(e&&(i.name=e),n&&(i.hash=n),i.modify_time=r):o.push({name:e,hash:n,modify_time:r}),p(o).then(function(){t.resolve()},function(e){e&&x.error(e),t.reject(e)})},function(e){e&&x.error(e),t.reject(e)}),t.promise}function v(){var e=w.get();return e?g.join(y.getAppDataPath(),"projects",h(e.id,1),"list.json"):null}function m(){var e=w.get();return e?g.join(y.getAppDocumentPath(),"projects",h(e.id)):null}function h(e,r){return r=r||0,P(""+e,{algorithm:"md5"}).substring(8*r,8*(r+1))}var g=e("path"),j=e("fs-extra"),b=e("q"),P=e("hasha"),x=e("electron-log"),y=e("./util"),w=e("./token"),S=e("./config/url"),A=".krb",_="krobot",I=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],D=96;y.throttle(i,3e3);r.exports.check=t,r.exports.read=o,r.exports.open=function(e){var r=b.defer(),n=function(e){o(e).then(function(e){r.resolve(e)},function(e){e&&x.error(e),r.reject(e)})},t=w.get();if(e)return t?(n(g.join(m(),e)),r.promise):y.rejectPromise(null,r);var i={};return i.defaultPath=t?m():y.getAppPath("documents"),i.properties=["openDirectory"],y.showOpenDialog(i).then(function(e){n(e)},function(e){e&&x.error(e),r.reject(e)}),r.promise},r.exports.save=function(e,r,n){var t=b.defer();return f(n,e,r,"local").then(function(){t.resolve({project_name:r.project_name,project_type:r.project_type,updated_at:r.updated_at,path:n})},function(e){e&&x.error(e),t.reject(e)}),t.promise},r.exports.saveAs=function(e,r,n,t){var o=b.defer(),i=function(e,n){f(e,n,r).then(function(){o.resolve({project_name:r.project_name,project_type:r.project_type,updated_at:r.updated_at,path:e})},function(e){e&&x.error(e),o.reject(e)})};return n?(t=g.join(y.getAppPath("temp"),"build","sketch_"+y.stamp()),i(t,g.basename(t))):t?i(g.join(g.dirname(t),e),e):y.showSaveDialog({defaultPath:function(){var e=new Date,r=I[e.getMonth()],n=(100+e.getDate()).toString().substring(1),t=(D++,String.fromCharCode(D<=122?D:D=97));return"sketch_"+r+n+t}()}).then(function(e){i(e,g.basename(e))},function(e){e&&x.error(e),o.reject(e)}),o.promise},r.exports.sync=i,r.exports.list=a,r.exports.create=u,r.exports.remove=function(e,r){var n=b.defer();return x.debug("project remove: "+r),w.request(S.PROJECT_SYNC_DELETE,{method:"post",data:{hash:r}}).then(function(t){0==t.status?b.all([y.removeFile(g.join(m(),e)),function(e){var r=b.defer();return l().then(function(n){var t=n.findIndex(function(r){return r.hash==e});t<0?r.resolve():(n.splice(t,1),p(n).then(function(){r.resolve()},function(e){e&&x.error(e),r.reject(e)}))},function(e){e&&x.error(e),r.reject(e)}),r.promise}(r)]).then(function(){x.debug("project remove success: "+e),n.resolve()},function(e){e&&x.error(e),n.reject(e)}):n.reject(t.message)},function(e){e&&x.error(e),n.reject(e)}),n.promise},r.exports.upload=c,r.exports.download=s},{"./config/url":4,"./token":8,"./util":9,"electron-log":void 0,"fs-extra":void 0,hasha:void 0,path:void 0,q:void 0}],7:[function(e,r,n){e("path");var t=e("electron-log"),o=e("q"),i=e("serialport"),a=i.parsers.Delimiter,u={autoPortId:0,ports:{}};r.exports.listSerialPort=function(){var e=o.defer();return t.debug("listSerialPort"),i.list(function(r,n){if(r)return t.error(r),void e.reject(r);0!=n.length?e.resolve(n):e.reject()}),e.promise},r.exports.openSerialPort=function(e,r,n){var c=o.defer();t.debug("openSerialPort: "+e+", options: "+JSON.stringify(r)),r.autoOpen=!1;var s=new i(e,r);return s.open(function(e){if(e)return t.error(e),void c.reject(e);var o=++u.autoPortId;u.ports[o]=s,s.on("error",function(e){n&&n.onError&&n.onError(o,e)}),s.on("close",function(){delete u.ports[o],n&&n.onClose&&n.onClose(o)});var i="raw"==r.parser?s:s.pipe(new a({delimiter:Buffer.from(r.parser)}));i.on("readable",function(){var e=i.read();e&&n&&n.onData&&n.onData(o,e)}),s.flush(function(){c.resolve(o)})}),c.promise},r.exports.writeSerialPort=function(e,r){var n=o.defer();t.debug("writeSerialPort: "+e+", "+r);var i=u.ports[e];return i?(i.write(Buffer.from(r),function(e){if(e)return t.error(e),void n.reject(e);i.drain(function(){n.resolve()})}),n.promise):(setTimeout(function(){n.reject()},10),n.promise)},r.exports.closeSerialPort=function(e){var r=o.defer();t.debug("closeSerialPort, portId: "+e);var n=u.ports[e];return n?(n.close(function(){r.resolve()}),r.promise):(setTimeout(function(){r.reject()},10),r.promise)},r.exports.closeAllSerialPort=function(){t.debug("closeAllSerialPort");for(var e in u.ports)u.ports[e].close();u.ports={}},r.exports.updateSerialPort=function(e,r){var n=o.defer();t.debug("updateSerialPort, portId: "+e);var i=u.ports[e];return i?(i.update(r,function(){n.resolve()}),n.promise):(setTimeout(function(){n.reject()},10),n.promise)},r.exports.flushSerialPort=function(e,r){var n=o.defer();t.debug("flushSerialPort, portId: "+e);var i=u.ports[e];return i?(i.flush(function(){n.resolve()}),n.promise):(setTimeout(function(){n.reject()},10),n.promise)},r.exports.resetSerialPort=function(e){var r=o.defer(),n=new i(e,{baudRate:1200});return n.on("open",function(){n.set({rts:!0,dtr:!1}),setTimeout(function(){n.close(function(){r.resolve()})},650)}).on("error",function(e){t.error(e),n.close(function(){r.reject(e)})}),r.promise}},{"electron-log":void 0,path:void 0,q:void 0,serialport:void 0}],8:[function(e,r,n){function t(){u=null,d.removeFile(a(),!0)}function o(){var e=f.defer();return i(v.VERIFY,{method:"post"}).then(function(r){r.status==m.SUCCESS?e.resolve():e.reject(r.message)},function(r){r&&p.error(r),e.reject(r)}),e.promise}function i(e,r,n){if(!u)return d.rejectPromise();var t=d.getAppInfo(),o=r.headers||{};return o.Authorization="Bearer "+u.api_token,o["X-Ken-App-Version"]=t.name+"-"+t.version+"-"+t.branch+"-"+t.platform+"-"+t.appBit,r.headers=o,d.request(e,r,n)}function a(){return c.join(d.getAppDataPath(),"token")}var u,c=e("path"),s=e("crypto"),f=e("q"),l=e("fs-extra"),p=e("electron-log"),d=e("./util"),v=e("./config/url"),m=e("./config/status");r.exports.get=function(){return u},r.exports.remove=t,r.exports.verify=o,r.exports.save=function(e){var r=f.defer(),n=s.randomBytes(128);return d.writeFile(a(),d.encrypt(JSON.stringify(e),n)).then(function(){u=e,r.resolve(n.toString("hex"))},function(e){e&&p.error(e),r.reject(e)}),r.promise},r.exports.load=function(e){var r=f.defer(),n=a();return l.existsSync(n)?(d.readFile(n,"utf8").then(function(n){try{var i=d.decrypt(n,Buffer.from(e,"hex"));u=JSON.parse(i),o().then(function(){r.resolve(u)},function(e){t(),e&&p.error(e),r.reject(e)})}catch(e){r.reject()}},function(e){e&&p.error(e),r.reject(e)}),r.promise):(setTimeout(function(){r.reject()},10),r.promise)},r.exports.request=i},{"./config/status":3,"./config/url":4,"./util":9,crypto:void 0,"electron-log":void 0,"fs-extra":void 0,path:void 0,q:void 0}],9:[function(e,r,n){function t(){if(x.windows())return"win";if(x.macOS())return"mac";return l.arch().indexOf("arm")>=0?"arm":"linux"}function o(){return x.dev()?O.version:h.getVersion()}function i(){return parseInt(Date.now()/1e3)}function a(e,r){return r=r||y.defer(),setTimeout(function(){r.resolve(e)},10),r.promise}function u(e,r,n){var t=y.defer();return r=r||{},n=n||!1,P.debug("execCommand:"+e+", options: "+JSON.stringify(r)+", useSudo: "+n),n?A.exec(e,{name:"kenrobot"},function(e,r,n){if(r=r||"",n=n||"",r=x.windows()?_.decode(Buffer.from(r),"win1252"):r,n=x.windows()?_.decode(Buffer.from(n),"win1252"):n,e)return P.error(e),r&&P.error(r),n&&P.error(n),void t.reject(n||r||e);x.dev()&&r&&P.debug(r),t.resolve(r)}):p.exec(e,r,function(e,r,n){if(r=r||"",n=n||"",r=x.windows()?_.decode(Buffer.from(r),"win1252"):r,n=x.windows()?_.decode(Buffer.from(n),"win1252"):n,e)return P.error(e),r&&P.error(r),n&&P.error(n),void t.reject(n||r||e);x.dev()&&r&&P.debug(r),t.resolve(r)}),t.promise}function c(e,r,n){var t=y.defer(),o=p.spawn(e,r,n),i="",a="";return o.stdout.on("data",function(e){var r=x.windows()?_.decode(e,"win1252"):e.toString();x.dev()&&r&&P.debug(r),i+=r,t.notify({type:"stdout",data:r})}),o.stderr.on("data",function(e){var r=x.windows()?_.decode(e,"win1252"):e.toString();x.dev()&&r&&P.debug(r),a+=r,t.notify({type:"stderr",data:r})}),o.on("close",function(e){0==e?t.resolve(i):t.reject(a)}),t.promise}function s(e,r,n,t){if(!t){var o=y.defer();return w.outputFile(e,r,n,function(e){if(e)return P.error(e),void o.reject(e);o.resolve()}),o.promise}w.outputFileSync(e,r,n)}function f(e,r){var n=y.defer();return e=e||{},e.title="保存",e.defaultPath=e.defaultPath&&d.isAbsolute(e.defaultPath)?e.defaultPath:d.join(h.getPath("documents"),e.defaultPath||"untitled"),e.buttonLabel="保存",r=r||b.getAllWindows()[0],j.showSaveDialog(r,e,function(e){e?n.resolve(e):n.reject()}),n.promise}var l=e("os"),p=e("child_process"),d=e("path"),v=e("crypto"),m=e("electron"),h=m.app,g=m.ipcMain,j=m.dialog,b=m.BrowserWindow,P=e("electron-log"),x=e("electron-is"),y=e("q"),w=e("fs-extra"),S=e("glob"),A=e("sudo-prompt"),_=e("iconv-lite"),I=(e("lodash"),e("7zip-bin").path7za.replace("app.asar","app.asar.unpacked")),D=e("node-fetch"),O=e("../package"),T="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC7Jat1/19NDxOObrFpW8USTia6\nuHt34Sac1Arm6F2QUzsdUEUmvGyLIOIGcdb+F6pTdx4ftY+wZi7Aomp4k3vNqXmX\nT0mE0vpQlCmsPUcMHXuUi93XTGPxLXIv9NXxCJZXSYI0JeyuhT9/ithrYlbMlyNc\nwKB/BwSpp+Py2MTT2wIDAQAB\n-----END PUBLIC KEY-----\n";x.dev()&&h.setName(O.productName);var E={},N=0;r.exports.getPlatform=t,r.exports.getVersion=o,r.exports.getAppInfo=function(){var e={bit:"x64"===process.arch||process.env.hasOwnProperty("PROCESSOR_ARCHITEW6432")?64:32,arch:process.arch,platform:t(),version:o(),name:h.getName(),buildNumber:O.buildNumber};return x.dev()?(e.ext=d.extname(h.getPath("exe")).replace(".",""),e.branch="beta",e.feature="",e.date=i(),e.appBit=e.bit):(e.ext=O.buildInfo.ext,e.branch=O.buildInfo.branch,e.feature=O.buildInfo.feature,e.date=O.buildInfo.date,e.appBit=O.buildInfo.appBit),e},r.exports.getAppDataPath=function(){return d.join(h.getPath("appData"),h.getName())},r.exports.getAppResourcePath=function(){return x.dev()?d.resolve("."):d.resolve(h.getAppPath(),"..","..")},r.exports.getAppDocumentPath=function(){return d.join(h.getPath("documents"),h.getName())},r.exports.getAppPath=function(e){return h.getPath(e)},r.exports.versionCompare=function(e,r){for(var n=/(\d+)\.(\d+)\.(\d+)/,t=n.exec(e),o=n.exec(r),i=[parseInt(t[1]),parseInt(t[2]),parseInt(t[3])],a=[parseInt(o[1]),parseInt(o[2]),parseInt(o[3])],u=0;u<=2;u++)if(i[u]!=a[u])return i[u]>a[u]?1:-1;return 0},r.exports.postMessage=function(e){for(var r=arguments.length,n=Array(r>1?r-1:0),t=1;t<r;t++)n[t-1]=arguments[t];P.debug("postMessage: "+e+", "+n.join(", "));var o=b.getAllWindows();o&&o.length&&o[0].webContents.send(e,n)},r.exports.listenMessage=function(e,r){var n=this,t="app:"+e;g.on(t,function(e,o){for(var i=arguments.length,u=Array(i>2?i-2:0),c=2;c<i;c++)u[c-2]=arguments[c];(r.apply(n,u)||a()).then(function(r){e.sender.send(t,o,!0,r)},function(r){e.sender.send(t,o,!1,r)},function(r){e.sender.send(t,o,"notify",r)})})},r.exports.getDefer=function(){var e=y.defer(),r=N++;return E[r]=e,{deferId:r,promise:e.promise}},r.exports.callDefer=function(e,r){var n=E[e];if(n){var t;"notify"==r?t=n.notify:(delete E[e],t=r?n.resolve:n.reject);for(var o=arguments.length,i=Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];t.apply(this,i)}},r.exports.handleQuotes=function(e){return x.windows()?e:e.replace(/"/g,"")},r.exports.uuid=function(e,r){var n,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),o=[];if(r=r||t.length,e)for(n=0;n<e;n++)o[n]=t[0|Math.random()*r];else{var i;for(o[8]=o[13]=o[18]=o[23]="-",o[14]="4",n=0;n<36;n++)o[n]||(i=0|16*Math.random(),o[n]=t[19==n?3&i|8:i])}return o.join("")},r.exports.stamp=i,r.exports.throttle=function(e,r){var n;return function(){n&&clearTimeout(n),n=setTimeout(function(){e(),clearTimeout(n),n=null},r)}},r.exports.encrypt=function(e,r,n){n=n||"aes-128-cbc";var t=v.createCipher(n,r),o=t.update(e,"utf8","binary");return o+=t.final("binary"),o=new Buffer(o,"binary").toString("base64")},r.exports.decrypt=function(e,r,n){n=n||"aes-128-cbc",e=new Buffer(e,"base64").toString("binary");var t=v.createDecipher(n,r),o=t.update(e,"binary","utf8");return o+=t.final("utf8")},r.exports.rsa_encrypt=function(e,r){r=r||T;var n=new Buffer(e);return v.publicEncrypt({key:r,padding:v.constants.RSA_PKCS1_PADDING},n).toString("base64")},r.exports.rsa_decrypt=function(e,r){var n=new Buffer(e,"base64");return v.privateDecrypt({key:r,padding:v.constants.RSA_PKCS1_PADDING},n).toString("utf8")},r.exports.resolvePromise=a,r.exports.rejectPromise=function(e,r){return r=r||y.defer(),setTimeout(function(){r.reject(e)},10),r.promise},r.exports.execFile=function(e){var r=y.defer();P.debug("execFile: "+e);var n;return n=x.windows()?"start /WAIT "+e:""+e,u(n,null,!0).fin(function(){r.resolve()}),r.promise},r.exports.execCommand=u,r.exports.spawnCommand=c,r.exports.readFile=function(e,r,n){if(n)return w.readFileSync(e,r);var t=y.defer();return r=r||"utf8",w.readFile(e,r,function(e,r){if(e)return P.error(e),void t.reject(e);t.resolve(r)}),t.promise},r.exports.writeFile=s,r.exports.saveFile=function(e,r,n){var t=y.defer();return n=n||{},e&&(n.defaultPath=e),f(n).then(function(e){s(e,r,n).then(function(){t.resolve()},function(e){e&&P.error(e),t.reject(e)})},function(e){e&&P.error(e),t.reject(e)}),t.promise},r.exports.moveFile=function(e,r,n){var t=y.defer();return n=n||{overwrite:!0},w.move(e,r,n,function(e){if(e)return P.error(e),void t.reject(e);t.resolve()}),t.promise},r.exports.removeFile=function(e,r){if(!r){var n=y.defer();return w.remove(e,function(e){if(e)return P.error(e),void n.reject(e);n.resolve()}),n.promise}w.removeSync(e)},r.exports.readJson=function(e,r){var n=y.defer();return r=r||{},w.readJson(e,r,function(e,r){if(e)return P.error(e),void n.reject(e);n.resolve(r)}),n.promise},r.exports.writeJson=function(e,r,n,t){if(!t){var o=y.defer();return n=n||{},w.outputJson(e,r,n,function(e){if(e)return P.error(e),void o.reject(e);o.resolve()}),o.promise}w.outputJsonSync(e,r,n)},r.exports.searchFiles=function(e){var r=y.defer();return P.debug("searchFiles: "+e),S(e,{},function(e,n){return e?(P.error(e),void r.reject(e)):r.resolve(n)}),r.promise},r.exports.compress=function(e,r,n,t){var o=y.defer();return r=r||[r],t=t||"7z",P.debug("compress: "+e+": "+r.length+" => "+n+": "+t),u("cd "+(x.windows()?"/d ":"")+e+' && "'+I+'" a -t'+t+" -r "+n+" "+r.join(" ")).then(function(){o.resolve()},function(e){e&&P.error(e),o.reject(e)}),o.promise},r.exports.uncompress=function(e,r,n){var t=y.defer(),o=/([\d]+)% \d+ - .*\r?/g;return P.debug("uncompress: "+e+" => "+r),n?c('"'+I+'"',["x",'"'+e+'"',"-bsp1","-y",'-o"'+r+'"'],{shell:!0}).then(function(e){t.resolve(e)},function(e){e&&P.error(e),t.reject(e)},function(e){if(o.lastIndex=0,o.test(e.data)){var r,n=o.exec(e.data);do{r=n,n=o.exec(e.data)}while(n);t.notify(parseInt(r[1]))}}):u('"'+I+'" x "'+e+'" -y -o"'+r+'"').then(function(){t.resolve()},function(e){e&&P.error(e),t.reject(e)}),t.promise},r.exports.showOpenDialog=function(e,r){var n=y.defer();return e=e||{},e.title="打开",e.defaultPath=e.defaultPath||h.getPath("documents"),e.buttonLabel="打开",r=r||b.getAllWindows()[0],j.showOpenDialog(r,e,function(e){e?n.resolve(e[0]):n.reject()}),n.promise},r.exports.showSaveDialog=f,r.exports.request=function(e,r,n){var t=y.defer();if(r=r||{},n=!1!==n,r.method=r.method||"GET",n&&r.data){r.body=JSON.stringify(r.data);var o=r.headers||(r.headers={});o["Content-Type"]="application/json",o.Accept="application/json",delete r.data}return D(e,r).then(function(e){if(e.ok)return n?e.json():e;var r=new Error(e.statusText);throw r.status=e.status,r}).then(function(e){t.resolve(e)}).catch(function(e){e&&P.error(e),t.reject(e)}),t.promise}},{"../package":void 0,"7zip-bin":void 0,child_process:void 0,crypto:void 0,electron:void 0,"electron-is":void 0,"electron-log":void 0,"fs-extra":void 0,glob:void 0,"iconv-lite":void 0,lodash:void 0,"node-fetch":void 0,os:void 0,path:void 0,q:void 0,"sudo-prompt":void 0}]},{},[5]);