"use strict";var _slicedToArray=function(){return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,r){var t=[],n=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(n=(a=u.next()).done)&&(t.push(a.value),!r||t.length!==r);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw i}}return t}(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();!function e(r,t,n){function o(a,u){if(!t[a]){if(!r[a]){var c="function"==typeof require&&require;if(!u&&c)return c(a,!0);if(i)return i(a,!0);var s=new Error("Cannot find module '"+a+"'");throw s.code="MODULE_NOT_FOUND",s}var f=t[a]={exports:{}};r[a][0].call(f.exports,function(e){var t=r[a][1][e];return o(t||e)},f,f.exports,e,r,t,n)}return t[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}({1:[function(e,r,t){r.exports={default:{build:{fqbn:"arduino:avr:uno:cpu=atmega328p",prefs:{"runtime.tools.avr-gcc.path":'"ARDUINO_PATH/hardware/tools/avr"',"runtime.tools.avrdude.path":'"ARDUINO_PATH/hardware/tools/avr"',"build.warn_data_percentage":"75"},command:'"ARDUINO_PATH/arduino-builder" -compile -logger=machine -hardware="ARDUINO_PATH/hardware" -hardware="ARDUINO_PATH/packages" -tools="ARDUINO_PATH/tools-builder" -tools="ARDUINO_PATH/hardware/tools/avr" -tools="ARDUINO_PATH/packages" -built-in-libraries="ARDUINO_PATH/libraries" -ide-version=10612 -warnings=none BUILD_SPECS -build-path="PROJECT_BUILD_PATH" "PROJECT_ARDUINO_FILE"'},upload:{target_type:"hex",mcu:"atmega328p",baudrate:"115200",programer:"arduino",command:'"ARDUINO_PATH/hardware/tools/avr/bin/avrdude" -C "ARDUINO_PATH/hardware/tools/avr/etc/avrdude.conf" -v -p ARDUINO_MCU -c ARDUINO_PROGRAMMER -b ARDUINO_BURNRATE -P ARDUINO_COMPORT -D -U "flash:w:TARGET_PATH:i"'}},librariesPath:[]}},{}],2:[function(e,r,t){r.exports={UperEnergy:100,Intel:101,KenBlock:102}},{}],3:[function(e,r,t){r.exports={SUCCESS:0,INVALID_PARAM:1,SYSTEM_ERROR:100,LOGIN_REQUIRED:200,PERMISSION_DENIED:201,INVALID_USER_TOKEN_SIGN:202,USER_TOKEN_EXPIRED:203,USER_NOT_EXITS:204,API_ERROR:300,INVALID_SSO_TICKET:301,INVALID_SSO_SESSION:302,INVALID_SSO_BROKER:303,INVLAID_SSO_SIGN:304}},{}],4:[function(e,r,t){r.exports={CHECK_UPDATE:"http://www.kenrobot.com/?app=api&mod=Download&act=checkupdate",REPORT:"http://userver.kenrobot.com/statistics/report",REGISTER:"http://server.kenrobot.com/register",FIND_PASSWORD:"http://server.kenrobot.com/password/email",LOGIN:"http://server.kenrobot.com/api/auth/login",LOGOUT:"http://server.kenrobot.com/api/auth/logout",WEIXIN_QRCODE:"http://server.kenrobot.com/api/auth/weixin/token",WEIXIN_LOGIN:"http://server.kenrobot.com/api/auth/weixin/login",VERIFY:"http://server.kenrobot.com/api/auth/verify",PROJECT_SYNC_LIST:"http://server.kenrobot.com/api/project/sync/list",PROJECT_SYNC_CREATE:"http://server.kenrobot.com/api/project/sync/create",PROJECT_SYNC_DELETE:"http://server.kenrobot.com/api/project/sync/delete",PROJECT_SYNC_UPLOAD:"http://server.kenrobot.com/api/project/sync/upload",PROJECT_SYNC_DOWNLOAD:"http://server.kenrobot.com/api/project/sync/download",PROJECT_SYNC_ITEM:"http://server.kenrobot.com/api/project/sync/item"}},{}],5:[function(e,r,t){function n(){F.debug("app ready"),C.dev()&&Z.devTool&&U({showDevTools:!0}),Z.project&&(I=Z.project),function(){var e=q.defer();F.debug("loadConfig");var r=R.join(z.getAppPath("appData"),"config.json");if(!L.existsSync(r))return setTimeout(function(){e.resolve({})},10),e.promise;return z.readJson(r).then(function(r){e.resolve(r)},function(r){e.resolve({})}),e.promise}().then(function(e){w=e,o(),g(),function(){if(C.dev()||w.version==z.getVersion())return;w.version=z.getVersion(),w.reportInstall=!1,A=!0,s(!0)}(),function(){C.dev()||w.reportInstall||c(null,"installations").then(function(){w.reportInstall=!0,s()});c(null,"open")}()})}function o(){S=new E({width:1200,height:720,minWidth:1200,minHeight:720,frame:!1,show:!1,webPreferences:{webSecurity:!1}}),Z.fullscreen?S.setFullScreen(!0):Z.maximize&&S.maximize(),S.on("closed",function(){return S=null}).once("ready-to-show",function(){return S.show()}).on("enter-full-screen",function(){return z.postMessage("app:onFullscreenChange",!0)}).on("leave-full-screen",function(){return z.postMessage("app:onFullscreenChange",!1)}),S.webContents.on("will-navigate",function(e){return e.preventDefault()}).on("devtools-reload-page",function(){return G.closeAllSerialPort()}),S.webContents.session.on("will-download",l),S.loadURL("file://"+__dirname+"/../renderer/index.html"),S.focus()}function i(e,r){e.preventDefault(),I=V.check(r),_&&j().then(function(e){z.postMessage("app:onLoadProject",e)},function(e){e&&F.error(e)})}function a(e){e.preventDefault(),z.postMessage("app:onBeforeQuit")}function u(e){return G.closeAllSerialPort(),z.removeFile(R.join(z.getAppPath("appData"),"temp"),!0),!0}function c(e,r){var t=q.defer(),n=z.getAppInfo(),o={version:n.version,platform:n.platform,bit:n.appBit,ext:n.ext,branch:n.branch,feature:n.feature};return e=M.merge({},e,o),r=r||"log",z.request(K.REPORT,{method:"post",data:{data:JSON.stringify(e),type:r}}).then(function(){t.resolve()},function(n){F.error("report error: type: "+r+", "+JSON.stringify(e)),n&&F.error(n),t.reject(n)}),t.promise}function s(e){var r=R.join(z.getAppPath("appData"),"config.json");return z.writeJson(r,w,null,e)}function f(e){var r=q.defer();return e=0!=e,Y.load(e).then(function(e){e.forEach(function(e){var r=R.join(Y.getPackagesPath(),e.name,"src");L.existsSync(r)&&!H.librariesPath.includes(r)&&H.librariesPath.push(r)}),r.resolve(e)},function(e){e&&F.error(e),r.reject(e)}),r.promise}function l(e,r,t){var n=r.getURL(),o=n.lastIndexOf("#"),i=k.parse(n.substring(o+1));n=n.substring(0,o);var a=i.deferId,u=R.join(z.getAppPath("appData"),"download",r.getFilename());if(i.checksum&&L.existsSync(u)){o=i.checksum.indexOf(":");var c=i.checksum.substring(0,o).replace("-","").toLowerCase();if(i.checksum.substring(o+1)==J.fromFileSync(u,{algorithm:c}))return r.cancel(),F.debug("download cancel, "+n+" has cache"),void z.callDefer(a,!0,{path:u})}r.setSavePath(u);var s=r.getTotalBytes();r.on("updated",function(e,t){"interrupted"==t?(F.debug("download interrupted: "+n),z.callDefer(a,!1,{path:u})):"progressing"===t&&(r.isPaused()?(F.debug("download paused: "+n),z.callDefer(a,!1,{path:u})):z.callDefer(a,"notify",{path:u,totalSize:s,size:r.getReceivedBytes()}))}),r.once("done",function(e,r){"completed"==r?(F.debug("download success: "+n+", at "+u),z.callDefer(a,!0,{path:u})):(F.debug("download fail: "+n),z.callDefer(a,!1,{path:u}))})}function p(e,r){z.postMessage("app:onSerialPortError",e,r)}function d(e,r){z.postMessage("app:onSerialPortData",e,r)}function v(e){z.postMessage("app:onSerialPortClose",e)}function m(){var e=q.defer();return G.listSerialPort().then(function(r){0!=(r=function(e){var r=/(COM\d+)|(usb-serial)|(arduino)|(\/dev\/cu\.usbmodem)|(\/dev\/tty\.)|(\/dev\/(ttyUSB|ttyACM|ttyAMA))/;return e.filter(function(e){return r.test(e.comName)})}(r)).length?function(e){var r=q.defer();return F.debug("matchBoardNames"),g().then(function(t){e.forEach(function(e){if(e.productId&&e.vendorId){var r=w.boardNames[e.productId+"_"+e.vendorId];r&&(e.boardName=r.name)}}),r.resolve(e)},function(e){e&&F.error(e),r.reject(e)}),r.promise}(r).then(function(){F.debug(r.map(function(e){return e.comName+", pid: "+e.productId+", vid: "+e.vendorId+", boardName: "+(e.boardName||"")}).join("\n")),e.resolve(r)},function(r){r&&F.error(r),e.reject(r)}):e.reject()},function(r){r&&F.error(r),e.reject(r)}),e.promise}function h(e,r,t){var n=q.defer();return function(e,r,t){var n=q.defer();F.debug("pre upload firmware"),t=M.merge({},H.default.upload,t);var o=P("upload"),i=z.handleQuotes(t.command);return i=i.replace(/ARDUINO_PATH/g,x()).replace("ARDUINO_MCU",t.mcu).replace("ARDUINO_BURNRATE",t.baudrate).replace("ARDUINO_PROGRAMMER",t.programer).replace("ARDUINO_COMPORT",r).replace("TARGET_PATH",e),z.writeFile(o,i).then(function(){G.resetSerialPort(r).then(function(){n.resolve(o)},function(e){e&&F.error(e),n.reject(e)})},function(e){e&&F.error(e),n.reject(e)}),n.promise}(e,r,t).then(function(t){F.debug("upload firmware: "+e+", "+r+", command path: "+t);var o=b("call");z.spawnCommand('"'+o+'"',['"'+t+'"'],{shell:!0}).then(function(){n.resolve()},function(e){e&&F.error(e),n.reject(e)},function(e){n.notify(e)})},function(e){e&&F.error(e),n.reject(e)}),n.promise}function g(e){var r=q.defer();if(w.boardNames&&!e)return F.debug("skip loadBoards"),setTimeout(function(){r.resolve(w.boardNames)},10),r.promise;F.debug("loadBoards");var t={},n=/\n(([^\.\n]+)\.pid(\.\d)?)=([^\r\n]+)/g,o=/\n(([^\.\n]+)\.vid(\.\d)?)=([^\r\n]+)/g,i=/\n([^\.\n]+)\.name=([^\r\n]+)/g,a="arduino-"+z.getPlatform();return z.searchFiles(a+"/**/boards.txt").then(function(e){q.all(e.map(function(e){var r=q.defer();return z.readFile(e).then(function(e){var r=e.match(n),a=e.match(o),u=[];e.match(i).forEach(function(e){var r=e.substring(0,e.indexOf(".name")).trim(),t=e.substring(e.indexOf("=")+1).trim();u[r]=t});var c=r.map(function(e){return e.substring(0,e.indexOf(".pid")).trim()});r=r.map(function(e){return e.substring(e.indexOf("=")+3)}),a=a.map(function(e){return e.substring(e.indexOf("=")+3)}),r.forEach(function(e,r){t[e+"_"+a[r]]={pid:e,vid:a[r],type:c[r],name:u[c[r]]}})}).fin(function(){r.resolve()}),r.promise})).then(function(){w.boardNames=t,s().then(function(){r.resolve(w.boardNames)},function(e){e&&F.error(e),r.reject(e)})})},function(e){e&&F.error(e),r.reject(e)}),r.promise}function j(){if(_=!0,I){F.debug("loadProject: "+I);var e=I;return I=null,V.read(e)}return z.rejectPromise()}function b(e){var r=C.windows()?"bat":"sh";return R.join(z.getAppPath("appResource"),"scripts",e+"."+r)}function P(e){return R.join(z.getAppPath("appData"),"temp",e+".txt")}function x(){return R.join(z.getAppPath("appResource"),"arduino-"+z.getPlatform())}function y(){return R.join(z.getAppPath("documents"),D.getName(),"libraries")}var w,S,A,I,_,O=e("electron"),D=O.app,E=O.BrowserWindow,T=(O.ipcMain,O.shell),N=O.clipboard,R=e("path"),k=e("querystring"),C=e("electron-is"),U=e("electron-debug"),F=e("electron-log"),q=e("q"),L=e("fs-extra"),B=e("command-line-args"),J=e("hasha"),M=e("lodash"),z=e("./util/util"),G=e("./model/serialPort"),H=e("./config/arduinoOptions"),K=e("./config/url"),V=(e("./model/token"),e("./model/project")),W=e("./model/user"),Y=e("./model/package"),Q=z.listenMessage,X=[{name:"debug-brk",type:Number,defaultValue:!1},{name:"dev",alias:"d",type:Boolean,defaultValue:!1},{name:"devTool",alias:"t",type:Boolean,defaultValue:!1},{name:"fullscreen",alias:"f",type:Boolean,defaultValue:!1},{name:"maximize",alias:"m",type:Boolean,defaultValue:!1},{name:"project",alias:"p",type:V.check,defaultOption:!0}],Z=B(X,{argv:process.argv.slice(1),partial:!0});process.on("uncaughtException",function(e){var r=e.stack||e.name+": "+e.message;F.error(r),D.quit()}),F.transports.file.format="[{y}-{m}-{d} {h}:{i}:{s}] [{level}] {text}",C.dev()&&Z.dev?F.transports.file.level="debug":(F.transports.console=!1,F.transports.file.level="error"),D.makeSingleInstance(function(e,r){if(S){S.isMinimized()&&S.restore(),S.focus();var t=B(X,{argv:e.slice(1),partial:!0});t.project&&(I=t.project),F.debug("app second run"),j().then(function(e){z.postMessage("app:onLoadProject",e)},function(e){e&&F.error(e)})}})&&D.quit(),D.on("ready",n).on("window-all-closed",function(){return"darwin"!==process.platform&&D.quit()}).on("activate",function(){return null===S&&o()}).on("before-quit",a).on("will-quit",u).on("quit",function(){return F.debug("app quit")}),C.macOS()&&D.on("open-file",i),Q("getAppInfo",function(){return z.resolvePromise(z.getAppInfo())}),Q("loadSetting",function(){return z.resolvePromise(w.setting||{})}),Q("saveSetting",function(e){return function(e){return w.setting=e,s()}(e)}),Q("execFile",function(e){return z.execFile(e)}),Q("execCommand",function(e,r){return z.execCommand(e,r)}),Q("spawnCommand",function(e,r,t){return z.spawnCommand(e,r,t)}),Q("readFile",function(e,r){return z.readFile(e,r)}),Q("writeFile",function(e,r){return z.writeFile(e,r)}),Q("saveFile",function(e,r,t){return z.saveFile(e,r,t)}),Q("moveFile",function(e,r,t){return z.moveFile(e,r,t)}),Q("removeFile",function(e){return z.removeFile(e)}),Q("readJson",function(e,r){return z.readJson(e,r)}),Q("writeJson",function(e,r,t,n){return z.writeJson(e,r,t,n)}),Q("showOpenDialog",function(e){return z.showOpenDialog(e)}),Q("showSaveDialog",function(e){return z.showSaveDialog(e)}),Q("request",function(e,r,t){return z.request(e,r,t)}),Q("showItemInFolder",function(e){return T.showItemInFolder(R.normalize(e))}),Q("openUrl",function(e){return z.resolvePromise(e&&T.openExternal(e))}),Q("listSerialPort",function(){return m()}),Q("openSerialPort",function(e,r){return function(e,r){return G.openSerialPort(e,r,{onError:p,onData:d,onClose:v})}(e,r)}),Q("writeSerialPort",function(e,r){return G.writeSerialPort(e,r)}),Q("closeSerialPort",function(e){return G.closeSerialPort(e)}),Q("updateSerialPort",function(e,r){return G.updateSerialPort(e,r)}),Q("flushSerialPort",function(e){return G.flushSerialPort(e)}),Q("buildProject",function(e,r){return function(e,r){var t=q.defer();return function(e,r){var t=q.defer();F.debug("pre-build");var n=R.join(e,"cache"),o=R.join(n,"build");return L.ensureDirSync(o),z.removeFile(R.join(o,"sketch","build"),!0),z.removeFile(R.join(e,"build"),!0),V.read(e).then(function(e){var i=e.data,a=R.join(n,i.project_name+".ino");z.writeFile(a,i.project_data.code).then(function(){var e=[];r=M.merge({},H.default.build,r);var n=Y.getPackagesPath();L.existsSync(n)&&e.push("-hardware="+n),e.push("-fqbn="+r.fqbn);var i=x();Object.keys(r.prefs).forEach(function(t){var n=z.handleQuotes(r.prefs[t]);n=n.replace(/ARDUINO_PATH/g,i),e.push("-prefs="+t+"="+n)});var u=y();L.existsSync(u)&&e.push('-libraries="'+u+'"'),H.librariesPath.forEach(function(r){e.push('-libraries="'+r+'"')});var c=P("build"),s=z.handleQuotes(r.command);s=s.replace(/ARDUINO_PATH/g,x()).replace("BUILD_SPECS",e.join(" ")).replace("PROJECT_BUILD_PATH",o).replace("PROJECT_ARDUINO_FILE",a),z.writeFile(c,s).then(function(){var e=R.join(o,"build.options.json");if(!L.existsSync(e))return setTimeout(function(){t.resolve(c)},10),t.promise;z.readJson(e).then(function(e){r.fqbn!=e.fqbn?z.removeFile(o).fin(function(){L.ensureDirSync(o),t.resolve(c)}):t.resolve(c)},function(e){e&&F.error(e),t.resolve(c)})},function(e){e&&F.error(e),t.reject()})},function(e){e&&F.error(e),t.reject()})},function(e){e&&F.error(e),t.reject()}),t.promise}(e,r).then(function(r){F.debug("buildProject: "+e+", command path: "+r);var n=b("call");z.spawnCommand('"'+n+'"',['"'+r+'"'],{shell:!0}).then(function(){t.resolve()},function(e){e&&F.error(e),t.reject(e)},function(e){t.notify(e)})},function(e){e&&F.error(e),t.reject(e)}),t.promise}(e,r)}),Q("upload",function(e,r){return function(e,r){return r=M.merge({},H.default.upload,r),function(e,r){var t=q.defer();return m().then(function(n){1==n.length?h(e,n[0].comName,r).then(function(e){t.resolve(e)},function(e){t.reject(e)},function(e){t.notify(e)}):t.reject({status:"SELECT_PORT",ports:n})},function(){t.reject({status:"NOT_FOUND_PORT"})}),t.promise}(R.join(e,"cache","build",R.basename(e)+".ino."+r.target_type),r)}(e,r)}),Q("upload2",function(e,r,t){return function(e,r,t){return t=M.merge({},H.default.upload,t),h(R.join(e,"cache","build",R.basename(e)+".ino."+t.target_type),r,t)}(e,r,t)}),Q("download",function(e,r){return function(e,r){var t=q.defer(),n=z.getDefer(),o=n.deferId,i=n.promise;r.deferId=o;var a=k.stringify(r);return F.debug("download "+e+", options: "+a),i.then(function(e){t.resolve(e)},function(e){e&&F.error(e),t.reject(e)},function(e){t.notify(e)}),S.webContents.downloadURL(e+"#"+a),t.promise}(e,r)}),Q("installDriver",function(e){return function(e){var r=q.defer();F.debug("installDriver: "+e);var t=R.join(z.getAppPath("appData"),"temp");return z.uncompress(e,t).then(function(){var n=R.join(t,R.basename(e,R.extname(e)),"setup.exe");z.execFile(n).then(function(){r.resolve()})},function(e){e&&F.error(e),r.reject(e)}),r.promise}(e)}),Q("loadExamples",function(){return function(){var e=q.defer(),r=[];return F.debug("loadExamples"),z.readJson(R.join(z.getAppPath("appResource"),"examples","examples.json")).then(function(t){r.push({name:"built-in",groups:t});var n=Y.getPackagesPath();z.searchFiles(n+"/*/examples/examples.json").then(function(t){q.all(t.map(function(e){var t=q.defer();return z.readJson(e).then(function(t){r.push({name:R.basename(R.dirname(R.dirname(e))),groups:t})}).fin(function(){t.resolve()}),t.promise})).then(function(){e.resolve(r)})},function(r){r&&F.error(r),e.reject(r)})},function(r){r&&F.error(r),e.reject(r)}),e.promise}()}),Q("openExample",function(e,r,t){return function(e,r,t){var n,o=q.defer();return n="built-in"==(t=t||"built-in")?R.join(z.getAppPath("appResource"),"examples",e,r):R.join(Y.getPackagesPath(),t,"examples",e,r),F.debug("openExample: "+n),V.read(n).then(function(e){o.resolve(e)},function(e){e&&F.error(e),o.reject(e)}),o.promise}(e,r,t)}),Q("unzipPackage",function(e){return Y.unzip(e)}),Q("deletePackage",function(e){return Y.remove(e)}),Q("unzipPackages",function(e){return function(e){var r=q.defer();return e=!1===e&&C.dev(),Y.unzipAll(w.packages,e,A).then(function(e){C.dev()?r.resolve():(w.packages=e,s().fin(function(){return r.resolve()}))},function(e){e&&F.error(e),r.reject(e)},function(e){return r.notify(e)}),r.promise}(e)}),Q("loadPackages",function(e){return f(e)}),Q("getInstalledLibraries",function(){return function(){var e=q.defer(),r=/^([^=]+)=(.*)$/gm;return z.searchFiles(y()+"/**/library.properties").then(function(t){var n=[];q.all(t.map(function(e){var t=q.defer();return z.readFile(e).then(function(e){var t=e.match(r);if(!(t.length<0)){var o={};t.map(function(e){return e.split("=")}).forEach(function(e){o[e[0]]=e[1]}),o.name&&o.version&&n.push(o)}}).fin(function(){t.resolve()}),t.promise})).then(function(){e.resolve(n)})},function(r){r&&F.error(r),e.reject(r)}),e.promise}()}),Q("loadLibraries",function(){return function(){var e=q.defer();return z.readJson(R.join(z.getAppPath("appResource"),"libraries","libraries.json")).then(function(r){e.resolve(r.libraries)},function(r){r&&F.error(r),e.reject(r)}),e.promise}()}),Q("unzipLibrary",function(e,r){return function(e,r){var t=q.defer(),n=y(),o=R.basename(r,R.extname(r));return z.uncompress(r,n,!0).then(function(){z.moveFile(R.join(n,o),R.join(n,e)).then(function(){t.resolve()},function(e){e&&F.error(e),t.reject(e)})},function(e){e&&F.error(e),t.reject(e)},function(e){t.notify(e)}),t.promise}(e,r)}),Q("deleteLibrary",function(e){return function(e){var r=q.defer();return F.debug("deleteLibrary: "+e),z.removeFile(R.join(y(),e)).then(function(){r.resolve()},function(e){e&&F.error(e),r.reject(e)}),r.promise}(e)}),Q("checkUpdate",function(e){return function(){var e=q.defer(),r=z.getAppInfo(),t=K.CHECK_UPDATE+"&appname="+r.name+"&release_version="+r.branch+"&version="+r.version+"&platform="+r.platform+"&arch="+r.arch+"&ext="+r.ext+"&features="+r.feature;return F.debug("checkUpdate: "+t),z.request(t).then(function(r){e.resolve(r)},function(r){r&&F.error(r),e.reject(r)}),e.promise}()}),Q("checkPackageLibraryUpdate",function(e){return function(e){var r=q.defer();return q.all([f(!1),z.request(e)]).then(function(e){var t=e[0],n=e[1],o=[];t.forEach(function(e){var r=n.find(function(r){return r.name==e.name&&z.versionCompare(r.version,e.version)>0});r&&o.push(r)});var i=0;o.length>0&&(i=1),r.resolve({status:i})},function(e){e&&F.error(e),r.reject(e)}),r.promise}(e)}),Q("removeOldVersions",function(e){return function(e){var r=q.defer();if(C.dev())return setTimeout(function(){r.resolve()},10),r.promise;var t=z.getAppInfo(),n=R.join(z.getAppPath("appData"),"download");return z.searchFiles(n+"/"+t.name+"-*."+t.ext).then(function(t){var o=/\d+\.\d+\.\d+/;t.map(function(e){return R.basename(e)}).filter(function(r){var t=r.match(o);return!!t&&z.versionCompare(t[0],e)<0}).forEach(function(e){z.removeFile(R.join(n,e),!0)}),r.resolve()},function(e){e&&F.error(e),r.reject(e)}),r.promise}(e)}),Q("reportToServer",function(e,r){return c(e,r)}),Q("loadToken",function(){return W.loadToken()}),Q("login",function(e,r){return W.login(e,r)}),Q("logout",function(){return W.logout()}),Q("weixinLogin",function(e){return W.weixinLogin(e)}),Q("weixinQrcode",function(){return W.weixinQrcode()}),Q("register",function(e){return W.register(e)}),Q("resetPassword",function(e){return W.resetPassword(e)}),Q("projectLoad",function(){return j()}),Q("projectRead",function(e){return V.read(e)}),Q("projectOpen",function(e){return V.open(e)}),Q("projectSave",function(e,r,t){return V.save(e,r,t)}),Q("projectSaveAs",function(e,r,t){return V.saveAs(e,r,t)}),Q("projectSync",function(){return V.sync()}),Q("projectList",function(){return V.list()}),C.dev()&&(Q("projectCreate",function(e){return V.create(e)}),Q("projectUpload",function(e,r){return V.upload(e,r)}),Q("projectDelete",function(e,r){return V.remove(e,r)}),Q("projectDownload",function(e,r){return V.download(e,r)})),Q("log",function(e,r){return(F[r]||F.debug).bind(F).call(e)}),Q("copy",function(e,r){return N.writeText(e,r)}),Q("quit",function(){return D.quit()}),Q("exit",function(){return u()&&D.exit(0)}),Q("reload",function(){return S.reload()}),Q("relaunch",function(){return D.relaunch({args:process.argv.slice(1).concat(["--relaunch"])}),void D.exit(0)}),Q("fullscreen",function(){return S.setFullScreen(!S.isFullScreen())}),Q("min",function(){return S.minimize()}),Q("max",function(){S.isFullScreen()?S.setFullScreen(!1):S.isMaximized()?S.unmaximize():S.maximize()}),Q("errorReport",function(e){return function(e){F.error("------ error message ------"),F.error(e.message+"("+e.src+" at line "+e.line+":"+e.col+")"),F.error(""+e.stack)}(e)}),F.debug("app "+D.getName()+" start, version "+z.getVersion())},{"./config/arduinoOptions":1,"./config/url":4,"./model/package":6,"./model/project":7,"./model/serialPort":8,"./model/token":9,"./model/user":10,"./util/util":12,"command-line-args":void 0,electron:void 0,"electron-debug":void 0,"electron-is":void 0,"electron-log":void 0,"fs-extra":void 0,hasha:void 0,lodash:void 0,path:void 0,q:void 0,querystring:void 0}],6:[function(e,r,t){function n(){return o.join(s.getAppPath("appDocuments"),"packages")}var o=e("path"),i=e("fs-extra"),a=e("q"),u=e("electron-log"),c=e("electron-is"),s=e("../util/util"),f=e("../config/packageOrders");r.exports.unzip=function(e){var r=a.defer();return s.uncompress(e,n(),!0).then(function(){var t=o.basename(e);t=t.substring(0,t.indexOf("-"));var i=c.windows()?"bat":"sh";s.searchFiles(o.join(n(),t)+"/**/post_install."+i).then(function(e){if(0!=e.length){var t=e[0];s.execCommand('"'+t+'"',{cwd:o.dirname(t)}).then(function(){r.resolve()},function(e){e&&u.error(e),r.reject(e)})}else r.resolve()},function(e){e&&u.error(e),r.reject(e)})},function(e){e&&u.error(e),r.reject(e)},function(e){r.notify(e)}),r.promise},r.exports.unzipAll=function(e,r,t){var c=a.defer();if(e=e||[],r)return u.debug("skip unzip packages"),setTimeout(function(){return c.resolve()},10),c.promise;u.debug("unzip packages");var f=o.join(s.getAppPath("appResource"),"packages");return s.readJson(o.join(f,"packages.json")).then(function(r){var a=r.filter(function(r){return!!t||!!e.find(function(e){return e.name==r.name&&e.checksum!=r.checksum})||!i.existsSync(o.join(n(),r.name,"package.json"))}),u=a.length;!function r(){if(0!=a.length){var t=a.pop();s.uncompress(o.join(f,t.archiveName),n(),!0).then(function(){var r=e.findIndex(function(e){return e.name==t.name});r>=0?e.splice(r,1,t):e.push(t)},function(e){},function(e){c.notify({progress:e,name:t.name,version:t.version,count:u-a.length,total:u})}).fin(function(){return r()})}else c.resolve(e)}()},function(e){e&&u.error(e),c.resolve()}),c.promise},r.exports.load=function(e){var r=a.defer();e=!1!==e;var t=[],i=n();return u.debug("loadPackages: "+i),s.searchFiles(i+"/*/package.json").then(function(n){a.all(n.map(function(r){var n=a.defer();return e?s.readJson(r).then(function(e){e.order=f[e.name]||0,e.path=o.dirname(r),e.protocol=i.startsWith("/")?"file://":"file:///",e.boards&&e.boards.forEach(function(r){r.build&&r.build.prefs&&Object.keys(r.build.prefs).forEach(function(t){r.build.prefs[t]=r.build.prefs[t].replace("PACKAGE_PATH",e.path)}),r.upload&&r.upload.command&&(r.upload.command=r.upload.command.replace(/PACKAGE_PATH/g,e.path))}),t.push(e)}).fin(function(){n.resolve()}):s.readJson(r).then(function(e){return t.push(e)}).fin(function(){return n.resolve()}),n.promise})).then(function(){r.resolve(t)})},function(e){e&&u.error(e),r.reject(e)}),r.promise},r.exports.remove=function(e){var r=a.defer();return u.debug("deletePackage: "+e),s.removeFile(o.join(n(),e)).then(function(){r.resolve()},function(e){e&&u.error(e),r.reject(e)}),r.promise},r.exports.getPackagesPath=n},{"../config/packageOrders":2,"../util/util":12,"electron-is":void 0,"electron-log":void 0,"fs-extra":void 0,path:void 0,q:void 0}],7:[function(e,r,t){function n(e){return j.extname(e)==I&&b.existsSync(e)?e:null}function o(e,r){var t,o=P.defer();if(n(e))t=e;else{var i=j.basename(e);if(t=j.join(e,i+I),b.existsSync(t)||(t=j.join(e,"project.json")),!b.existsSync(t))return w.rejectPromise(null,o)}return w.readJson(t).then(function(e){o.resolve({path:j.dirname(t),project_type:r||e.project_type,data:e})},function(e){e&&y.error(e),o.reject(e)}),o.promise}function i(e,r,t,n){var o=P.defer(),i=function(e,t){l(e,t,r).then(function(){o.resolve({project_name:r.project_name,project_type:r.project_type,updated_at:r.updated_at,path:e})},function(e){e&&y.error(e),o.reject(e)})};return t?(n=j.join(w.getAppPath("temp"),"build","sketch_"+w.stamp()),i(n,j.basename(n))):n?i(j.join(j.dirname(n),e),e):w.showSaveDialog({defaultPath:function(){var e=new Date,r=O[e.getMonth()],t=(100+e.getDate()).toString().substring(1),n=(D++,String.fromCharCode(D<=122?D:D=97));return"sketch_"+r+t+n}()}).then(function(e){i(e,j.basename(e))},function(e){e&&y.error(e),o.reject(e)}),o.promise}function a(){var e=P.defer();return y.debug("project sync"),P.all([u(),p()]).then(function(r){var t=_slicedToArray(r,2);(function(e,r){var t=P.defer(),o=function(e,r){var t={},o={};e.forEach(function(e){t[""+e.name]=e}),r.forEach(function(e){o[""+e.name]=e});var i=[],a=[],u=[];return e.forEach(function(e){var r=o[e.name];!r||!r.modify_time||r.modify_time<e.modify_time?i.push(e):n(j.join(h(),e.name,e.name+I))||i.push(e)}),r.forEach(function(e){var r=t[e.name];r?r.modify_time<e.modify_time&&a.push(e):(u.push(e),a.push(e))}),[u,i,a]}(e,r),i=_slicedToArray(o,3),a=i[0],u=i[1],l=i[2];y.debug("doSync: createList:"+a.length+", downloadList:"+u.length+", uploadList:"+l.length);var p=a.length+u.length+l.length,d=0,v=function(e,r){d++,t.notify({total:p,count:d,name:e,action:r})};return function(e,r){var t,n=P.defer();return(t=function(){if(0==e.length)return w.resolvePromise(!0,n);var o=e.shift();f(o.name,o.hash).then(function(){r(o.name,"download"),0==e.length?n.resolve():setTimeout(function(){return t()},100)},function(e){e&&y.error(e),n.reject(e)})})(),n.promise}(u,v).then(function(){(function(e,r){var t,n=P.defer();return(t=function(){if(0==e.length)return w.resolvePromise(!0,n);var o=e.shift();c(o.name).then(function(i){o.hash=i.hash,r(o.name,"create"),0==e.length?n.resolve():setTimeout(function(){return t()},100)},function(e){e&&y.error(e),n.reject(e)})})(),n.promise})(a,v).then(function(){(function(e,r){var t,n=P.defer();return(t=function(){if(0==e.length)return w.resolvePromise(!0,n);var o=e.shift();s(o.name,o.hash).then(function(){r(o.name,"upload"),0==e.length?n.resolve():setTimeout(function(){return t()},100)},function(e){e&&y.error(e),n.reject(e)})})(),n.promise})(l,v).then(function(){t.resolve()},function(e){e&&y.error(e),t.reject(e)})},function(e){e&&y.error(e),t.reject(e)})},function(e){e&&y.error(e),t.reject(e)}),t.promise})(t[0],t[1]).then(function(){y.debug("project sync success"),e.resolve()},function(r){y.debug("project sync fail"),r&&y.error(r),e.reject(r)},function(r){e.notify(r)})},function(r){r&&y.error(r),e.reject(r)}),e.promise}function u(){var e=P.defer();return y.debug("project list"),S.request(A.PROJECT_SYNC_LIST,{method:"post"}).then(function(r){0==r.status?e.resolve(r.data):e.reject(r.message)},function(r){r&&y.error(r),e.reject(r)}),e.promise}function c(e){var r=P.defer();return y.debug("project create: "+e),S.request(A.PROJECT_SYNC_CREATE,{method:"post",data:{name:e,type:_}}).then(function(t){if(0==t.status){var n=t.data;v(n.name,n.modify_time,n.hash).then(function(){y.debug("project create success: "+e+" "+n.hash),r.resolve(n)},function(e){e&&y.error(e),r.reject(e)})}else r.reject(t.message)},function(e){e&&y.error(e),r.reject(e)}),r.promise}function s(e,r){var t=P.defer();return y.debug("project upload: "+e+": "+r),function(e,r){var t=P.defer(),n=j.join(w.getAppPath("appData"),"temp",w.uuid(6)+".7z"),o=[r+"/"+r+I];return w.compress(e,o,n).then(function(){t.resolve(n)},function(e){e&&y.error(e),t.reject(e)}),t.promise}(h(),e).then(function(n){var o=A.PROJECT_SYNC_UPLOAD+"/"+r;S.request(o,{method:"post",body:b.createReadStream(n)}).then(function(n){if(0==n.status){var o=n.data;v(e,o.modify_time,r).then(function(){y.debug("project upload success: "+e),t.resolve(o)},function(e){e&&y.error(e),t.reject(e)})}else t.reject(n.message)},function(e){e&&y.error(e),t.reject(e)})},function(e){e&&y.error(e),t.reject(e)}),t.promise}function f(e,r){var t=P.defer();y.debug("project download: "+r);var n=A.PROJECT_SYNC_DOWNLOAD+"/"+r;return S.request(n,{method:"post"},!1).then(function(n){var o=j.join(w.getAppPath("appData"),"temp",w.uuid(6)+".7z");b.ensureDirSync(j.dirname(o));var i=b.createWriteStream(o);n.body.pipe(i),n.body.on("end",function(){w.uncompress(o,h()).then(function(){v(e,null,r).then(function(){y.debug("project download success: "+e),t.resolve()},function(e){e&&y.error(e),t.reject(e)})},function(e){e&&y.error(e),t.reject(e)})}).on("error",function(e){e&&y.error(e),t.reject(e)})},function(e){e&&y.error(e),t.reject(e)}),t.promise}function l(e,r,t,n){t.project_name=r,t.project_type=n||"local",t.updated_at=new Date;var o=j.join(e,r+I);return y.debug("project save: "+o),P.all([w.writeJson(o,t),w.removeFile(j.join(e,r+".ino")),w.removeFile(j.join(e,"project.json"))])}function p(){var e=P.defer();if(!S.getUser())return w.rejectPromise(null,e);var r=m();return b.existsSync(r)?w.readJson(r):w.resolvePromise([],e)}function d(e){return S.getUser()?w.writeJson(m(),e):w.rejectPromise()}function v(e,r,t){var n=P.defer();return r=r||w.stamp(),p().then(function(o){var i=o.find(function(r){return t&&r.hash==t||r.name==e});i?(e&&(i.name=e),t&&(i.hash=t),i.modify_time=r):o.push({name:e,hash:t,modify_time:r}),d(o).then(function(){n.resolve()},function(e){e&&y.error(e),n.reject(e)})},function(e){e&&y.error(e),n.reject(e)}),n.promise}function m(){var e=S.getUserId();return e?j.join(w.getAppPath("appData"),"projects",g(e,1),"list.json"):null}function h(){var e=S.getUserId();return e?j.join(w.getAppPath("appDocuments"),"projects",g(e)):null}function g(e,r){return r=r||0,x(""+e,{algorithm:"md5"}).substring(8*r,8*(r+1))}var j=e("path"),b=e("fs-extra"),P=e("q"),x=e("hasha"),y=e("electron-log"),w=e("../util/util"),S=e("./token"),A=e("../config/url"),I=".krb",_="krobot",O=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],D=96,E=w.throttle(a,3e3);r.exports.check=n,r.exports.read=o,r.exports.open=function(e){var r=P.defer(),t=function(e){o(e).then(function(e){r.resolve(e)},function(e){e&&y.error(e),r.reject(e)})};if(e)return S.getUser()?(t(j.join(h(),e)),r.promise):w.rejectPromise(null,r);var n={};return n.defaultPath=S.getUser()?h():w.getAppPath("documents"),n.properties=["openDirectory"],w.showOpenDialog(n).then(function(e){t(e)},function(e){e&&y.error(e),r.reject(e)}),r.promise},r.exports.save=function(e,r,t){var n=P.defer();if(!S.getUser()){var o=j.join(w.getAppPath("appDocuments"),"projects");return t&&t.startsWith(o)&&(t=null),i(e,r,!1,t)}return t=j.join(h(),e),l(t,e,r,"cloud").then(function(){v(e).then(function(){E(),n.resolve({project_name:r.project_name,project_type:r.project_type,updated_at:r.updated_at,path:t})},function(e){e&&y.error(e),n.reject(e)})},function(e){e&&y.error(e),n.reject(e)}),n.promise},r.exports.saveAs=i,r.exports.sync=a,r.exports.list=u,r.exports.create=c,r.exports.remove=function(e,r){var t=P.defer();return y.debug("project remove: "+r),S.request(A.PROJECT_SYNC_DELETE,{method:"post",data:{hash:r}}).then(function(n){0==n.status?P.all([w.removeFile(j.join(h(),e)),function(e){var r=P.defer();return p().then(function(t){var n=t.findIndex(function(r){return r.hash==e});n<0?r.resolve():(t.splice(n,1),d(t).then(function(){r.resolve()},function(e){e&&y.error(e),r.reject(e)}))},function(e){e&&y.error(e),r.reject(e)}),r.promise}(r)]).then(function(){y.debug("project remove success: "+e),t.resolve()},function(e){e&&y.error(e),t.reject(e)}):t.reject(n.message)},function(e){e&&y.error(e),t.reject(e)}),t.promise},r.exports.upload=s,r.exports.download=f},{"../config/url":4,"../util/util":12,"./token":9,"electron-log":void 0,"fs-extra":void 0,hasha:void 0,path:void 0,q:void 0}],8:[function(e,r,t){e("path");var n=e("electron-log"),o=e("q"),i=e("serialport"),a=i.parsers.Delimiter,u={autoPortId:0,ports:{}};r.exports.listSerialPort=function(){var e=o.defer();return n.debug("listSerialPort"),i.list(function(r,t){if(r)return n.error(r),void e.reject(r);0!=t.length?e.resolve(t):e.reject()}),e.promise},r.exports.openSerialPort=function(e,r,t){var c=o.defer();n.debug("openSerialPort: "+e+", options: "+JSON.stringify(r)),r.autoOpen=!1;var s=new i(e,r);return s.open(function(e){if(e)return n.error(e),void c.reject(e);var o=++u.autoPortId;u.ports[o]=s,s.on("error",function(e){t&&t.onError&&t.onError(o,e)}),s.on("close",function(){delete u.ports[o],t&&t.onClose&&t.onClose(o)});var i="raw"==r.parser?s:s.pipe(new a({delimiter:Buffer.from(r.parser)}));i.on("readable",function(){var e=i.read();e&&t&&t.onData&&t.onData(o,e)}),s.flush(function(){c.resolve(o)})}),c.promise},r.exports.writeSerialPort=function(e,r){var t=o.defer();n.debug("writeSerialPort: "+e+", "+r);var i=u.ports[e];return i?(i.write(Buffer.from(r),function(e){if(e)return n.error(e),void t.reject(e);i.drain(function(){t.resolve()})}),t.promise):(setTimeout(function(){return t.reject()},10),t.promise)},r.exports.closeSerialPort=function(e){var r=o.defer();n.debug("closeSerialPort, portId: "+e);var t=u.ports[e];return t?(t.close(function(){r.resolve()}),r.promise):(setTimeout(function(){return r.reject()},10),r.promise)},r.exports.closeAllSerialPort=function(){n.debug("closeAllSerialPort");for(var e in u.ports)u.ports[e].close();u.ports={}},r.exports.updateSerialPort=function(e,r){var t=o.defer();n.debug("updateSerialPort, portId: "+e);var i=u.ports[e];return i?(i.update(r,function(){t.resolve()}),t.promise):(setTimeout(function(){return t.reject()},10),t.promise)},r.exports.flushSerialPort=function(e,r){var t=o.defer();n.debug("flushSerialPort, portId: "+e);var i=u.ports[e];return i?(i.flush(function(){t.resolve()}),t.promise):(setTimeout(function(){return t.reject()},10),t.promise)},r.exports.resetSerialPort=function(e){var r=o.defer(),t=new i(e,{baudRate:1200});return t.on("open",function(){t.set({rts:!0,dtr:!1}),setTimeout(function(){t.close(function(){return r.resolve()})},650)}).on("error",function(e){n.error(e),t.close(function(){r.reject(e)})}),r.promise}},{"electron-log":void 0,path:void 0,q:void 0,serialport:void 0}],9:[function(e,r,t){function n(){i=null,d.removeItem("token",!1),d.removeItem(v,!1),d.save(),f.removeFile(a.join(f.getAppPath("appData"),"token"),!0)}function o(e,r,t){if(!i)return f.rejectPromise();var n=f.getAppInfo(),o=r.headers||{};return o.Authorization="Bearer "+i.api_token,o["X-Ken-App-Version"]=n.name+"-"+n.version+"-"+n.branch+"-"+n.platform+"-"+n.appBit,r.headers=o,f.request(e,r,t)}var i,a=e("path"),u=e("crypto"),c=e("q"),s=(e("fs-extra"),e("electron-log")),f=e("../util/util"),l=e("../config/url"),p=e("../config/status"),d=e("../util/cache"),v="tokenKey";r.exports.getUser=function(){return i&&i.user?i.user:null},r.exports.getUserId=function(){return i&&i.user?i.user.id:0},r.exports.remove=n,r.exports.save=function(e){try{var r=u.randomBytes(128);return d.setItem("token",f.encrypt(JSON.stringify(e),r),!1),d.setItem(v,r.toString("hex"),!1),d.save(),i=e,f.resolvePromise()}catch(e){return f.rejectPromise(e)}},r.exports.load=function(){var e=c.defer(),r=d.getItem(v),t=d.getItem("token");if(!r||!t)return f.rejectPromise(null,e);try{var a=f.decrypt(t,Buffer.from(r,"hex"));i=JSON.parse(a),function(){var e=c.defer();return o(l.VERIFY,{method:"post"}).then(function(r){r.status==p.SUCCESS?e.resolve():e.reject(r.message)},function(r){r&&s.error(r),e.reject(r)}),e.promise}().then(function(){e.resolve(i)},function(r){n(),r&&s.error(r),e.reject(r)})}catch(r){e.reject()}return e.promise},r.exports.request=o},{"../config/status":3,"../config/url":4,"../util/cache":11,"../util/util":12,crypto:void 0,"electron-log":void 0,"fs-extra":void 0,path:void 0,q:void 0}],10:[function(e,r,t){var n=e("q"),o=e("electron-log"),i=e("../util/util"),a=e("./token"),u=e("../config/url"),c=(e("../config/status"),/^([a-zA-Z0-9]+[_|\-|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\-|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/);r.exports.loadToken=function(){var e=n.defer();return a.load().then(function(r){e.resolve(r.user)},function(r){r&&o.error(er),e.reject(r)}),e.promise},r.exports.login=function(e,r,t){var s=n.defer(),f={};return c.test(e)?f.email=e:f.username=e,f.password=r,i.request(u.LOGIN,{method:"POST",data:f}).then(function(e){0==e.status?a.save(e.data).fin(function(){s.resolve(e)}):s.resolve(e)},function(e){e&&o.error(er),s.reject(e)}),s.promise},r.exports.logout=function(){var e=n.defer();return a.remove(),i.request(u.LOGOUT).then(function(){e.resolve()},function(r){r&&o.error(r),e.reject(r)}),e.promise},r.exports.weixinLogin=function(e){var r=n.defer();return i.request(u.WEIXIN_LOGIN,{method:"POST",data:{auth_key:e}}).then(function(e){0==e.status||1==e.status?a.save(e.data).fin(function(){r.resolve(e)}):r.resolve(e)},function(e){e&&o.error(e),r.reject(e)}),r.promise},r.exports.weixinQrcode=function(){var e=n.defer();return i.request(u.WEIXIN_QRCODE).then(function(r){e.resolve(r)},function(r){r&&o.error(r),e.reject(r)}),e.promise},r.exports.register=function(e){var r=n.defer();return i.request(u.REGISTER,{method:"POST",data:{email:e.email,username:e.username,password:e.password,login:!0}}).then(function(e){r.resolve(e)},function(e){e&&o.error(e),r.reject(e)}),r.promise},r.exports.resetPassword=function(e){var r=n.defer();return i.request(u.FIND_PASSWORD,{method:"POST",data:{email:e}}).then(function(e){r.resolve(e)},function(e){e&&o.error(e),r.reject(e)}),r.promise}},{"../config/status":3,"../config/url":4,"../util/util":12,"./token":9,"electron-log":void 0,q:void 0}],11:[function(e,r,t){function n(){return o||(o=i.load("storage",a.getAppPath("appData"))),o}e("path"),e("crypto"),e("q"),e("fs-extra"),e("electron-log");var o,i=e("flat-cache"),a=e("./util");r.exports.getItem=function(e){return n().getKey(e)},r.exports.setItem=function(e,r,t){t=!1!==t;var o=n();o.setKey(e,r),t&&o.save()},r.exports.removeItem=function(e,r){r=!1!==r;var t=n();t.removeKey(e),r&&t.save()},r.exports.save=function(){n().save()}},{"./util":12,crypto:void 0,"electron-log":void 0,"flat-cache":void 0,"fs-extra":void 0,path:void 0,q:void 0}],12:[function(e,r,t){function n(){if(y.windows())return"win";if(y.macOS())return"mac";return p.arch().indexOf("arm")>=0?"arm":"linux"}function o(){return y.dev()?E.version:g.getVersion()}function i(e){return"appData"==e?v.join(g.getPath("appData"),g.getName()):"appResource"==e?y.dev()?v.resolve("."):v.resolve(g.getAppPath(),"..",".."):"appDocuments"==e?v.join(g.getPath("documents"),g.getName()):g.getPath(e)}function a(){return parseInt(Date.now()/1e3)}function u(e,r){return r=r||w.defer(),setTimeout(function(){return r.resolve(e)},10),r.promise}function c(e,r,t){var n=w.defer();return r=r||{},t=t||!1,x.debug("execCommand:"+e+", options: "+JSON.stringify(r)+", useSudo: "+t),t?I.exec(e,{name:"kenrobot"},function(e,r,t){if(r=r||"",t=t||"",r=y.windows()?_.decode(Buffer.from(r),"win1252"):r,t=y.windows()?_.decode(Buffer.from(t),"win1252"):t,e)return x.error(e),r&&x.error(r),t&&x.error(t),void n.reject(t||r||e);y.dev()&&r&&x.debug(r),n.resolve(r)}):d.exec(e,r,function(e,r,t){if(r=r||"",t=t||"",r=y.windows()?_.decode(Buffer.from(r),"win1252"):r,t=y.windows()?_.decode(Buffer.from(t),"win1252"):t,e)return x.error(e),r&&x.error(r),t&&x.error(t),void n.reject(t||r||e);y.dev()&&r&&x.debug(r),n.resolve(r)}),n.promise}function s(e,r,t){var n=w.defer(),o=d.spawn(e,r,t),i="",a="";return o.stdout.on("data",function(e){var r=y.windows()?_.decode(e,"win1252"):e.toString();y.dev()&&r&&x.debug(r),i+=r,n.notify({type:"stdout",data:r})}),o.stderr.on("data",function(e){var r=y.windows()?_.decode(e,"win1252"):e.toString();y.dev()&&r&&x.debug(r),a+=r,n.notify({type:"stderr",data:r})}),o.on("close",function(e){0==e?n.resolve(i):n.reject(a)}),n.promise}function f(e,r,t,n){if(!n){var o=w.defer();return S.outputFile(e,r,t,function(e){if(e)return x.error(e),void o.reject(e);o.resolve()}),o.promise}S.outputFileSync(e,r,t)}function l(e,r){var t=w.defer();return e=e||{},e.title="保存",e.defaultPath=e.defaultPath&&v.isAbsolute(e.defaultPath)?e.defaultPath:v.join(i("documents"),e.defaultPath||"untitled"),e.buttonLabel="保存",r=r||P.getAllWindows()[0],b.showSaveDialog(r,e,function(e){e?t.resolve(e):t.reject()}),t.promise}var p=e("os"),d=e("child_process"),v=e("path"),m=e("crypto"),h=e("electron"),g=h.app,j=h.ipcMain,b=h.dialog,P=h.BrowserWindow,x=e("electron-log"),y=e("electron-is"),w=e("q"),S=e("fs-extra"),A=e("glob"),I=e("sudo-prompt"),_=e("iconv-lite"),O=(e("lodash"),e("7zip-bin").path7za.replace("app.asar","app.asar.unpacked")),D=e("node-fetch"),E=e(y.dev()?v.resolve("app","package.json"):v.resolve(__dirname,"..","..","app.asar","package.json")),T="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC7Jat1/19NDxOObrFpW8USTia6\nuHt34Sac1Arm6F2QUzsdUEUmvGyLIOIGcdb+F6pTdx4ftY+wZi7Aomp4k3vNqXmX\nT0mE0vpQlCmsPUcMHXuUi93XTGPxLXIv9NXxCJZXSYI0JeyuhT9/ithrYlbMlyNc\nwKB/BwSpp+Py2MTT2wIDAQAB\n-----END PUBLIC KEY-----\n";y.dev()&&g.setName(E.productName);var N={},R=0;r.exports.getPlatform=n,r.exports.getVersion=o,r.exports.getAppInfo=function(){var e={bit:"x64"===process.arch||process.env.hasOwnProperty("PROCESSOR_ARCHITEW6432")?64:32,arch:process.arch,platform:n(),version:o(),name:g.getName(),buildNumber:E.buildNumber};return y.dev()?(e.ext=v.extname(i("exe")).replace(".",""),e.branch="beta",e.feature="",e.date=a(),e.appBit=e.bit):(e.ext=E.buildInfo.ext,e.branch=E.buildInfo.branch,e.feature=E.buildInfo.feature,e.date=E.buildInfo.date,e.appBit=E.buildInfo.appBit),e},r.exports.getAppPath=i,r.exports.versionCompare=function(e,r){for(var t=/(\d+)\.(\d+)\.(\d+)/,n=t.exec(e),o=t.exec(r),i=[parseInt(n[1]),parseInt(n[2]),parseInt(n[3])],a=[parseInt(o[1]),parseInt(o[2]),parseInt(o[3])],u=0;u<=2;u++)if(i[u]!=a[u])return i[u]>a[u]?1:-1;return 0},r.exports.postMessage=function(e){for(var r=arguments.length,t=Array(r>1?r-1:0),n=1;n<r;n++)t[n-1]=arguments[n];x.debug("postMessage: "+e+", "+t.join(", "));var o=P.getAllWindows();o&&o.length&&o[0].webContents.send(e,t)},r.exports.listenMessage=function(e,r){var t=this,n="app:"+e;j.on(n,function(e,o){for(var i=arguments.length,a=Array(i>2?i-2:0),c=2;c<i;c++)a[c-2]=arguments[c];(r.apply(t,a)||u()).then(function(r){e.sender.send(n,o,!0,r)},function(r){e.sender.send(n,o,!1,r)},function(r){e.sender.send(n,o,"notify",r)})})},r.exports.getDefer=function(){var e=w.defer(),r=R++;return N[r]=e,{deferId:r,promise:e.promise}},r.exports.callDefer=function(e,r){var t=N[e];if(t){var n;"notify"==r?n=t.notify:(delete N[e],n=r?t.resolve:t.reject);for(var o=arguments.length,i=Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];n.apply(this,i)}},r.exports.handleQuotes=function(e){return y.windows()?e:e.replace(/"/g,"")},r.exports.uuid=function(e,r){var t,n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),o=[];if(r=r||n.length,e)for(t=0;t<e;t++)o[t]=n[0|Math.random()*r];else{var i;for(o[8]=o[13]=o[18]=o[23]="-",o[14]="4",t=0;t<36;t++)o[t]||(i=0|16*Math.random(),o[t]=n[19==t?3&i|8:i])}return o.join("")},r.exports.stamp=a,r.exports.throttle=function(e,r){var t;return function(){t&&clearTimeout(t),t=setTimeout(function(){e(),clearTimeout(t),t=null},r)}},r.exports.encrypt=function(e,r,t){t=t||"aes-128-cbc";var n=m.createCipher(t,r),o=n.update(e,"utf8","binary");return o+=n.final("binary"),o=new Buffer(o,"binary").toString("base64")},r.exports.decrypt=function(e,r,t){t=t||"aes-128-cbc",e=new Buffer(e,"base64").toString("binary");var n=m.createDecipher(t,r),o=n.update(e,"binary","utf8");return o+=n.final("utf8")},r.exports.rsa_encrypt=function(e,r){r=r||T;var t=new Buffer(e);return m.publicEncrypt({key:r,padding:m.constants.RSA_PKCS1_PADDING},t).toString("base64")},r.exports.rsa_decrypt=function(e,r){var t=new Buffer(e,"base64");return m.privateDecrypt({key:r,padding:m.constants.RSA_PKCS1_PADDING},t).toString("utf8")},r.exports.resolvePromise=u,r.exports.rejectPromise=function(e,r){return r=r||w.defer(),setTimeout(function(){return r.reject(e)},10),r.promise},r.exports.execFile=function(e){var r=w.defer();x.debug("execFile: "+e);var t;return t=y.windows()?"start /WAIT "+e:""+e,c(t,null,!0).fin(function(){r.resolve()}),r.promise},r.exports.execCommand=c,r.exports.spawnCommand=s,r.exports.readFile=function(e,r,t){if(t)return S.readFileSync(e,r);var n=w.defer();return r=r||"utf8",S.readFile(e,r,function(e,r){if(e)return x.error(e),void n.reject(e);n.resolve(r)}),n.promise},r.exports.writeFile=f,r.exports.saveFile=function(e,r,t){var n=w.defer();return t=t||{},e&&(t.defaultPath=e),l(t).then(function(e){f(e,r,t).then(function(){n.resolve()},function(e){e&&x.error(e),n.reject(e)})},function(e){e&&x.error(e),n.reject(e)}),n.promise},r.exports.moveFile=function(e,r,t){var n=w.defer();return t=t||{overwrite:!0},S.move(e,r,t,function(e){if(e)return x.error(e),void n.reject(e);n.resolve()}),n.promise},r.exports.removeFile=function(e,r){if(!r){var t=w.defer();return S.remove(e,function(e){if(e)return x.error(e),void t.reject(e);t.resolve()}),t.promise}S.removeSync(e)},r.exports.readJson=function(e,r){var t=w.defer();return r=r||{},S.readJson(e,r,function(e,r){if(e)return x.error(e),void t.reject(e);t.resolve(r)}),t.promise},r.exports.writeJson=function(e,r,t,n){if(!n){var o=w.defer();return t=t||{},S.outputJson(e,r,t,function(e){if(e)return x.error(e),void o.reject(e);o.resolve()}),o.promise}S.outputJsonSync(e,r,t)},r.exports.searchFiles=function(e){var r=w.defer();return x.debug("searchFiles: "+e),A(e,{},function(e,t){return e?(x.error(e),void r.reject(e)):r.resolve(t)}),r.promise},r.exports.compress=function(e,r,t,n){var o=w.defer();return r=r||[r],n=n||"7z",x.debug("compress: "+e+": "+r.length+" => "+t+": "+n),c("cd "+(y.windows()?"/d ":"")+e+' && "'+O+'" a -t'+n+" -r "+t+" "+r.join(" ")).then(function(){o.resolve()},function(e){e&&x.error(e),o.reject(e)}),o.promise},r.exports.uncompress=function(e,r,t){var n=w.defer(),o=/([\d]+)% \d+ - .*\r?/g;return x.debug("uncompress: "+e+" => "+r),t?s('"'+O+'"',["x",'"'+e+'"',"-bsp1","-y",'-o"'+r+'"'],{shell:!0}).then(function(e){n.resolve(e)},function(e){e&&x.error(e),n.reject(e)},function(e){if(o.lastIndex=0,o.test(e.data)){var r,t=o.exec(e.data);do{r=t,t=o.exec(e.data)}while(t);n.notify(parseInt(r[1]))}}):c('"'+O+'" x "'+e+'" -y -o"'+r+'"').then(function(){n.resolve()},function(e){e&&x.error(e),n.reject(e)}),n.promise},r.exports.showOpenDialog=function(e,r){var t=w.defer();return e=e||{},e.title="打开",e.defaultPath=e.defaultPath||i("documents"),e.buttonLabel="打开",r=r||P.getAllWindows()[0],b.showOpenDialog(r,e,function(e){e?t.resolve(e[0]):t.reject()}),t.promise},r.exports.showSaveDialog=l,r.exports.request=function(e,r,t){var n=w.defer();if(r=r||{},t=!1!==t,r.method=r.method||"GET",t&&r.data){r.body=JSON.stringify(r.data);var o=r.headers||(r.headers={});o["Content-Type"]="application/json",o.Accept="application/json",delete r.data}return D(e,r).then(function(e){if(e.ok)return t?e.json():e;var r=new Error(e.statusText);throw r.status=e.status,r}).then(function(e){n.resolve(e)}).catch(function(e){e&&x.error(e),n.reject(e)}),n.promise}},{"7zip-bin":void 0,child_process:void 0,crypto:void 0,electron:void 0,"electron-is":void 0,"electron-log":void 0,"fs-extra":void 0,glob:void 0,"iconv-lite":void 0,lodash:void 0,"node-fetch":void 0,os:void 0,path:void 0,q:void 0,"sudo-prompt":void 0}]},{},[5]);