"use strict";var _slicedToArray=function(){function e(e,r){var n=[],t=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(t=(a=u.next()).done)&&(n.push(a.value),!r||n.length!==r);t=!0);}catch(e){o=!0,i=e}finally{try{!t&&u.return&&u.return()}finally{if(o)throw i}}return n}return function(r,n){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();!function e(r,n,t){function o(a,u){if(!n[a]){if(!r[a]){var s="function"==typeof require&&require;if(!u&&s)return s(a,!0);if(i)return i(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var f=n[a]={exports:{}};r[a][0].call(f.exports,function(e){var n=r[a][1][e];return o(n||e)},f,f.exports,e,r,n,t)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<t.length;a++)o(t[a]);return o}({1:[function(e,r,n){function t(){ae.transports.file.format="[{y}-{m}-{d} {h}:{i}:{s}] [{level}] {text}",oe.dev()&&ve.dev?ae.transports.file.level="debug":(ae.transports.console=!1,ae.transports.file.level="error")}function o(){var e=oe.windows()?"pepflashplayer.dll":oe.macOS()?"PepperFlashPlayer.plugin":"libpepflashplayer.so";e=Z.join(H("FlashPlayer"),e),ae.debug("initFlashPlugin: version: 23.0.0.207"),Q.commandLine.appendSwitch("ppapi-flash-path",e),Q.commandLine.appendSwitch("ppapi-flash-version","23.0.0.207")}function i(){var e=Z.join(__dirname,".."),r=le();r.use("/",le.static(Z.join(e,"public"))),r.listen(de)}function a(){Q.on("ready",c).on("window-all-closed",function(e){return"darwin"!==process.platform&&Q.quit()}).on("activate",function(e){return null===G&&f()}).on("will-quit",l).on("quit",function(e){return ae.debug("app quit")})}function u(){s("getAppInfo",function(e){return ee.resolvePromise(ee.getAppInfo())}),s("getBaseUrl",function(e){return ee.resolvePromise(pe)}),s("execFile",function(e){return ee.execFile(e)}),s("execCommand",function(e,r){return ee.execCommand(e,r)}),s("spawnCommand",function(e,r,n){return ee.spawnCommand(e,r,n)}),s("readFile",function(e,r){return ee.readFile(e,r)}),s("writeFile",function(e,r){return ee.writeFile(e,r)}),s("moveFile",function(e,r,n){return ee.moveFile(e,r,n)}),s("removeFile",function(e){return ee.removeFile(e)}),s("showOpenDialog",function(e){return ee.showOpenDialog(G,e)}),s("showSaveDialog",function(e){return ee.showSaveDialog(G,e)}),s("request",function(e,r,n){return ee.request(e,r,n)}),s("showItemInFolder",function(e){return V.showItemInFolder(Z.normalize(e))}),s("openUrl",function(e){return e&&V.openExternal(e)}),s("listSerialPort",function(e){return O()}),s("openSerialPort",function(e,r){return D(e,r)}),s("writeSerialPort",function(e,r){return ne.writeSerialPort(e,r)}),s("closeSerialPort",function(e){return ne.closeSerialPort(e)}),s("updateSerialPort",function(e,r){return ne.updateSerialPort(e,r)}),s("flushSerialPort",function(e){return ne.flushSerialPort(e)}),s("buildProject",function(e,r){return N(e,r)}),s("upload",function(e,r){return U(e,r)}),s("upload2",function(e,r,n){return C(e,r,n)}),s("download",function(e,r){return S(e,r)}),s("installDriver",function(e){return A(e)}),s("loadExamples",function(e){return P()}),s("openExample",function(e,r){return w(e,r)}),s("unzipPackage",function(e){return b(e)}),s("loadPackages",function(e){return j()}),s("deletePackage",function(e){return y(e)}),s("checkUpdate",function(e){return v(e)}),s("removeOldVersions",function(e){return m(e)}),s("setToken",function(e){return re.set(e)}),s("saveToken",function(e){return re.save(e)}),s("loadToken",function(e){return re.load(e)}),s("removeToken",function(e){return re.remove()}),s("projectSave",function(e,r,n){return te.save(e,r,n)}),s("projectOpen",function(e,r){return te.open(e,r)}),s("projectSyncUrl",function(e){return te.setSyncUrl(e)}),s("projectSync",function(e){return te.sync()}),s("projectList",function(e){return te.list(e)}),s("projectUpload",function(e,r){return te.upload(e,r)}),s("projectDelete",function(e,r){return te.remove(e,r)}),s("projectDownload",function(e,r){return te.download(e,r)}),s("log",function(e,r){return(ae[r]||ae.debug).bind(ae).call(e)}),s("copy",function(e,r){return Y.writeText(e,r)}),s("quit",function(e){return Q.quit()}),s("reload",function(e){return G.reload()}),s("fullscreen",function(e){return G.setFullScreen(!G.isFullScreen())}),s("min",function(e){return G.minimize()}),s("max",function(e){G.isFullScreen()?G.setFullScreen(!1):G.isMaximized()?G.unmaximize():G.maximize()}),s("errorReport",function(e){ae.error("------ error message ------"),ae.error(e.message+"("+e.src+" at line "+e.line+":"+e.col+")"),ae.error(""+e.stack)})}function s(e,r){var n=this,t="app:"+e;X.on(t,function(e,o){for(var i=arguments.length,a=Array(i>2?i-2:0),u=2;u<i;u++)a[u-2]=arguments[u];(r.apply(n,a)||ee.resolvePromise()).then(function(r){e.sender.send(t,o,!0,r)},function(r){e.sender.send(t,o,!1,r)},function(r){e.sender.send(t,o,"notify",r)})})}function c(){ae.debug("app ready"),oe.dev()&&ve.devTool&&ie({showDevTools:!0}),h().then(function(e){L=e,f(),k(),d()})}function f(){G=new W({width:1200,height:720,minWidth:1200,minHeight:720,frame:!1,show:!1,webPreferences:{plugins:!0,webSecurity:!1}}),ve.fullscreen?G.setFullScreen(!0):ve.maximize&&G.maximize(),G.on("closed",function(e){return G=null}).once("ready-to-show",function(e){return G.show()}).on("enter-full-screen",function(e){return ee.postMessage("app:onFullscreenChange",!0)}).on("leave-full-screen",function(e){return ee.postMessage("app:onFullscreenChange",!1)}),G.webContents.on("devtools-reload-page",function(e){return ne.closeAllSerialPort()}),G.webContents.session.on("will-download",x),G.loadURL(pe),G.focus()}function l(){ne.closeAllSerialPort(),ee.removeFile(Z.join(ee.getAppDataPath(),"temp"),!0)}function d(){oe.dev()||L.version==ee.getVersion()||(L.version=ee.getVersion(),g())}function p(){if(!oe.dev()&&L.installReportFail){var e=ee.getAppInfo(),r={version:e.version,platform:e.platform,bit:e.bit,ext:e.ext,branch:e.branch,feature:e.feature,installTime:parseInt((new Date).getTime()/1e3)};ee.request("http://userver.kenrobot.com/statistics/installations",{method:"post",data:{data:JSON.stringify(r)}}).then(function(e){delete L.installReportFail},function(e){e&&ae.error(e),L.installReportFail=!0}).fin(function(e){g()})}}function v(e){var r=ue.defer(),n=ee.getAppInfo(),t=e+"&version="+n.version+"&platform="+n.platform+"&arch="+n.arch+"&features="+n.feature+"&ext="+n.ext;return ae.debug("checkUpdate: "+t),ee.request(t).then(function(e){r.resolve(e)},function(e){e&&ae.error(e),r.reject(e)}),r.promise}function m(e){var r=ue.defer();if(oe.dev())return setTimeout(function(e){r.resolve()},10),r.promise;var n=ee.getAppInfo(),t=Z.join(ee.getAppDataPath(),"download");return ee.searchFiles(t+"/"+n.name+"-*."+n.ext).then(function(n){var o=/\d+\.\d+\.\d+/;n.map(function(e){return Z.basename(e)}).filter(function(r){var n=r.match(o);return!!n&&ee.versionCompare(n[0],e)<0}).forEach(function(e){ee.removeFile(Z.join(t,e),!0)}),r.resolve()},function(e){e&&ae.error(e),r.reject(e)}),r.promise}function h(){var e=ue.defer();ae.debug("loadConfig");var r=Z.join(ee.getAppDataPath(),"config.json");return se.existsSync(r)?(ee.readJson(r).then(function(r){e.resolve(r)},function(r){e.resolve({})}),e.promise):(setTimeout(function(r){e.resolve({})},10),e.promise)}function g(e){e=1==e;var r=Z.join(ee.getAppDataPath(),"config.json");return ee.writeJson(r,L,e)}function b(e){var r=ue.defer();return ee.unzip(e,z(),!0).then(function(n){var t=Z.basename(e);t=t.substring(0,t.indexOf("-"));var o=oe.windows()?"bat":"sh";ee.searchFiles(Z.join(z(),t)+"/**/post_install."+o).then(function(e){if(0!=e.length){var n=e[0];ee.execCommand('"'+n+'"',{cwd:Z.dirname(n)}).then(function(e){r.resolve()},function(e){e&&ae.error(e),r.reject(e)})}else r.resolve()},function(e){e&&ae.error(e),r.reject(e)})},function(e){e&&ae.error(e),r.reject(e)},function(e){r.notify(e)}),r.promise}function j(){var e=ue.defer(),r=[],n=z();return ae.debug("loadPackages: "+n),ee.searchFiles(n+"/*/package.json").then(function(n){ue.all(n.map(function(e){var n=ue.defer();return ee.readJson(e).then(function(n){n.path=Z.dirname(e),n.boards&&n.boards.forEach(function(e){e.build&&e.build.prefs&&Object.keys(e.build.prefs).forEach(function(r){e.build.prefs[r]=e.build.prefs[r].replace("PACKAGE_PATH",n.path)}),e.upload&&e.upload.command&&(e.upload.command=e.upload.command.replace(/PACKAGE_PATH/g,n.path))});var t=Z.join(n.path,"src");se.existsSync(t)&&!me.librariesPath.includes(t)&&me.librariesPath.push(t),r.push(n)}).fin(function(e){n.resolve()}),n.promise})).then(function(n){e.resolve(r)})},function(r){r&&ae.error(r),e.reject(r)}),e.promise}function y(e){var r=ue.defer();return ae.debug("deletePackage: "+e),ee.removeFile(Z.join(z(),e)).then(function(e){r.resolve()},function(e){e&&ae.error(e),r.reject(e)}),r.promise}function w(e,r){var n=ue.defer(),t=Z.join(ee.getResourcePath(),"examples",e,r);return ae.debug("openExample: "+t),ee.readJson(Z.join(t,"project.json")).then(function(e){n.resolve(e)},function(e){e&&ae.error(e),n.reject(e)}),n.promise}function P(){var e=ue.defer();return ae.debug("loadExamples"),ee.readJson(Z.join(ee.getResourcePath(),"examples","examples.json")).then(function(r){e.resolve(r)},function(r){r&&ae.error(r),e.reject(r)}),e.promise}function x(e,r,n){var t=r.getURL(),o=t.lastIndexOf("#"),i=$.parse(t.substring(o+1));t=t.substring(0,o);var a=i.deferId,u=Z.join(ee.getAppDataPath(),"download",r.getFilename());if(i.checksum&&se.existsSync(u)){o=i.checksum.indexOf(":");var s=i.checksum.substring(0,o);if(i.checksum.substring(o+1)==fe.fromFileSync(u,{algorithm:s}))return r.cancel(),ae.debug("download cancel, "+t+" has cache"),void ee.callDefer(a,!0,{path:u})}r.setSavePath(u);var c=r.getTotalBytes();r.on("updated",function(e,n){"interrupted"==n?(ae.debug("download interrupted: "+t),ee.callDefer(a,!1,{path:u})):"progressing"===n&&(r.isPaused()?(ae.debug("download paused: "+t),ee.callDefer(a,!1,{path:u})):ee.callDefer(a,"notify",{path:u,totalSize:c,size:r.getReceivedBytes()}))}),r.once("done",function(e,r){"completed"==r?(ae.debug("download success: "+t+", at "+u),ee.callDefer(a,!0,{path:u})):(ae.debug("download fail: "+t),ee.callDefer(a,!1,{path:u}))})}function S(e,r){var n=ue.defer(),t=ee.getDefer(),o=t.deferId,i=t.promise;r.deferId=o;var a=$.stringify(r);return ae.debug("download "+e+", options: "+a),i.then(function(e){n.resolve(e)},function(e){e&&ae.error(e),n.reject(e)},function(e){n.notify(e)}),G.webContents.downloadURL(e+"#"+a),n.promise}function A(e){var r=ue.defer();ae.debug("installDriver: "+e);var n=Z.join(ee.getAppDataPath(),"temp");return ee.unzip(e,n).then(function(t){var o=Z.join(n,Z.basename(e,Z.extname(e)),"setup.exe");ee.execFile(o).then(function(e){r.resolve()})},function(e){e&&ae.error(e),r.reject(e)}),r.promise}function D(e,r){return ne.openSerialPort(e,r,{onError:I,onData:_,onClose:T})}function I(e,r){ee.postMessage("app:onSerialPortError",e,r)}function _(e,r){ee.postMessage("app:onSerialPortData",e,r)}function T(e){ee.postMessage("app:onSerialPortClose",e)}function O(){var e=ue.defer();return ne.listSerialPort().then(function(r){0!=(r=F(r)).length?q(r).then(function(n){ae.debug(r.map(function(e){return e.comName+", pid: "+e.productId+", vid: "+e.vendorId+", boardName: "+(e.boardName||"")}).join("\n")),e.resolve(r)},function(r){r&&ae.error(r),e.reject(r)}):e.reject()},function(r){r&&ae.error(r),e.reject(r)}),e.promise}function F(e){var r=/(COM\d+)|(usb-serial)|(arduino)|(\/dev\/cu\.usbmodem)|(\/dev\/(ttyUSB|ttyACM|ttyAMA))/;return e.filter(function(e){return r.test(e.comName)})}function N(e,r){var n=ue.defer();return R(e,r).then(function(r){ae.debug("buildProject: "+e+", command path: "+r);var t=J("call");ee.spawnCommand('"'+t+'"',['"'+r+'"'],{shell:!0}).then(function(e){n.resolve()},function(e){e&&ae.error(e),n.reject(e)},function(e){n.notify(e)})},function(e){e&&ae.error(e),n.reject(e)}),n.promise}function R(e,r){var n=ue.defer();ae.debug("pre-build");var t=[];r=Object.assign({},me.default.build,r);var o=z();se.existsSync(o)&&t.push("-hardware="+o),t.push("-fqbn="+r.fqbn);var i=M();Object.keys(r.prefs).forEach(function(e){var n=ee.handleQuotes(r.prefs[e]);n=n.replace(/ARDUINO_PATH/g,i),t.push("-prefs="+e+"="+n)}),me.librariesPath.forEach(function(e){t.push('-libraries="'+e+'"')});var a=Z.join(e,"build");se.ensureDirSync(a),ee.removeFile(Z.join(a,"sketch","build"),!0);var u=B("build"),s=ee.handleQuotes(r.command);return s=s.replace(/ARDUINO_PATH/g,M()).replace("BUILD_SPECS",t.join(" ")).replace("PROJECT_BUILD_PATH",a).replace("PROJECT_ARDUINO_FILE",Z.join(e,Z.basename(e)+".ino")),ee.writeFile(u,s).then(function(t){var o=Z.join(e,"build","build.options.json");if(!se.existsSync(o))return setTimeout(function(e){n.resolve(u)},10),n.promise;ee.readJson(o).then(function(t){r.fqbn!=t.fqbn?ee.removeFile(Z.join(e,"build")).fin(function(r){se.ensureDirSync(Z.join(e,"build")),n.resolve(u)}):n.resolve(u)},function(e){e&&ae.error(e),n.resolve(u)})},function(e){e&&ae.error(e),n.reject()}),n.promise}function U(e,r){var n=ue.defer();return O().then(function(t){1==t.length?C(e,t[0].comName,r).then(function(e){n.resolve(e)},function(e){n.reject(e)},function(e){n.notify(e)}):n.reject({status:"SELECT_PORT",ports:t})},function(e){n.reject({status:"NOT_FOUND_PORT"})}),n.promise}function C(e,r,n){var t=ue.defer();return E(e,r,n).then(function(n){ae.debug("upload: "+e+", "+r+", command path: "+n);var o=J("call");ee.spawnCommand('"'+o+'"',['"'+n+'"'],{shell:!0}).then(function(e){t.resolve()},function(e){e&&ae.error(e),t.reject(e)},function(e){t.notify(e)})},function(e){e&&ae.error(e),t.reject(e)}),t.promise}function E(e,r,n){var t=ue.defer();ae.debug("pre upload"),n=Object.assign({},me.default.upload,n);var o=Z.join(e,"build",Z.basename(e)+".ino."+n.target_type),i=B("upload"),a=ee.handleQuotes(n.command);return a=a.replace(/ARDUINO_PATH/g,M()).replace("ARDUINO_MCU",n.mcu).replace("ARDUINO_BURNRATE",n.baudrate).replace("ARDUINO_PROGRAMMER",n.programer).replace("ARDUINO_COMPORT",r).replace("TARGET_PATH",o),ee.writeFile(i,a).then(function(e){ne.resetSerialPort(r).then(function(e){t.resolve(i)},function(e){e&&ae.error(e),t.reject(e)})},function(e){e&&ae.error(e),t.reject(e)}),t.promise}function k(e){var r=ue.defer();if(L.boardNames&&!e)return ae.debug("skip loadBoards"),setTimeout(function(e){r.resolve(L.boardNames)},10),r.promise;ae.debug("loadBoards");var n={},t=/\n(([^\.\n]+)\.pid(\.\d)?)=([^\r\n]+)/g,o=/\n(([^\.\n]+)\.vid(\.\d)?)=([^\r\n]+)/g,i=/\n([^\.\n]+)\.name=([^\r\n]+)/g,a="arduino-"+ee.getPlatform();return ee.searchFiles(a+"/**/boards.txt").then(function(e){ue.all(e.map(function(e){var r=ue.defer();return ee.readFile(e).then(function(e){var r=e.match(t),a=e.match(o),u=[];e.match(i).forEach(function(e){var r=e.substring(0,e.indexOf(".name")).trim(),n=e.substring(e.indexOf("=")+1).trim();u[r]=n});var s=r.map(function(e){return e.substring(0,e.indexOf(".pid")).trim()});r=r.map(function(e){return e.substring(e.indexOf("=")+3)}),a=a.map(function(e){return e.substring(e.indexOf("=")+3)});for(var c=0;c<r.length;c++)n[r[c]+"_"+a[c]]={pid:r[c],vid:a[c],type:s[c],name:u[s[c]]}}).fin(function(e){r.resolve()}),r.promise})).then(function(e){L.boardNames=n,g().then(function(e){r.resolve(L.boardNames)},function(e){e&&ae.error(e),r.reject(e)})})},function(e){e&&ae.error(e),r.reject(e)}),r.promise}function q(e){var r=ue.defer();return ae.debug("matchBoardNames"),k().then(function(n){e.forEach(function(e){if(e.productId&&e.vendorId){var r=L.boardNames[e.productId+"_"+e.vendorId];r&&(e.boardName=r.name)}}),r.resolve(e)},function(e){e&&ae.error(e),r.reject(e)}),r.promise}function J(e){var r=oe.windows()?"bat":"sh";return Z.join(ee.getResourcePath(),"scripts",e+"."+r)}function B(e){return Z.join(ee.getAppDataPath(),"temp",e+".txt")}function M(){return Z.join(ee.getResourcePath(),"arduino-"+ee.getPlatform())}function z(){return Z.join(Q.getPath("documents"),Q.getName(),"packages")}function H(e){return Z.join(ee.getResourcePath(),"plugins",e,ee.getPlatform())}var L,G,K=e("electron"),Q=K.app,W=K.BrowserWindow,X=K.ipcMain,V=K.shell,Y=K.clipboard,Z=(K.webContents,e("path")),$=(e("os"),e("querystring")),ee=(e("crypto"),e("./util")),re=e("./token"),ne=e("./serialPort"),te=e("./project"),oe=e("electron-is"),ie=e("electron-debug"),ae=e("electron-log"),ue=e("q"),se=e("fs-extra"),ce=e("minimist"),fe=e("hasha"),le=e("express"),de=8778,pe="http://localhost:"+de,ve=ce(process.argv.slice(1)),me={default:{build:{fqbn:"arduino:avr:uno:cpu=atmega328p",prefs:{"runtime.tools.avr-gcc.path":'"ARDUINO_PATH/hardware/tools/avr"',"runtime.tools.avrdude.path":'"ARDUINO_PATH/hardware/tools/avr"'},command:'"ARDUINO_PATH/arduino-builder" -compile -logger=machine -hardware="ARDUINO_PATH/hardware" -hardware="ARDUINO_PATH/packages" -tools="ARDUINO_PATH/tools-builder" -tools="ARDUINO_PATH/hardware/tools/avr" -tools="ARDUINO_PATH/packages" -built-in-libraries="ARDUINO_PATH/libraries" -ide-version=10612 -warnings=none -prefs=build.warn_data_percentage=75 BUILD_SPECS -build-path="PROJECT_BUILD_PATH" "PROJECT_ARDUINO_FILE"'},upload:{target_type:"hex",mcu:"atmega328p",baudrate:"115200",programer:"arduino",command:'"ARDUINO_PATH/hardware/tools/avr/bin/avrdude" -C "ARDUINO_PATH/hardware/tools/avr/etc/avrdude.conf" -v -p ARDUINO_MCU -c ARDUINO_PROGRAMMER -b ARDUINO_BURNRATE -P ARDUINO_COMPORT -D -U "flash:w:TARGET_PATH:i"'}},librariesPath:[]};!function(){process.on("uncaughtException",function(e){var r=e.stack||e.name+": "+e.message;ae.error(r)}),t(),o(),i(),Q.makeSingleInstance(function(e,r){G&&(G.isMinimized()&&G.restore(),G.focus())})&&Q.quit(),a(),u(),ae.debug("app start, version "+ee.getVersion()),p()}()},{"./project":2,"./serialPort":3,"./token":4,"./util":5,crypto:void 0,electron:void 0,"electron-debug":void 0,"electron-is":void 0,"electron-log":void 0,express:void 0,"fs-extra":void 0,hasha:void 0,minimist:void 0,os:void 0,path:void 0,q:void 0,querystring:void 0}],2:[function(e,r,n){function t(e){F.debug("project setSyncUrl: "+e),D=e}function o(e){var r=T.defer();e=e||"all",F.debug("project list: "+e);var n=U.get();if(!n||!D)return R.rejectPromise(null,r);var t=n.user_id,o=parseInt((new Date).getTime()/1e3),i=R.rsa_encrypt("Kenrobot-"+t+"-"+o),a=D+"/list";return R.request(a,{method:"post",data:{id:t,stamp:o,sign:i,type:e}}).then(function(e){0==e.status?r.resolve(e.data):r.reject(e.message)},function(e){e&&F.error(e),r.reject(e)}),r.promise}function i(e,r){var n=T.defer();F.debug("project upload: "+e+" "+r);var t=U.get();if(!t||!D)return R.rejectPromise(null,n);var o=t.user_id,i=parseInt((new Date).getTime()/1e3),a=R.rsa_encrypt("Kenrobot-"+o+"-"+i);return c(w(o),e,r).then(function(t){var u=D+"/upload";R.request(u,{method:"post",headers:{id:o,stamp:i,sign:a,name:e,type:r},body:_.createReadStream(t)}).then(function(e){if(0==e.status){var r=e.data;h(r.name,r.type,r.modify_time).then(function(e){n.resolve(r)},function(e){e&&F.error(e),n.reject(e)})}else n.reject(e.message)},function(e){e&&F.error(e),n.reject(e)})},function(e){e&&F.error(e),n.reject(e)}),n.promise}function a(e,r){var n=T.defer();F.debug("project download: "+e+" "+r);var t=U.get();if(!t||!D)return R.rejectPromise(null,n);var o=t.user_id,i=parseInt((new Date).getTime()/1e3),a=R.rsa_encrypt("Kenrobot-"+o+"-"+i),u={id:o,stamp:i,sign:a,name:e,type:r},s=D+"/download";return R.request(s,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)},!1).then(function(t){var i=parseInt(t.headers.get("modify_time")),a=I.join(R.getAppDataPath(),"temp",R.uuid(6)+".zip");_.ensureDirSync(I.dirname(a));var u=_.createWriteStream(a);t.body.pipe(u),t.body.on("end",function(t){f(a,w(o),e,r).then(function(t){h(e,r,i).then(function(e){n.resolve()},function(e){e&&F.error(e),n.reject(e)})},function(e){e&&F.error(e),n.reject(e)})}).on("error",function(e){e&&F.error(e),n.reject(e)})},function(e){e&&F.error(e),n.reject(e)}),n.promise}function u(e,r){var n=T.defer();F.debug("project remove: "+e+" "+r);var t=U.get();if(!t||!D)return R.rejectPromise(null,n);var o=t.user_id,i=parseInt((new Date).getTime()/1e3),a=R.rsa_encrypt("Kenrobot-"+o+"-"+i),u=D+"/delete";return R.request(u,{method:"post",data:{id:o,stamp:i,sign:a,name:e,type:r}}).then(function(t){0==t.status?T.all([R.removeFile(I.join(w(o),P(e,r))),g(e)]).then(function(e){n.resolve()},function(e){e&&F.error(e),n.reject(e)}):n.reject(t.message)},function(e){e&&F.error(e),n.reject(e)}),n.promise}function s(){var e=T.defer();return F.debug("project sync"),T.all([o(),b()]).then(function(r){var n=_slicedToArray(r,2);d(n[0],n[1]).then(function(r){e.resolve()},function(r){r&&F.error(r),e.reject(r)},function(r){e.notify(r)})},function(r){r&&F.error(r),e.reject(r)}),e.promise}function c(e,r,n){var t=T.defer(),o=new N;switch(n){case"edu":case"ide":o.file(r+"/"+r+".ino",R.readFile(I.join(e,r+"/"+r+".ino"),{encoding:null},!0)),o.file(r+"/project.json",R.readFile(I.join(e,r+"/project.json"),{encoding:null},!0));break;case"scratch2":o.file(r+".sb2",R.readFile(I.join(e,r+".sb2"),{encoding:null},!0));break;case"scratch3":o.file(r+".json",R.readFile(I.join(e,r+".json"),{encoding:null},!0))}var i=I.join(R.getAppDataPath(),"temp",R.uuid(6)+".zip");return _.ensureDirSync(I.dirname(i)),o.generateNodeStream({streamFiles:!0}).pipe(_.createWriteStream(i)).on("finish",function(e){t.resolve(i)}).on("error",function(e){e&&F.error(e),t.reject(e)}),t.promise}function f(e,r,n,t){var o=T.defer();return R.readFile(e,{encoding:null}).then(function(e){var n=new N;n.loadAsync(e).then(function(e){var t=0;n.forEach(function(e,n){n.dir||(t++,n.async("string").then(function(n){R.writeFile(I.join(r,e),n,!0),0==--t&&o.resolve()},function(e){e&&F.error(e),o.reject(e)}))})},function(e){e&&F.error(e),o.reject(e)})},function(e){e&&F.error(e),o.reject(e)}),o.promise}function l(e,r){var n=U.get();if(!n)return!1;var t=w(n.user_id),o=I.join(t,P(e,r));return _.existsSync(o)}function d(e,r){var n=T.defer(),t=p(e,r),o=_slicedToArray(t,2),i=o[0],a=o[1];F.debug("doSync: downloadList:"+i.length+", uploadList:"+a.length);var u=i.length+a.length,s=0,c=function(e,r,t){s++,n.notify({total:u,count:s,name:e,type:r,action:t})};return v(i,c).then(m(a,c)).then(function(e){n.resolve()}).catch(function(e){e&&F.error(e),n.reject(e)}),n.promise}function p(e,r){var n={},t={};e.forEach(function(e){n[e.name+"-"+e.type]=e}),r.forEach(function(e){t[e.name+"-"+e.type]=e});var o=[],i=[];return e.forEach(function(e){var r=e.name+"-"+e.type,n=t[r];!n||!n.modify_time||n.modify_time<e.modify_time?o.push(e):l(e.name,e.type)||o.push(e)}),r.forEach(function(e){var r=e.name+"-"+e.type,t=n[r];(!t||t.modify_time<e.modify_time)&&i.push(e)}),[o,i]}function v(e,r){var n,t=T.defer();return(n=function(o){if(0==e.length)return R.resolvePromise(!0,t);var i=e.shift();a(i.name,i.type).then(function(o){r(i.name,i.type,"download"),0==e.length?t.resolve():setTimeout(function(e){return n()},100)},function(e){e&&F.error(e),t.reject(e)})})(),t.promise}function m(e,r){var n,t=T.defer();return(n=function(o){if(0==e.length)return R.resolvePromise(!0,t);var a=e.shift();i(a.name,a.type).then(function(o){r(a.name,a.type,"upload"),0==e.length?t.resolve():setTimeout(function(e){return n()},100)},function(e){e&&F.error(e),t.reject(e)})})(),t.promise}function h(e,r,n){var t=T.defer();return b().then(function(o){var i=o.find(function(r){return r.name==e});i?i.modify_time=n:o.push({name:e,type:r,modify_time:n}),j(o).then(function(e){t.resolve()},function(e){e&&F.error(e),t.reject(e)})},function(e){e&&F.error(e),t.reject(e)}),t.promise}function g(e){var r=T.defer();return b().then(function(n){var t=n.findIndex(function(r){return r.name==e});t<0?r.resolve():(n.splice(t,1),j(n).then(function(e){r.resolve()},function(e){e&&F.error(e),r.reject(e)}))},function(e){e&&F.error(e),r.reject(e)}),r.promise}function b(){var e=U.get();if(!e)return R.rejectPromise();var r=y(e.user_id);return _.existsSync(r)?R.readJson(r):R.resolvePromise([])}function j(e){var r=U.get();if(!r)return R.rejectPromise();var n=y(r.user_id);return _.existsSync(n)||_.ensureDirSync(I.dirname(n)),R.writeJson(n,e)}function y(e){return I.join(R.getAppDataPath(),"projects",x(e,1),"list.json")}function w(e){return I.join(R.getDocumentPath(),"projects",x(e))}function P(e,r){var n;switch(r){case"edu":case"ide":n=e;break;case"scratch2":n=e+".sb2";break;case"scratch3":n=e+".json"}return n}function x(e,r){return r=r||0,O(""+e,{algorithm:"md5"}).substring(8*r,8*(r+1))}function S(e,r,n){var t=T.defer();n=!0===n,F.debug("saveProject: isTemp:"+n);var o=function(e){var n=new Date;r.updated_at=n,r.project_name=I.basename(e),T.all([R.writeFile(I.join(e,I.basename(e)+".ino"),r.project_data.code),R.writeJson(I.join(e,"project.json"),r)]).then(function(n){t.resolve({path:e,updated_at:r.updated_at,project_name:r.project_name})},function(e){t.reject()})};if(e)o(e);else if(n){var i=I.join(app.getPath("temp"),"build","sketch"+(new Date).getTime());o(i)}else R.showSaveDialog().then(function(e){o(e)},function(e){t.reject()});return t.promise}function A(e,r){var n=T.defer();r=r||"project",F.debug("openProject "+e);var t=function(e){if("project"==r)R.readJson(I.join(e,"project.json")).then(function(r){n.resolve({path:e,projectInfo:r})},function(e){e&&F.error(e),n.reject(e)});else{var t=I.dirname(e),o=I.basename(e,I.extname(e));if(I.basename(t)!=o)return void setTimeout(function(r){n.reject({path:e,newPath:I.join(t,o,o+".ino"),status:"DIR_INVALID"})},10);R.readFile(e).then(function(e){n.resolve({path:t,code:e})},function(e){e&&F.error(e),n.reject(e)})}};if(e)t(e);else{var o="project"==r?null:[{name:"ino",extensions:["ino"]}],i="project"==r?["openDirectory"]:["openFile"];R.showOpenDialog(null,{properties:i,filters:o}).then(function(e){t(e)},function(e){e&&F.error(e),n.reject(e)})}return n.promise}var D,I=e("path"),_=e("fs-extra"),T=e("q"),O=e("hasha"),F=e("electron-log"),N=e("jszip"),R=e("./util"),U=e("./token");r.exports.setSyncUrl=t,r.exports.sync=s,r.exports.list=o,r.exports.upload=i,r.exports.remove=u,r.exports.download=a,r.exports.open=A,r.exports.save=S},{"./token":4,"./util":5,"electron-log":void 0,"fs-extra":void 0,hasha:void 0,jszip:void 0,path:void 0,q:void 0}],3:[function(e,r,n){function t(){var e=d.defer();return l.debug("listSerialPort"),p.list(function(r,n){if(r)return l.error(r),void e.reject(r);0!=n.length?e.resolve(n):e.reject()}),e.promise}function o(e,r,n){var t=d.defer();if(l.debug("openSerialPort: "+e+", options: "+JSON.stringify(r)),r.autoOpen=!1,"raw"==r.parser)r.parser=p.parsers.raw;else{var o=r.parser.replace("NL","\n").replace("CR","\r");r.parser=p.parsers.readline(o)}var i=new p(e,r);return i.open(function(e){if(e)return l.error(e),void t.reject(e);var r=++v.autoPortId;v.ports[r]=i,i.on("error",function(e){n&&n.onError&&n.onError(r,e)}).on("close",function(e){delete v.ports[r],n&&n.onClose&&n.onClose(r)}).on("data",function(e){n&&n.onData&&n.onData(r,e)}),i.flush(function(e){t.resolve(r)})}),t.promise}function i(e,r){var n=d.defer();l.debug("writeSerialPort: "+e+", "+r);var t=v.ports[e];return t?(t.write(r,function(e){if(e)return l.error(e),void n.reject(e);t.drain(function(e){n.resolve()})}),n.promise):(setTimeout(function(e){n.reject()},10),n.promise)}function a(e){var r=d.defer();l.debug("closeSerialPort, portId: "+e);var n=v.ports[e];return n?(n.close(function(e){r.resolve()}),r.promise):(setTimeout(function(e){r.reject()},10),r.promise)}function u(){l.debug("closeAllSerialPort");for(var e in v.ports)v.ports[e].close();v.ports={}}function s(e,r){var n=d.defer();l.debug("updateSerialPort, portId: "+e);var t=v.ports[e];return t?(t.update(r,function(e){n.resolve()}),n.promise):(setTimeout(function(e){n.reject()},10),n.promise)}function c(e,r){var n=d.defer();l.debug("flushSerialPort, portId: "+e);var t=v.ports[e];return t?(t.flush(function(e){n.resolve()}),n.promise):(setTimeout(function(e){n.reject()},10),n.promise)}function f(e){var r=d.defer(),n=new p(e,{baudRate:1200});return n.on("open",function(e){n.set({rts:!0,dtr:!1}),setTimeout(function(e){n.close(function(e){r.resolve()})},650)}).on("error",function(e){l.error(e),n.close(function(n){r.reject(e)})}),r.promise}e("path");var l=e("electron-log"),d=e("q"),p=e("serialport"),v={autoPortId:0,ports:{}};r.exports.listSerialPort=t,r.exports.openSerialPort=o,r.exports.writeSerialPort=i,r.exports.closeSerialPort=a,r.exports.closeAllSerialPort=u,r.exports.updateSerialPort=s,r.exports.flushSerialPort=c,r.exports.resetSerialPort=f},{"electron-log":void 0,path:void 0,q:void 0,serialport:void 0}],4:[function(e,r,n){function t(){return c}function o(e){c=e}function i(){c=null,v.removeFile(s(),!0)}function a(e){var r=d.defer(),n=l.randomBytes(128);return v.writeFile(s(),v.encrypt(JSON.stringify(e),n)).then(function(e){r.resolve(n.toString("hex"))},function(e){e&&m.error(e),r.reject(e)}),r.promise}function u(e){var r=d.defer(),n=s();return p.existsSync(n)?(v.readFile(n).then(function(n){var t=v.decrypt(n,Buffer.from(e,"hex"));try{r.resolve(JSON.parse(t))}catch(e){r.reject()}},function(e){e&&m.error(e),r.reject(e)}),r.promise):(setTimeout(function(e){r.reject()},10),r.promise)}function s(){return f.join(v.getAppDataPath(),"token")}var c,f=e("path"),l=e("crypto"),d=e("q"),p=e("fs-extra"),v=e("./util"),m=e("electron-log");r.exports.get=t,r.exports.set=o,r.exports.remove=i,r.exports.save=a,r.exports.load=u},{"./util":5,crypto:void 0,"electron-log":void 0,"fs-extra":void 0,path:void 0,q:void 0}],5:[function(e,r,n){function t(){return"x64"===process.arch||process.env.hasOwnProperty("PROCESSOR_ARCHITEW6432")}function o(){return K.windows()?"win":K.macOS()?"mac":k.arch().indexOf("arm")>=0?"arm":"linux"}function i(){return K.dev()?ee.version:z.getVersion()}function a(){var e={bit:t()?64:32,arch:process.arch,platform:o(),version:i(),name:z.getName()};return K.dev()?(e.ext=J.extname(z.getPath("exe")).replace(".",""),e.branch="beta",e.feature=""):(e.ext=ee.buildInfo.ext,e.branch=ee.buildInfo.branch,e.feature=ee.buildInfo.feature),e}function u(){return J.join(z.getPath("appData"),z.getName())}function s(){return K.windows()||K.dev()?J.resolve("."):J.resolve(z.getAppPath(),"..","..")}function c(){return J.join(z.getPath("documents"),z.getName())}function f(e,r){for(var n=/(\d+)\.(\d+)\.(\d+)/,t=n.exec(e),o=n.exec(r),i=[parseInt(t[1]),parseInt(t[2]),parseInt(t[3])],a=[parseInt(o[1]),parseInt(o[2]),parseInt(o[3])],u=0;u<=2;u++)if(i[u]!=a[u])return i[u]>a[u]?1:-1;return 0}function l(e){for(var r=arguments.length,n=Array(r>1?r-1:0),t=1;t<r;t++)n[t-1]=arguments[t];G.debug("postMessage: "+e+", "+n.join(", "));var o=L.getAllWindows();o&&o.length&&o[0].webContents.send(e,n)}function d(){var e=Q.defer(),r=te++;return ne[r]=e,{deferId:r,promise:e.promise}}function p(e,r){var n=ne[e];if(n){var t;"notify"==r?t=n.notify:(delete ne[e],t=r?n.resolve:n.reject);for(var o=arguments.length,i=Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];t.apply(this,i)}}function v(e){return K.windows()?e:e.replace(/"/g,"")}function m(e,r){var n,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),o=[];if(r=r||t.length,e)for(n=0;n<e;n++)o[n]=t[0|Math.random()*r];else{var i;for(o[8]=o[13]=o[18]=o[23]="-",o[14]="4",n=0;n<36;n++)o[n]||(i=0|16*Math.random(),o[n]=t[19==n?3&i|8:i])}return o.join("")}function h(e,r,n){n=n||"aes-128-cbc";var t=B.createCipher(n,r),o=t.update(e,"utf8","binary");return o+=t.final("binary"),o=new Buffer(o,"binary").toString("base64")}function g(e,r,n){n=n||"aes-128-cbc",e=new Buffer(e,"base64").toString("binary");var t=B.createDecipher(n,r),o=t.update(e,"binary","utf8");return o+=t.final("utf8")}function b(e,r){r=r||re;var n=new Buffer(e);return B.publicEncrypt({key:r,padding:B.constants.RSA_PKCS1_PADDING},n).toString("base64")}function j(e,r){var n=new Buffer(e,"base64");return B.privateDecrypt({key:r,padding:B.constants.RSA_PKCS1_PADDING},n).toString("utf8")}function y(e,r){return r=r||Q.defer(),setTimeout(function(n){r.resolve(e)},10),r.promise}function w(e,r){return r=r||Q.defer(),setTimeout(function(n){r.reject(e)},10),r.promise}function P(e){var r=Q.defer();G.debug("execFile: "+e);var n;return n=K.windows()?"start /WAIT "+e:""+e,x(n,null,!0).fin(function(e){r.resolve()}),r.promise}function x(e,r,n){var t=Q.defer();return r=r||{},n=n||!1,G.debug("execCommand:"+e+", options: "+JSON.stringify(r)+", useSudo: "+n),n?V.exec(e,{name:"kenrobot"},function(e,r,n){if(r=K.windows()?Y.decode(r||"","gbk"):r,n=K.windows()?Y.decode(n||"","gbk"):n,e)return G.error(e),r&&G.error(r),n&&G.error(n),void t.reject(n||r||e);K.dev()&&G.debug(r),t.resolve(r)}):q.exec(e,r,function(e,r,n){if(r=K.windows()?Y.decode(r||"","gbk"):r,n=K.windows()?Y.decode(n||"","gbk"):n,e)return G.error(e),r&&G.error(r),n&&G.error(n),void t.reject(n||r||e);K.dev()&&G.debug(r),t.resolve(r)}),t.promise}function S(e,r,n){var t=Q.defer(),o=q.spawn(e,r,n);return o.stdout.on("data",function(e){var r=K.windows()?Y.decode(e,"gbk"):e.toString();K.dev()&&G.debug(r),t.notify({type:"stdout",data:r})}),o.stderr.on("data",function(e){var r=K.windows()?Y.decode(e,"gbk"):e.toString();K.dev()&&G.debug(r),t.notify({type:"stderr",data:r})}),o.on("close",function(e){0==e?t.resolve():t.reject()}),t.promise}function A(e,r,n){if(n=!0===r||!1!==r&&n)return W.readFileSync(e,r);var t=Q.defer();return r=r||"utf8",W.readFile(e,r,function(e,r){if(e)return G.error(e),void t.reject(e);t.resolve(r)}),t.promise}function D(e,r,n){if(!n){var t=Q.defer();return W.outputFile(e,r,function(e){if(e)return G.error(e),void t.reject(e);t.resolve()}),t.promise}W.outputFileSync(e,r)}function I(e,r,n){var t=Q.defer();return n=n||{overwrite:!0},W.move(e,r,n,function(e){if(e)return G.error(e),void t.reject(e);t.resolve()}),t.promise}function _(e,r){if(!r){var n=Q.defer();return W.remove(e,function(e){if(e)return G.error(e),void n.reject(e);n.resolve()}),n.promise}W.removeSync(e)}function T(e,r){var n=Q.defer();return r=r||{},W.readJson(e,r,function(e,r){if(e)return G.error(e),void n.reject(e);n.resolve(r)}),n.promise}function O(e,r,n,t){if(!(t=!0===n||!1!==n&&t)){var o=Q.defer();return n=n||{},W.outputJson(e,r,n,function(e){if(e)return G.error(e),void o.reject(e);o.resolve()}),o.promise}W.outputJsonSync(e,r,n)}function F(e){var r=Q.defer();return G.debug("searchFiles: "+e),X(e,{},function(e,n){return e?(G.error(e),void r.reject(e)):r.resolve(n)}),r.promise}function N(e,r,n){var t=Q.defer(),o=/([\d]+)% \d+ - .*\r?/g;return G.debug("unzip: "+e+" => "+r),n?S('"'+Z+'"',["x",'"'+e+'"',"-bsp1","-y",'-o"'+r+'"'],{shell:!0}).then(function(e){t.resolve(e)},function(e){e&&G.error(e),t.reject(e)},function(e){if(o.lastIndex=0,o.test(e.data)){var r,n=o.exec(e.data);do{r=n,n=o.exec(e.data)}while(n);t.notify(parseInt(r[1]))}}):x('"'+Z+'" x "'+e+'" -y -o"'+r+'"').then(function(e){t.resolve()},function(e){e&&G.error(e),t.reject(e)}),t.promise}function R(e,r,n,t){var o=Q.defer();return r=r instanceof Array?r:[r],t=t||"7z",x('cd "'+e+'" && "'+Z+'" a -t'+t+" -r "+n+" "+r.join(" ")).then(function(e){o.resolve()},function(e){e&&G.error(e),o.reject(e)}),o.promise}function U(e,r){var n=Q.defer();return e=e||L.getAllWindows()[0],r=r||{},r.title="打开",r.defaultPath=z.getPath("documents"),r.buttonLabel="打开",G.debug("showOpenDialog: options: "+JSON.stringify(r)),H.showOpenDialog(e,r,function(e){e?n.resolve(e[0]):n.reject()}),n.promise}function C(e,r){var n=Q.defer();return e=e||L.getAllWindows()[0],r=r||{},r.title="保存",r.defaultPath=z.getPath("documents"),r.buttonLabel="保存",G.debug("showSaveDialog: options: "+JSON.stringify(r)),H.showSaveDialog(e,r,function(e){e?n.resolve(e):n.reject()}),n.promise}function E(e,r,n){var t=Q.defer();if(r=r||{},n=!1!==n,r.method=r.method||"GET",n&&r.data){r.body=JSON.stringify(r.data);var o=r.headers||(r.headers={});o["Content-Type"]="application/json",o.Accept="application/json",delete r.data}return $(e,r).then(function(e){if(e.ok)return n?e.json():e;var r=new Error(e.statusText);throw r.status=e.status,r}).then(function(e){t.resolve(e)}).catch(function(e){e&&G.error(e),t.reject(e)}),t.promise}var k=e("os"),q=e("child_process"),J=e("path"),B=e("crypto"),M=e("electron"),z=M.app,H=M.dialog,L=M.BrowserWindow,G=e("electron-log"),K=e("electron-is"),Q=e("q"),W=e("fs-extra"),X=e("glob"),V=e("sudo-prompt"),Y=e("iconv-lite"),Z=e("7zip-bin").path7za.replace("app.asar","app.asar.unpacked"),$=e("node-fetch"),ee=e("../package"),re="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC7Jat1/19NDxOObrFpW8USTia6\nuHt34Sac1Arm6F2QUzsdUEUmvGyLIOIGcdb+F6pTdx4ftY+wZi7Aomp4k3vNqXmX\nT0mE0vpQlCmsPUcMHXuUi93XTGPxLXIv9NXxCJZXSYI0JeyuhT9/ithrYlbMlyNc\nwKB/BwSpp+Py2MTT2wIDAQAB\n-----END PUBLIC KEY-----\n";K.dev()&&z.setName(ee.name);var ne={},te=0;r.exports.isX64=t,r.exports.getPlatform=o,r.exports.getVersion=i,r.exports.getAppInfo=a,r.exports.getAppDataPath=u,r.exports.getResourcePath=s,r.exports.getDocumentPath=c,r.exports.versionCompare=f,r.exports.postMessage=l,r.exports.getDefer=d,r.exports.callDefer=p,r.exports.handleQuotes=v,r.exports.uuid=m,r.exports.encrypt=h,r.exports.decrypt=g,r.exports.rsa_encrypt=b,r.exports.rsa_decrypt=j,r.exports.resolvePromise=y,r.exports.rejectPromise=w,r.exports.execFile=P,r.exports.execCommand=x,r.exports.spawnCommand=S,r.exports.readFile=A,r.exports.writeFile=D,r.exports.moveFile=I,r.exports.removeFile=_,r.exports.readJson=T,r.exports.writeJson=O,r.exports.searchFiles=F,r.exports.unzip=N,r.exports.zip=R,r.exports.showOpenDialog=U,r.exports.showSaveDialog=C,r.exports.request=E},{"../package":void 0,"7zip-bin":void 0,child_process:void 0,crypto:void 0,electron:void 0,"electron-is":void 0,"electron-log":void 0,"fs-extra":void 0,glob:void 0,"iconv-lite":void 0,"node-fetch":void 0,os:void 0,path:void 0,q:void 0,"sudo-prompt":void 0}]},{},[1]);